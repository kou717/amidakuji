<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Á•û„ÅÇ„Åø„Å† V147-21 (Ê©üËÉΩÂº∑ÂåñÁâà)</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* =========================================
           „Éô„Éº„ÇπË®≠ÂÆö
           ========================================= */
        :root {
            --anim-duration: 1.2s;
            --squeeze-ratio: 0.65;
            --line-color: #cccccc;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            text-align: center;
            background-color: #f0f8ff;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            overflow-y: scroll;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            user-select: none;
        }

        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„ÇíÈÄèÊòé„Å´ÔºàÈ†òÂüü„ÅØÁ¢∫‰øùÔºâ */
        body::-webkit-scrollbar {
            width: 8px;
        }
        body::-webkit-scrollbar-track {
            background: transparent;
        }
        body::-webkit-scrollbar-thumb {
            background: transparent;
            border-radius: 4px;
            transition: background 0.3s;
        }
        body:hover::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
        }
        body::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.4);
        }

        .screen {
            display: none;
            width: 100%;
            min-height: 100vh;
            box-sizing: border-box;
            padding: 20px;
            padding-bottom: 100px;
            animation: fadeIn 0.4s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* „Çπ„Éó„É©„ÉÉ„Ç∑„É• */
        #splashScreen {
            display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; transition: opacity 0.5s ease;
            overflow: hidden;
        }
        #splashScreen::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 50% 50%, rgba(255,215,0,0.1) 0%, transparent 50%);
            animation: divineGlow 3s ease-in-out infinite;
        }
        @keyframes divineGlow {
            0%, 100% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
        }
        .splash-logo {
            display: flex; flex-direction: column; align-items: center; gap: 20px;
            animation: logoAppear 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            z-index: 1;
        }
        @keyframes logoAppear {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .logo-amida {
            position: relative;
            width: 120px;
            height: 140px;
        }
        .logo-amida::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 180px;
            height: 180px;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(255,215,0,0.3) 0%, transparent 70%);
            border-radius: 50%;
            animation: haloGlow 2s ease-in-out infinite;
        }
        @keyframes haloGlow {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.6; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
        }
        /* „ÅÇ„Åø„Å†„Åè„Åò„ÅÆÁ∏¶Á∑ö */
        .logo-line-v {
            position: absolute;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #ffd700 0%, #ffed4a 50%, #ffd700 100%);
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(255,215,0,0.6);
        }
        .logo-line-v:nth-child(1) { left: 10px; }
        .logo-line-v:nth-child(2) { left: 38px; }
        .logo-line-v:nth-child(3) { left: 66px; }
        .logo-line-v:nth-child(4) { left: 94px; }
        /* „ÅÇ„Åø„Å†„Åè„Åò„ÅÆÊ®™Á∑ö */
        .logo-line-h {
            position: absolute;
            height: 4px;
            background: linear-gradient(90deg, #ffd700, #fff5cc, #ffd700);
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(255,215,0,0.5);
            animation: lineGlow 1.5s ease-in-out infinite;
        }
        .logo-line-h:nth-child(5) { top: 25px; left: 10px; width: 32px; animation-delay: 0s; }
        .logo-line-h:nth-child(6) { top: 50px; left: 38px; width: 32px; animation-delay: 0.2s; }
        .logo-line-h:nth-child(7) { top: 75px; left: 66px; width: 32px; animation-delay: 0.4s; }
        .logo-line-h:nth-child(8) { top: 100px; left: 10px; width: 32px; animation-delay: 0.6s; }
        .logo-line-h:nth-child(9) { top: 55px; left: 10px; width: 32px; animation-delay: 0.3s; }
        .logo-line-h:nth-child(10) { top: 85px; left: 38px; width: 32px; animation-delay: 0.5s; }
        @keyframes lineGlow {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; box-shadow: 0 0 15px rgba(255,215,0,0.8); }
        }
        /* Á•ûÂÖâ„Éë„Éº„ÉÜ„Ç£„ÇØ„É´ */
        .logo-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #ffd700;
            border-radius: 50%;
            box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700;
        }
        .logo-particle:nth-child(11) { top: -10px; left: 20px; animation: floatParticle 2s ease-in-out infinite; }
        .logo-particle:nth-child(12) { top: -5px; left: 60px; animation: floatParticle 2s ease-in-out infinite 0.3s; }
        .logo-particle:nth-child(13) { top: -15px; left: 90px; animation: floatParticle 2s ease-in-out infinite 0.6s; }
        @keyframes floatParticle {
            0%, 100% { transform: translateY(0); opacity: 1; }
            50% { transform: translateY(-10px); opacity: 0.5; }
        }
        .logo-title {
            font-size: 2.2rem;
            font-weight: 900;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255,215,0,0.5), 0 2px 4px rgba(0,0,0,0.3);
            letter-spacing: 0.3em;
            font-family: 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.85rem;
            color: rgba(255,215,0,0.7);
            letter-spacing: 0.2em;
            margin-top: -10px;
        }

        /* „É°„Éã„É•„Éº */
        #menuScreen { flex-direction: column; justify-content: center; align-items: center; gap: 25px; padding-top: 70px; }
        .menu-card {
            background: white; width: 85%; padding: 30px 25px; border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            position: relative;
            overflow: hidden;
        }
        .menu-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            border-radius: 24px 24px 0 0;
        }
        .menu-card.normal-card::before {
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        .menu-card.race-card::before {
            background: linear-gradient(90deg, #f093fb, #f5576c);
        }
        .menu-card:active { transform: scale(0.97); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* „É°„Éã„É•„Éº„Ç¢„Ç§„Ç≥„É≥ - „Åµ„Å§„ÅÜ„ÅÆ„ÅÇ„Åø„Å† */
        .menu-icon-wrapper {
            width: 90px;
            height: 90px;
            margin: 0 auto 15px;
            position: relative;
        }
        .amida-icon {
            width: 100%;
            height: 100%;
            position: relative;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
            border-radius: 20px;
            overflow: hidden;
        }
        .amida-icon::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60px;
            height: 60px;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(102,126,234,0.2) 0%, transparent 70%);
        }
        .amida-v-line {
            position: absolute;
            width: 3px;
            height: 60px;
            top: 15px;
            background: linear-gradient(180deg, #667eea, #764ba2);
            border-radius: 2px;
        }
        .amida-v-line:nth-child(1) { left: 20px; }
        .amida-v-line:nth-child(2) { left: 43px; }
        .amida-v-line:nth-child(3) { left: 66px; }
        .amida-h-line {
            position: absolute;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
        }
        .amida-h-line:nth-child(4) { top: 28px; left: 20px; width: 26px; }
        .amida-h-line:nth-child(5) { top: 45px; left: 43px; width: 26px; }
        .amida-h-line:nth-child(6) { top: 58px; left: 20px; width: 26px; }
        .amida-pointer {
            position: absolute;
            top: 8px;
            left: 40px;
            width: 10px;
            height: 10px;
            background: #667eea;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(102,126,234,0.5);
            animation: pointerBounce 1.5s ease-in-out infinite;
        }
        @keyframes pointerBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(3px); }
        }

        /* „É°„Éã„É•„Éº„Ç¢„Ç§„Ç≥„É≥ - ÂãïÁâ©„É¨„Éº„Çπ */
        .race-icon {
            width: 100%;
            height: 100%;
            position: relative;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe8ec 100%);
            border-radius: 20px;
            overflow: hidden;
        }
        .race-track {
            position: absolute;
            bottom: 12px;
            left: 10px;
            right: 10px;
            height: 8px;
            background: linear-gradient(90deg, #f5576c, #f093fb);
            border-radius: 4px;
        }
        .race-track::before {
            content: '';
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 0;
            right: 0;
            height: 2px;
            background: repeating-linear-gradient(90deg, white 0px, white 6px, transparent 6px, transparent 12px);
        }
        .race-animal {
            position: absolute;
            font-size: 0;
            animation: raceRun 2s ease-in-out infinite;
        }
        .race-animal::before {
            font-size: 22px;
        }
        .race-animal.rabbit { bottom: 22px; left: 50px; animation-delay: 0s; }
        .race-animal.rabbit::before { content: 'üê∞'; }
        .race-animal.cat { bottom: 22px; left: 25px; animation-delay: 0.3s; }
        .race-animal.cat::before { content: 'üê±'; }
        .race-animal.dog { bottom: 22px; left: 60px; animation-delay: 0.6s; }
        .race-animal.dog::before { content: 'üê∂'; }
        .race-flag {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
        }
        .race-flag::before { content: 'üèÅ'; }
        @keyframes raceRun {
            0%, 100% { transform: translateX(0) scaleX(1); }
            25% { transform: translateX(3px) scaleX(0.95); }
            50% { transform: translateX(0) scaleX(1); }
            75% { transform: translateX(-3px) scaleX(0.95); }
        }
        .finish-sparkle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #f5576c;
            border-radius: 50%;
            animation: sparkle 1.5s ease-in-out infinite;
        }
        .finish-sparkle:nth-child(1) { top: 20px; right: 40px; animation-delay: 0s; }
        .finish-sparkle:nth-child(2) { top: 35px; right: 45px; animation-delay: 0.3s; }
        .finish-sparkle:nth-child(3) { top: 25px; right: 55px; animation-delay: 0.6s; }
        @keyframes sparkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.3); }
        }

        /* Ë®≠ÂÆöÁîªÈù¢ */
        #setupScreen { background: #f9f9f9; padding-top: 70px; }

        /* =========================================
           ‰∫∫Êï∞ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ (3DÂõûËª¢„Ç´„É´„Éº„Çª„É´)
           ========================================= */
        #playerSelectOverlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #playerSelectOverlay.open {
            opacity: 1;
            visibility: visible;
        }
        .player-select-card {
            background: white;
            width: 90%;
            max-width: 360px;
            border-radius: 28px;
            padding: 35px 25px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #playerSelectOverlay.open .player-select-card {
            transform: scale(1) translateY(0);
        }
        .player-select-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }
        .player-select-subtitle {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 30px;
            text-align: center;
        }
        .carousel-container {
            position: relative;
            height: 180px;
            perspective: 1000px;
            margin-bottom: 30px;
        }
        .carousel-track {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .carousel-item {
            position: absolute;
            width: 100px;
            height: 100px;
            left: 50%;
            top: 50%;
            margin-left: -50px;
            margin-top: -50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
            border-radius: 20px;
            backface-visibility: hidden;
            transition: opacity 0.3s, box-shadow 0.3s;
        }
        .carousel-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 10px 30px rgba(102,126,234,0.4);
        }
        .carousel-item .number {
            font-size: 2.8rem;
            font-weight: 900;
            color: #667eea;
            line-height: 1;
        }
        .carousel-item.active .number {
            color: white;
        }
        .carousel-item .label {
            font-size: 0.85rem;
            color: #888;
            margin-top: 5px;
        }
        .carousel-item.active .label {
            color: rgba(255,255,255,0.9);
        }
        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            font-size: 1.5rem;
            color: #667eea;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .carousel-nav:active {
            transform: translateY(-50%) scale(0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .carousel-nav.prev { left: 5px; }
        .carousel-nav.next { right: 5px; }
        .carousel-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 25px;
        }
        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ddd;
            transition: background 0.3s, transform 0.3s;
        }
        .carousel-dot.active {
            background: #667eea;
            transform: scale(1.3);
        }
        .player-select-btn {
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            border: none;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(245,87,108,0.3);
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .player-select-btn:active {
            transform: scale(0.98);
            box-shadow: 0 4px 15px rgba(245,87,108,0.3);
        }
        .player-select-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: #f0f0f0;
            font-size: 1.2rem;
            color: #888;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .player-select-close:active { background: #e0e0e0; }

        /* =========================================
           ÂãïÁâ©„É¨„Éº„ÇπÂ∞ÇÁî®ÁîªÈù¢ÔºàÈÅãÂãï‰ºö„Éá„Ç∂„Ç§„É≥Ôºâ
           ========================================= */
        #raceSetupScreen {
            background: linear-gradient(180deg, #87CEEB 0%, #98FB98 50%, #90EE90 100%);
            padding-top: 70px;
            min-height: 100vh;
            position: relative;
        }
        #raceSetupScreen::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px;
            background: linear-gradient(180deg, transparent 0%, rgba(139,69,19,0.3) 100%);
            pointer-events: none;
        }
        /* ÈÅãÂãïÂ†¥„ÅÆ„Éà„É©„ÉÉ„ÇØÊ®°Êßò */
        .race-ground-pattern {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            height: 8px;
            background: repeating-linear-gradient(90deg, #fff 0px, #fff 20px, #e74c3c 20px, #e74c3c 40px);
            border-radius: 4px;
            opacity: 0.6;
        }

        .race-setup-content {
            padding: 20px;
            padding-bottom: 180px;
        }

        .race-section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            background: rgba(255,255,255,0.8);
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .race-section-title .icon { font-size: 1.4rem; }

        /* „Ç≠„É£„É©„ÇØ„Çø„ÉºËøΩÂä†„Éú„Çø„É≥ */
        .add-character-btn {
            width: 100%;
            padding: 20px;
            border: 3px dashed #e74c3c;
            border-radius: 16px;
            background: rgba(255,255,255,0.9);
            font-size: 1.1rem;
            font-weight: bold;
            color: #e74c3c;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            transition: transform 0.15s, background 0.15s;
        }
        .add-character-btn:active {
            transform: scale(0.98);
            background: rgba(231,76,60,0.1);
        }
        .add-character-btn .plus-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e74c3c;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        /* „Ç≠„É£„É©„ÇØ„Çø„Éº„É™„Çπ„Éà */
        .character-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .character-item {
            display: flex;
            align-items: center;
            background: white;
            padding: 12px;
            border-radius: 16px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }
        .character-item.selected {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe8ec 100%);
            border: 2px solid #e74c3c;
            box-shadow: 0 5px 15px rgba(231,76,60,0.2);
        }
        .character-item.selected::after {
            content: '‚úì';
            position: absolute;
            top: 8px;
            right: 12px;
            width: 24px;
            height: 24px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .character-item.swiping {
            transition: none;
        }
        .character-item .delete-bg {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 80px;
            background: #e74c3c;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transform: translateX(100%);
        }

        .character-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .character-info {
            flex: 1;
            min-width: 0;
        }
        .character-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .character-animal {
            font-size: 0.85rem;
            color: #888;
        }

        /* Á∑®ÈõÜ„ÉªÂâäÈô§„Éú„Çø„É≥ */
        .char-edit-btn, .char-delete-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: #f0f0f0;
            font-size: 1rem;
            cursor: pointer;
            margin-left: 5px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .char-edit-btn:active, .char-delete-btn:active {
            background: #ddd;
        }
        .char-delete-btn {
            background: #ffe5e5;
        }
        .char-delete-btn:active {
            background: #ffcccc;
        }

        /* ‰∏ãÈÉ®Âõ∫ÂÆö„Ç®„É™„Ç¢ */
        .race-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 15px 20px;
            padding-bottom: max(15px, env(safe-area-inset-bottom));
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .race-bottom-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .participant-count-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 70px;
        }
        .participant-label {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 4px;
        }
        .participant-count {
            width: 50px;
            height: 50px;
            border: 3px solid #e74c3c;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 900;
            color: #e74c3c;
            background: white;
        }

        .race-next-btn {
            flex: 1;
            padding: 16px;
            border-radius: 16px;
            border: none;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(231,76,60,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.15s;
        }
        .race-next-btn:active {
            transform: scale(0.98);
        }
        .race-next-btn:disabled {
            background: #ccc;
            box-shadow: none;
        }

        /* „Ç≠„É£„É©„ÇØ„Çø„ÉºËøΩÂä†„É¢„Éº„ÉÄ„É´ */
        #characterModal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 2000;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #characterModal.open {
            opacity: 1;
            visibility: visible;
        }
        .character-modal-card {
            background: white;
            width: 100%;
            max-width: 500px;
            border-radius: 24px 24px 0 0;
            padding: 25px;
            padding-bottom: max(25px, env(safe-area-inset-bottom));
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #characterModal.open .character-modal-card {
            transform: translateY(0);
        }
        .character-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .character-modal-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }
        .character-modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: #f0f0f0;
            font-size: 1.2rem;
            color: #888;
            cursor: pointer;
        }

        /* ÂãïÁâ©„Ç¢„Ç§„Ç≥„É≥ÈÅ∏Êäû */
        .animal-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .animal-option {
            aspect-ratio: 1;
            border-radius: 16px;
            border: 3px solid #eee;
            background: #f9f9f9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: transform 0.15s, border-color 0.15s;
        }
        .animal-option:active {
            transform: scale(0.95);
        }
        .animal-option.selected {
            border-color: #e74c3c;
            background: #fff5f5;
        }
        .animal-option.used {
            opacity: 0.3;
            pointer-events: none;
        }

        /* ÂêçÂâçÂÖ•Âäõ */
        .name-input-area {
            margin-bottom: 20px;
        }
        .name-input-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }
        .name-input-row {
            display: flex;
            gap: 10px;
        }
        .name-input {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid #eee;
            border-radius: 12px;
            font-size: 1.1rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .name-input:focus {
            border-color: #e74c3c;
        }
        .random-name-btn {
            padding: 14px 20px;
            border-radius: 12px;
            border: none;
            background: #f0f0f0;
            font-size: 0.9rem;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            white-space: nowrap;
        }
        .random-name-btn:active {
            background: #e0e0e0;
        }

        /* „É¢„Éº„ÉÄ„É´„Éú„Çø„É≥ */
        .character-modal-buttons {
            display: flex;
            gap: 10px;
        }
        .modal-cancel-btn {
            flex: 1;
            padding: 16px;
            border-radius: 12px;
            border: 2px solid #ddd;
            background: white;
            font-size: 1rem;
            font-weight: bold;
            color: #666;
            cursor: pointer;
        }
        .modal-confirm-btn {
            flex: 2;
            padding: 16px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            font-size: 1rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
        }
        .modal-confirm-btn:disabled {
            background: #ccc;
        }

        /* „Ç¥„Éº„É´ÈÅ∏ÊäûËÇ¢ÁîªÈù¢ÔºàÈÅãÂãï‰ºö„Éê„Éº„Ç∏„Éß„É≥Ôºâ */
        #raceGoalScreen {
            background: linear-gradient(180deg, #87CEEB 0%, #98FB98 50%, #90EE90 100%);
            padding-top: 70px;
            min-height: 100vh;
        }
        .race-goal-content {
            padding: 20px;
            padding-bottom: 120px;
        }
        .race-goal-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .race-goal-item {
            display: flex;
            align-items: center;
            background: white;
            padding: 5px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        .race-goal-index {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .race-goal-input {
            flex: 1;
            border: none;
            font-size: 1.1rem;
            padding: 12px;
            outline: none;
            background: transparent;
        }
        .race-add-goal-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(231,76,60,0.3);
            cursor: pointer;
            margin: 0 auto 20px;
        }

        /* „Çπ„Çø„Éº„Éà„É©„Ç§„É≥ÈÖçÁΩÆÁîªÈù¢ */
        #raceStartScreen {
            background: linear-gradient(180deg, #87CEEB 0%, #F4A460 70%, #DEB887 100%);
            padding-top: 70px;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }
        .start-instruction {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.9);
            margin: 10px 20px;
            border-radius: 12px;
            font-weight: bold;
            color: #333;
        }
        .start-line-area {
            position: relative;
            margin: 20px;
            padding: 20px 0;
        }
        .start-line {
            height: 60px;
            background: white;
            border: 3px solid #e74c3c;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            position: relative;
        }
        .start-line.occupied {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe8ec 100%);
        }
        .start-line-label {
            position: absolute;
            left: 10px;
            font-size: 0.8rem;
            color: #888;
        }
        .start-line .character-avatar {
            margin-right: 10px;
        }
        .start-line .character-name {
            font-size: 1rem;
        }

        .waiting-characters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            padding: 20px;
            background: rgba(255,255,255,0.8);
            border-radius: 16px;
            margin: 20px;
        }
        .waiting-character {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: grab;
            touch-action: none;
        }
        .waiting-character:active {
            cursor: grabbing;
        }
        .waiting-character .character-avatar {
            width: 45px;
            height: 45px;
            font-size: 1.5rem;
            margin: 0 0 5px 0;
        }
        .waiting-character .character-name {
            font-size: 0.8rem;
        }

        .race-start-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            padding: 18px;
            border-radius: 16px;
            border: none;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(46,204,113,0.4);
        }
        .race-start-btn:disabled {
            background: #ccc;
            box-shadow: none;
        }

        /* „É¨„Éº„ÇπÈñãÂßãÊºîÂá∫ */
        .race-countdown-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
        }
        .race-countdown-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .countdown-text {
            font-size: 4rem;
            font-weight: 900;
            color: white;
            text-shadow: 0 4px 20px rgba(0,0,0,0.5);
            animation: countdownPop 0.5s ease-out;
        }
        @keyframes countdownPop {
            0% { transform: scale(2); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* =========================================
           „Ç∞„É≠„Éº„Éê„É´„Éò„ÉÉ„ÉÄ„Éº
           ========================================= */
        #globalHeader {
            position: fixed; top: 0; left: 0; width: 100%; height: 55px;
            background: rgba(255, 255, 255, 0.98); box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000; display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; box-sizing: border-box;
        }

        .header-left {
            display: flex; align-items: center; gap: 10px;
        }

        .menu-icon-btn {
            width: 40px; height: 40px; border: none; background: transparent;
            cursor: pointer; display: flex; flex-direction: column; justify-content: center;
            align-items: center; gap: 5px; padding: 8px; border-radius: 8px;
        }
        .menu-icon-btn:active { background: #f0f0f0; }
        .menu-icon-btn span {
            display: block; width: 22px; height: 2px; background: #333; border-radius: 2px;
        }

        .back-icon-btn {
            width: 40px; height: 40px; border: none; background: #f0f0f0;
            cursor: pointer; border-radius: 50%; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
        }
        .back-icon-btn:active { background: #ddd; }
        .back-icon-btn.hidden { visibility: hidden; }

        .header-title {
            font-size: 1.1rem; font-weight: bold; color: #333;
        }

        .header-right {
            display: flex; align-items: center; gap: 10px;
        }

        .header-action-btn {
            padding: 8px 12px; border-radius: 20px; background: #f0f0f0;
            border: none; font-size: 0.9rem; font-weight: bold; color: #555; cursor: pointer;
        }
        .header-action-btn:active { background: #ddd; }
        .header-action-btn.hidden { display: none; }

        /* „Çµ„Ç§„Éâ„É°„Éã„É•„Éº */
        #menuOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1500; opacity: 0;
            visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        #menuOverlay.open { opacity: 1; visibility: visible; }

        #sideMenu {
            position: fixed; top: 0; left: -280px; width: 280px; height: 100%;
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            z-index: 1600; transition: left 0.3s ease;
            box-shadow: 2px 0 30px rgba(0,0,0,0.1), inset 0 0 0 1px rgba(255,255,255,0.4);
            padding: 20px 0;
            border-right: 1px solid rgba(255,255,255,0.5);
        }
        #sideMenu.open { left: 0; }

        .side-menu-header {
            padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.3); margin-bottom: 10px;
        }
        .side-menu-header h2 { margin: 0; font-size: 1.3rem; color: #222; text-shadow: 0 1px 2px rgba(255,255,255,0.5); }

        .side-menu-item {
            padding: 15px 25px; font-size: 1rem; color: #222; cursor: pointer;
            display: flex; align-items: center; gap: 15px;
            transition: background 0.2s;
        }
        .side-menu-item:active { background: rgba(255,255,255,0.3); }
        .side-menu-item span { font-size: 1.3rem; }

        #goalList { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .goal-item {
            display: flex; align-items: center; background: white; padding: 5px;
            border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            animation: slideIn 0.3s ease; position: relative; overflow: hidden; transition: background 0.2s;
        }
        .goal-index { width: 40px; font-weight: bold; color: #aaa; font-size: 0.9rem; }
        .goal-input { flex-grow: 1; border: none; font-size: 1.1rem; padding: 12px; outline: none; background: transparent; color: #333; }

        .add-btn-area { display: flex; justify-content: center; margin-bottom: 30px; }
        .add-btn {
            width: 60px; height: 60px; border-radius: 50%; background: #333; color: white; border: none;
            font-size: 2rem; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); cursor: pointer;
        }
        .add-btn:active { transform: scale(0.9); }
        .add-btn.disabled { background: #ccc; pointer-events: none; }

        .submit-btn {
            background: linear-gradient(135deg, #ff6b6b, #ff4757); color: white; border: none; width: 80%;
            padding: 15px; border-radius: 30px; font-size: 1.2rem; font-weight: bold;
            box-shadow: 0 4px 10px rgba(255, 71, 87, 0.4); cursor: pointer; position: fixed; bottom: 30px; left: 10%; z-index: 100;
        }

        /* =========================================
           „Ç≤„Éº„É†ÁîªÈù¢ & „Ç®„Éï„Çß„ÇØ„Éà„Éú„Çø„É≥
           ========================================= */
        #gameScreen { padding: 0; position: relative; padding-top: 60px; }

        /* ÊóßgameHeader„ÅØÂâäÈô§„ÄÅglobalHeader„Çí‰ΩøÁî® */

        #buttonLayer {
            position: absolute;
            top: 70px;
            left: 0;
            width: 100%;
            height: 60px;
            display: flex;
            pointer-events: none;
            z-index: 50;
        }

        .marble-btn {
            position: absolute;
            top: 0;
            width: var(--size);
            height: var(--size);
            border-radius: 50%;
            cursor: pointer;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            pointer-events: auto;

            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1), rgba(255,255,255,0.6) 50%, rgba(255,255,255,0.1));
            border: 2px solid var(--line-color);
            box-shadow: inset -2px -2px 5px rgba(0,0,0,0.1), inset 2px 2px 5px rgba(255,255,255,0.8), 0 5px 10px rgba(0,0,0,0.2);

            transform-origin: center;
            box-sizing: border-box;
            transition: opacity 0.2s;
        }
        .marble-btn:disabled { cursor: default; pointer-events: none; }

        .marble-btn::before {
            content: ''; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); width: 40%; height: 40%;
            border-radius: 50%; background: var(--btn-color);
            box-shadow: 0 0 5px rgba(0,0,0,0.3); z-index: -1; transform-origin: center;
        }

        .marble-btn::after {
            content: ''; position: absolute; top: 15%; left: 20%; width: 30%; height: 20%;
            border-radius: 50%; background: rgba(255,255,255,0.9);
            filter: blur(1px); transform: rotate(-45deg); pointer-events: none;
        }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes real-squeeze-parent {
            0% { transform: scale(1); }
            30% { transform: scale(0.9); }
            40% { transform: scale(0.92); }
            45% { transform: scale(0.90, 0.90) translate(1px, 1px); }
            50% { transform: scale(0.88, 0.92) translate(-1px, -1px); }
            55% { transform: scale(0.85, 0.85) translate(1px, -1px); }
            60% { transform: scale(0.82, 0.78) translate(-1px, 1px); }
            65% { transform: scale(0.78, 0.82) translate(1px, 1px); }
            70% { transform: scale(0.75, 0.75) translate(-1px, -1px); }
            80% { transform: scale(0.72, 0.68) translate(1px, -1px); }
            90% { transform: scale(0.68, 0.72) translate(-1px, 1px); }
            100% { transform: scale(var(--squeeze-ratio)); }
        }

        @keyframes real-counter-child {
            0% { transform: translate(-50%, -50%) scale(1); }
            30% { transform: translate(-50%, -50%) scale(1.11); }
            40% { transform: translate(-50%, -50%) scale(1.08); }
            45% { transform: translate(-50%, -50%) scale(1.11, 1.11); }
            50% { transform: translate(-50%, -50%) scale(1.13, 1.08); }
            55% { transform: translate(-50%, -50%) scale(1.17, 1.17); }
            60% { transform: translate(-50%, -50%) scale(1.21, 1.28); }
            65% { transform: translate(-50%, -50%) scale(1.28, 1.21); }
            70% { transform: translate(-50%, -50%) scale(1.33, 1.33); }
            80% { transform: translate(-50%, -50%) scale(1.38, 1.47); }
            90% { transform: translate(-50%, -50%) scale(1.47, 1.38); }
            100% { transform: translate(-50%, -50%) scale(1.53); }
        }

        .is-squeezing { animation: real-squeeze-parent var(--anim-duration) ease-in-out forwards; }
        .is-squeezing::before { animation: real-counter-child var(--anim-duration) ease-in-out forwards; }

        .is-popped { animation: burst 0.05s ease-out forwards; pointer-events: none; }
        .is-popped::before { opacity: 0; }

        @keyframes burst {
            from { transform: scale(var(--squeeze-ratio)); opacity: 1; }
            to { transform: scale(1.5); opacity: 0; }
        }

        .drop-ball {
            position: absolute; border-radius: 50%; background: var(--ball-color);
            z-index: 60; pointer-events: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #amidaCanvas { display: block; width: 100%; background: #fff; }

        #curtain {
            position: absolute; top: 50%; left: 0; width: 100%; height: 100px;
            background-color: #f0f8ff;
            background-image: radial-gradient(#d0eaff 20%, transparent 20%), radial-gradient(#d0eaff 20%, transparent 20%);
            background-size: 30px 30px; background-position: 0 0, 15px 15px;
            border-top: 6px wavy #87ceeb; border-bottom: 6px wavy #87ceeb;
            box-shadow: 0 0 15px rgba(135, 206, 235, 0.5);
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; color: #87ceeb; font-weight: 900; z-index: 10;
            pointer-events: none; opacity: 0.95; transition: opacity 0.5s ease;
        }

        #raceBtn {
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%);
            background: #ff9f43; color: white; border: 4px solid #fff;
            padding: 15px 50px; border-radius: 50px; font-size: 1.4rem; font-weight: bold;
            box-shadow: 0 10px 25px rgba(255, 159, 67, 0.4); z-index: 200; cursor: pointer;
        }
        #raceBtn:disabled {
            background: #ccc;
            box-shadow: none;
        }

        /* „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÖçÁΩÆUI */
        #charPlacementUI {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 300;
            display: none;
            max-width: 90%;
        }
        #charPlacementUI.show { display: block; }
        .placement-title {
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .placement-chars {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .placement-char {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            cursor: grab;
            touch-action: none;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .placement-char:active {
            cursor: grabbing;
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .placement-char.placed {
            opacity: 0.3;
            pointer-events: none;
        }
        .placement-char .char-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        .placement-char .char-name {
            font-size: 0.8rem;
            font-weight: bold;
            color: #333;
            max-width: 60px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* „Çπ„Çø„Éº„Éà‰ΩçÁΩÆ„ÅÆ„Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥ */
        .start-drop-zone {
            position: absolute;
            top: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 3px dashed #e74c3c;
            border-radius: 12px;
            background: rgba(255,255,255,0.9);
            transition: background 0.2s, border-color 0.2s, transform 0.2s;
            z-index: 50;
        }
        .start-drop-zone.highlight {
            background: rgba(231,76,60,0.2);
            border-color: #c0392b;
            transform: scale(1.05);
        }
        .start-drop-zone.occupied {
            border-style: solid;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe8ec 100%);
        }
        .start-drop-zone .zone-label {
            font-size: 0.7rem;
            color: #888;
        }
        .start-drop-zone .zone-char {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .start-drop-zone .zone-char .char-avatar {
            width: 40px;
            height: 40px;
            font-size: 1.4rem;
        }
        .start-drop-zone .zone-char .char-name {
            font-size: 0.7rem;
        }

        /* „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ„Ç¥„Éº„Çπ„Éà */
        .drag-ghost {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            opacity: 0.9;
            transform: scale(1.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        #fastForwardBtn {
            position: fixed; bottom: 40px; right: 20px;
            min-width: 70px; height: 40px; border-radius: 20px;
            background: rgba(255, 255, 255, 0.95); color: #555;
            border: 2px solid #ddd; font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); z-index: 200; cursor: pointer;
            display: none; align-items: center; justify-content: center;
            transition: transform 0.1s, background 0.1s;
            font-weight: bold;
            padding: 0 15px;
            letter-spacing: -2px;
        }
        #fastForwardBtn:active {
            transform: scale(0.95);
        }
        #fastForwardBtn.visible { display: flex; }
        #fastForwardBtn.speed-2x { background: #ffeaa7; border-color: #fdcb6e; color: #d35400; }
        #fastForwardBtn.speed-4x { background: #ff9f43; border-color: #e67e22; color: white; }

        /* ÁµêÊûú„É¢„Éº„ÉÄ„É´ */
        #resultModalOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        .result-card {
            background: white; width: 80%; max-width: 320px; padding: 30px 20px;
            border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            text-align: center; transform: scale(0.8);
            animation: popInModal 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            position: relative; overflow: hidden;
        }
        @keyframes popInModal { 100% { transform: scale(1); } }
        .result-title { font-size: 1.2rem; color: #888; margin-bottom: 10px; font-weight: bold; }
        .result-value { font-size: 2rem; color: #333; font-weight: 900; margin: 10px 0 30px; word-break: break-all;}
        .result-btn-area {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .result-btn {
            background: #333; color: white; border: none; padding: 12px 40px;
            font-size: 1rem; border-radius: 30px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .result-btn.main-btn {
            background: linear-gradient(135deg, #54a0ff, #5f27cd);
            padding: 12px 50px;
        }
        .result-btn-small {
            position: absolute;
            right: 0;
            background: #e0e0e0;
            color: #666;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .result-btn-small:active { transform: scale(0.9); background: #ccc; }
        .result-btn:active { transform: scale(0.95); }
        .result-timer-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 0 0 25px 25px;
            overflow: hidden;
        }
        .result-timer-progress {
            height: 100%;
            width: 100%;
            background: rgb(54, 160, 255);
            transform-origin: left;
            transition: transform 0.1s linear;
        }

        /* „Ç≥„Éî„ÉºÊàêÂäü„Éà„Éº„Çπ„Éà */
        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 12px 25px;
            border-radius: 25px; font-size: 0.9rem; z-index: 3000;
            animation: toastIn 0.3s ease, toastOut 0.3s ease 1.7s forwards;
        }
        @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } }
        @keyframes toastOut { to { opacity: 0; transform: translateX(-50%) translateY(-20px); } }

        /* =========================================
           ÁµêÊûú„Çø„É≥„ÇØÔºàÊ∞¥„Åå„Åü„Åæ„Çã„Ç®„Éï„Çß„ÇØ„ÉàÔºâ
           ========================================= */
        #tankLayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            pointer-events: none;
            z-index: 40;
        }

        .glass-container {
            --main-rgb: 150, 150, 150;
            --deep-rgb: 100, 100, 100;
            --stream-thickness: 6px;
            --stream-start-top: 0px;

            position: absolute;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            box-shadow:
                inset 0 0 10px rgba(255, 255, 255, 0.5),
                inset 0 0 3px rgba(255, 255, 255, 0.5),
                0 5px 15px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(2px);
            overflow: hidden;
        }

        .glass-container .label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #333;
            font-size: 12px;
            font-weight: bold;
            letter-spacing: 0.5px;
            pointer-events: none;
            transition: color 0.5s, text-shadow 0.5s;
            z-index: 20;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%;
            text-align: center;
        }

        .glass-container.active .label {
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .glass-container .water {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background: linear-gradient(to bottom, rgba(var(--main-rgb), 0.9) 0%, rgba(var(--deep-rgb), 1) 100%);
            transition: height 2s ease-in-out, opacity 0.8s ease-in;
            z-index: 1;
            box-shadow: 0 0 15px rgba(var(--main-rgb), 0.6);
            opacity: 0;
        }

        .glass-container.active .water {
            opacity: 1;
        }

        .glass-container .wave {
            position: absolute;
            top: -8px;
            left: 0;
            width: 100%;
            height: 20px;
            background: linear-gradient(
                90deg,
                rgba(var(--wave-rgb, 255, 255, 255), 0.0) 0%,
                rgba(var(--wave-rgb, 255, 255, 255), 0.5) 25%,
                rgba(var(--wave-rgb, 255, 255, 255), 0.0) 50%,
                rgba(var(--wave-rgb, 255, 255, 255), 0.5) 75%,
                rgba(var(--wave-rgb, 255, 255, 255), 0.0) 100%
            );
            animation: liquidWave 2s ease-in-out infinite;
            z-index: 2;
            border-radius: 0 0 50% 50%;
        }
        .glass-container .wave:nth-child(2) {
            top: -5px;
            height: 15px;
            background: linear-gradient(
                90deg,
                rgba(var(--wave-rgb, 255, 255, 255), 0.3) 0%,
                rgba(var(--wave-rgb, 255, 255, 255), 0.0) 30%,
                rgba(var(--wave-rgb, 255, 255, 255), 0.3) 60%,
                rgba(var(--wave-rgb, 255, 255, 255), 0.0) 100%
            );
            animation: liquidWave 2.5s ease-in-out infinite reverse;
            animation-delay: 0.3s;
        }

        @keyframes liquidWave {
            0%, 100% {
                transform: translateX(-5%) scaleY(1);
            }
            25% {
                transform: translateX(3%) scaleY(1.3);
            }
            50% {
                transform: translateX(5%) scaleY(1);
            }
            75% {
                transform: translateX(-3%) scaleY(1.2);
            }
        }

        .glass-container .stream {
            position: absolute;
            top: var(--stream-start-top);
            left: 50%;
            transform: translateX(-50%);
            width: var(--stream-thickness);
            height: 0;
            background: linear-gradient(to right, rgba(var(--main-rgb), 0.9), rgba(var(--deep-rgb), 0.9));
            border-radius: 0 0 var(--stream-thickness) var(--stream-thickness);
            opacity: 0;
            z-index: 5;
        }

        .glass-container.pouring .stream {
            animation: pourWater 2s forwards;
        }

        @keyframes pourWater {
            0% { height: 0; top: 0; opacity: 1; }
            15% { height: 100%; top: 0; opacity: 1; }
            85% { height: 100%; top: 0; opacity: 1; }
            100% { height: 0; top: 100%; opacity: 0; }
        }

        .glass-container .splash {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 6px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            opacity: 0;
            z-index: 6;
            filter: blur(1px);
        }
        .glass-container.pouring .splash {
            animation: splashEffect 1.5s 0.2s infinite;
        }
        @keyframes splashEffect {
            0%, 100% { transform: translateX(-50%) scale(0.5); opacity: 0; }
            50% { transform: translateX(-50%) scale(1.5); opacity: 0.7; }
        }

        .glass-container .bubble {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            bottom: 0;
            z-index: 3;
            animation: bubbleRise 1.5s ease-in forwards;
            pointer-events: none;
        }
        @keyframes bubbleRise {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translateY(-120%) scale(1.2); opacity: 0; }
        }

        /* Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ */
        #settingsOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2500; align-items: center; justify-content: center;
        }
        #settingsOverlay.open { display: flex; }

        /* „Éó„É™„Çª„ÉÉ„Éà„Éú„Çø„É≥ */
        .preset-scroll-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 5px 10px 10px 10px;
            margin: 0 -20px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .preset-scroll-container::-webkit-scrollbar {
            display: none;
        }
        .preset-scroll-container.sub-preset {
            padding-top: 0;
            margin-top: -2px;
        }
        .preset-btn {
            padding: 10px 16px; border-radius: 20px; background: #fff;
            border: 2px solid #e0e0e0; font-size: 0.85rem; cursor: pointer;
            transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            white-space: nowrap; flex-shrink: 0;
        }
        .preset-btn:active {
            transform: scale(0.95); background: #f0f0f0;
        }
        .preset-btn.genre-btn {
            background: #f8f8f8;
            font-weight: bold;
        }
        .preset-btn.genre-btn.active {
            background: #333;
            color: #fff;
            border-color: #333;
        }
        .preset-btn.sub-btn {
            background: #fff;
            border-color: #54a0ff;
            color: #54a0ff;
        }
        .preset-btn.sub-btn:active {
            background: #e8f4fd;
        }

        /* „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Éò„ÉÉ„ÉÄ„Éº */
        .setup-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 15px;
        }
        .setup-header h3 {
            flex: 1; text-align: center; margin: 0;
        }
        .setup-header-left {
            width: 70px; min-width: 70px;
        }
        .setup-header-right {
            width: 70px; min-width: 70px;
            display: flex; justify-content: flex-end;
        }
        .active-template-badge {
            display: none; flex-direction: column; align-items: center;
            padding: 6px 8px; border-radius: 10px;
            font-weight: bold; color: white;
            cursor: pointer;
            box-shadow: 0 3px 12px rgba(0,0,0,0.25);
            border: 2px solid rgba(255,255,255,0.3);
            max-width: 70px;
        }
        .active-template-badge.show { display: flex; }
        .active-template-badge-icon {
            font-size: 1.1rem; margin-bottom: 2px;
        }
        .active-template-badge-name {
            font-size: 0.65rem; line-height: 1.2;
            text-align: center; word-break: break-all;
        }
        .template-trigger-btn {
            width: 44px; height: 44px; border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none; font-size: 1.3rem; cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .template-trigger-btn:active {
            transform: scale(0.92);
        }
        .template-trigger-btn.active {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        /* „ÉÜ„É≥„Éó„É¨„Éº„Éà„Éë„Éç„É´ */
        /* „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁ∑®ÈõÜ„ÅÆ‰∏¶„Å≥Êõø„Åà */
        .te-sub-item, .te-genre-item {
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1),
                        box-shadow 0.25s ease,
                        background 0.15s ease;
        }
        .te-sub-item.dragging, .te-genre-item.dragging {
            background: #e3f2fd !important;
            box-shadow: 0 8px 25px rgba(0,0,0,0.25);
            transform: scale(1.03);
            z-index: 100;
            position: relative;
        }
        .te-sub-item.drag-over, .te-genre-item.drag-over {
            transform: translateY(8px);
        }
        .te-sub-item.drag-over-up, .te-genre-item.drag-over-up {
            transform: translateY(-8px);
        }
        .te-drag-hint {
            font-size: 0.75rem; color: #888; text-align: center;
            padding: 8px; background: #f8f9fa;
        }

        /* „Ç¢„Ç§„Ç≥„É≥„Éî„ÉÉ„Ç´„Éº */
        #iconPickerOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2500; align-items: center; justify-content: center;
        }
        #iconPickerOverlay.open { display: flex; }
        .icon-picker-card {
            background: white; width: 85%; max-width: 320px; padding: 20px;
            border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            max-height: 70vh; overflow-y: auto;
        }
        .icon-grid {
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;
            margin-bottom: 15px;
        }
        .icon-option {
            width: 44px; height: 44px; border-radius: 12px; border: 2px solid #e0e0e0;
            background: white; font-size: 1.5rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .icon-option:active, .icon-option.selected {
            border-color: #54a0ff; background: #e8f4fd; transform: scale(1.1);
        }

        /* „Ç¥„Éº„É´„Ç¢„Ç§„ÉÜ„É†„Å´„Ç¢„Ç§„Ç≥„É≥„Éú„Çø„É≥ËøΩÂä† */
        .goal-icon-btn {
            width: 36px; height: 36px; border-radius: 50%; border: 2px solid #e0e0e0;
            background: white; font-size: 1.2rem; cursor: pointer; margin-right: 5px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; flex-shrink: 0;
        }
        .goal-icon-btn:active { transform: scale(0.9); }
        .settings-card {
            background: white; width: 85%; max-width: 350px; padding: 25px 20px;
            border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        .settings-section { margin-bottom: 20px; }
        .settings-label { font-weight: bold; color: #333; margin-bottom: 12px; font-size: 0.95rem; }
        .settings-options { display: flex; flex-direction: column; gap: 10px; }
        .settings-option {
            display: flex; align-items: center; padding: 12px 15px;
            background: #f8f9fa; border-radius: 12px; cursor: pointer;
            border: 2px solid transparent; transition: all 0.2s;
        }
        .settings-option:has(input:checked) {
            background: #e8f4fd; border-color: #54a0ff;
        }
        .settings-option input { margin-right: 12px; transform: scale(1.2); }
        .option-content { display: flex; flex-direction: column; }
        .option-title { font-weight: bold; color: #333; font-size: 0.95rem; }
        .option-desc { color: #888; font-size: 0.8rem; margin-top: 2px; }
        .settings-close-btn {
            width: 100%; padding: 12px; background: #333; color: white;
            border: none; border-radius: 25px; font-size: 1rem; cursor: pointer;
            margin-top: 10px;
        }

        /* „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ */
        #templateEditorOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2600; align-items: center; justify-content: center;
        }
        #templateEditorOverlay.open { display: flex; }
        .template-editor-card {
            background: white; width: 92%; max-width: 400px; height: 85vh;
            border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .template-editor-header {
            display: flex; align-items: center; gap: 10px;
            padding: 15px 20px; border-bottom: 1px solid #eee; flex-shrink: 0;
        }
        .template-editor-header h3 { margin: 0; font-size: 1.1rem; flex: 1; text-align: center; }
        .te-edit-toggle-btn {
            padding: 6px 14px; border-radius: 16px;
            background: #f0f0f0; color: #333; border: none;
            font-size: 0.85rem; cursor: pointer; white-space: nowrap;
        }
        .te-edit-toggle-btn.active {
            background: #333; color: white;
        }
        .te-back-btn, .te-close-btn {
            width: 36px; height: 36px; border-radius: 50%; border: none;
            background: #f0f0f0; font-size: 1.2rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .te-back-btn.hidden { visibility: hidden; }
        .te-hint-area {
            padding: 10px 15px; background: #f8f9fa; border-bottom: 1px solid #eee;
            min-height: 50px; flex-shrink: 0;
        }
        .te-favorites-scroll {
            display: flex; gap: 8px; overflow-x: auto;
            padding-bottom: 4px; scrollbar-width: none;
        }
        .te-favorites-scroll::-webkit-scrollbar { display: none; }
        .te-fav-item {
            display: flex; align-items: center; gap: 6px;
            padding: 8px 12px; background: white;
            border-radius: 20px; border: 2px solid #ffd54f;
            font-size: 0.85rem; cursor: pointer;
            white-space: nowrap; flex-shrink: 0;
            transition: all 0.2s;
        }
        .te-fav-item:active { transform: scale(0.95); background: #fff9e6; }
        .te-fav-color { width: 6px; height: 18px; border-radius: 3px; }
        .te-no-fav { color: #999; font-size: 0.85rem; text-align: center; padding: 8px 0; }
        .template-editor-content {
            flex: 1; overflow-y: scroll; padding: 10px;
        }
        .template-editor-footer {
            padding: 15px; border-top: 1px solid #eee; flex-shrink: 0;
            display: none;
        }
        .template-editor-footer.show { display: block; }
        .te-reset-btn {
            width: 100%; padding: 12px; background: #f8f9fa; color: #666;
            border: 2px solid #e0e0e0; border-radius: 25px; font-size: 0.95rem; cursor: pointer;
        }

        /* „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥ÂΩ¢Âºè„ÅÆ„Ç∏„É£„É≥„É´ */
        .te-genre-item {
            margin-bottom: 8px; border-radius: 12px; overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .te-genre-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 16px; cursor: pointer; transition: all 0.2s;
            color: white; font-weight: bold;
        }
        .te-genre-header:active { opacity: 0.9; }
        .te-genre-icon { font-size: 1.2rem; margin-right: 8px; }
        .te-genre-title { font-size: 1rem; }
        .te-genre-arrow {
            font-size: 1.2rem; transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .te-genre-item.open .te-genre-arrow { transform: rotate(180deg); }
        .te-genre-body {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
        }
        .te-genre-item.open .te-genre-body { grid-template-rows: 1fr; }
        .te-genre-body-inner {
            overflow: hidden;
        }
        .te-genre-content {
            padding: 12px;
        }

        /* „Çµ„Éñ„Ç´„ÉÜ„Ç¥„É™„É™„Çπ„Éà */
        .te-sub-list { display: flex; flex-direction: column; gap: 6px; }
        .te-sub-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 14px; background: #f8f9fa; border-radius: 10px;
            cursor: pointer; transition: background 0.2s;
        }
        .te-sub-item:active { background: #e8e8e8; }
        .te-sub-name { font-size: 0.95rem; color: #333; }
        .te-sub-info { font-size: 0.8rem; color: #888; margin-left: 8px; }
        .te-sub-arrow { color: #aaa; }
        .te-sub-fav {
            font-size: 1.2rem; padding: 4px; cursor: pointer;
            transition: transform 0.2s;
        }
        .te-sub-fav:active { transform: scale(1.3); }

        /* „Ç∏„É£„É≥„É´Êìç‰Ωú„Éú„Çø„É≥ */
        .te-genre-actions {
            display: flex; gap: 8px; margin-top: 10px; padding-top: 10px;
            border-top: 1px dashed #e0e0e0;
        }
        .te-genre-action-btn {
            flex: 1; padding: 10px; border-radius: 8px; border: none;
            font-size: 0.85rem; cursor: pointer; transition: all 0.2s;
        }
        .te-genre-action-btn.edit { background: #e3f2fd; color: #1976d2; }
        .te-genre-action-btn.add { background: #e8f5e9; color: #388e3c; }
        .te-genre-action-btn:active { transform: scale(0.95); }

        /* Êñ∞Ë¶èËøΩÂä†„Éú„Çø„É≥ */
        .te-add-genre-btn {
            display: flex; align-items: center; justify-content: center;
            padding: 14px; background: #f0f0f0; border-radius: 12px;
            border: 2px dashed #ccc; color: #666; font-size: 0.95rem;
            cursor: pointer; margin-top: 8px;
        }
        .te-add-genre-btn:active { background: #e0e0e0; }

        /* „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁ¢∫Ë™ç„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó */
        .template-confirm-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 3000;
            display: flex; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box;
        }
        .template-confirm-card {
            background: white; border-radius: 20px; width: 100%; max-width: 340px;
            overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .template-confirm-header {
            padding: 20px; text-align: center;
        }
        .template-confirm-genre {
            color: white; font-size: 1.3rem; font-weight: bold;
        }
        .template-confirm-body {
            padding: 20px;
        }
        .template-confirm-label {
            font-size: 1.2rem; font-weight: bold; color: #333;
            margin-bottom: 12px; text-align: center;
        }
        .template-confirm-detail {
            font-size: 0.9rem; color: #666; line-height: 1.6;
            background: #f8f9fa; padding: 12px; border-radius: 10px;
            max-height: 120px; overflow-y: auto;
            margin-bottom: 15px;
        }
        .template-confirm-msg {
            font-size: 0.95rem; color: #333; text-align: center;
        }
        .template-confirm-footer {
            display: flex; gap: 10px; padding: 15px 20px 20px;
        }
        .template-confirm-cancel, .template-confirm-ok {
            flex: 1; padding: 14px; border-radius: 12px; border: none;
            font-size: 1rem; font-weight: bold; cursor: pointer;
        }
        .template-confirm-cancel {
            background: #f0f0f0; color: #666;
        }
        .template-confirm-ok {
            background: #333; color: white;
        }

        /* ÈÅ∏ÊäûËÇ¢Á∑®ÈõÜ */
        .te-choice-item {
            display: flex; align-items: center; gap: 8px;
            padding: 10px 12px; background: white; border: 1px solid #e0e0e0;
            border-radius: 10px; margin-bottom: 8px;
        }
        .te-choice-item input {
            flex: 1; border: none; font-size: 1rem; outline: none;
            background: transparent;
        }
        .te-choice-delete {
            width: 30px; height: 30px; border-radius: 50%; border: none;
            background: #ffebee; color: #e53935; font-size: 1rem; cursor: pointer;
        }
        .te-add-choice {
            width: 100%; padding: 12px; background: #e8f4fd; color: #54a0ff;
            border: 2px dashed #54a0ff; border-radius: 10px; font-size: 1rem;
            cursor: pointer; margin-top: 5px;
        }

        /* Á∑®ÈõÜÁî®ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ */
        .te-edit-section { margin-bottom: 20px; }
        .te-edit-label { font-size: 0.85rem; color: #666; margin-bottom: 8px; }
        .te-edit-input {
            width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0;
            border-radius: 12px; font-size: 1rem; box-sizing: border-box;
        }
        .te-edit-input:focus { border-color: #54a0ff; outline: none; }

        /* „Ç´„É©„Éº„Éî„ÉÉ„Ç´„Éº */
        .te-color-picker {
            display: flex; gap: 8px; flex-wrap: wrap;
        }
        .te-color-option {
            width: 40px; height: 40px; border-radius: 50%; border: 3px solid transparent;
            cursor: pointer; transition: all 0.2s;
        }
        .te-color-option:active { transform: scale(0.9); }
        .te-color-option.selected { border-color: #333; transform: scale(1.1); }

        .te-icon-picker {
            display: flex; gap: 8px; flex-wrap: wrap;
        }
        .te-icon-option {
            width: 44px; height: 44px; border-radius: 12px; border: 2px solid #e0e0e0;
            background: white; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
        }
        .te-icon-option:active { transform: scale(0.9); }
        .te-icon-option.selected { border-color: #333; background: #f0f0f0; transform: scale(1.1); }

        .te-type-selector { display: flex; gap: 8px; flex-wrap: wrap; }
        .te-type-btn {
            padding: 10px 15px; border-radius: 20px; border: 2px solid #e0e0e0;
            background: white; font-size: 0.9rem; cursor: pointer;
        }
        .te-type-btn.active { background: #333; color: white; border-color: #333; }

        .te-save-btn {
            width: 100%; padding: 14px; background: linear-gradient(135deg, #54a0ff, #5f27cd);
            color: white; border: none; border-radius: 25px; font-size: 1rem;
            font-weight: bold; cursor: pointer; margin-top: 15px;
        }
        .te-delete-btn {
            width: 100%; padding: 12px; background: white; color: #e53935;
            border: 2px solid #e53935; border-radius: 25px; font-size: 1rem;
            cursor: pointer; margin-top: 10px;
        }

        /* „Ç´„Çπ„Çø„É†Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞ */
        #confirmOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;
        }
        #confirmOverlay.open { display: flex; }
        .confirm-card {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            width: 85%; max-width: 320px; padding: 30px 25px;
            border-radius: 25px; box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            text-align: center;
            transform: scale(0.9); opacity: 0;
            animation: popInConfirm 0.25s ease forwards;
        }
        @keyframes popInConfirm {
            to { transform: scale(1); opacity: 1; }
        }
        .confirm-icon { font-size: 3rem; margin-bottom: 15px; }
        .confirm-message {
            font-size: 1rem; color: #333; line-height: 1.6;
            margin-bottom: 25px; white-space: pre-line;
        }
        .confirm-buttons { display: flex; gap: 12px; }
        .confirm-btn {
            flex: 1; padding: 14px 20px; border: none; border-radius: 30px;
            font-size: 1rem; font-weight: bold; cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .confirm-btn:active { transform: scale(0.95); }
        .confirm-cancel {
            background: #e9ecef; color: #666;
        }
        .confirm-ok {
            background: linear-gradient(135deg, #54a0ff 0%, #5f27cd 100%);
            color: white; box-shadow: 0 5px 20px rgba(84, 160, 255, 0.4);
        }

        /* „Ç≤„Éº„É†ÁîªÈù¢„ÅÆËÉåÊôØ */
        #gameScreen {
            background: linear-gradient(180deg, #f0f4f8 0%, #e8eef5 50%, #dfe6ed 100%);
            position: relative;
        }
        #gameScreen::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image:
                radial-gradient(circle at 20% 30%, rgba(84, 160, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(95, 39, 205, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        #amidaCanvas {
            position: relative;
            z-index: 1;
            background: transparent !important;
        }

        /* „Ç∑„É£„ÉÉ„Éï„É´„Ç®„Éï„Çß„ÇØ„Éà */
        @keyframes shuffleFlash {
            0% { opacity: 0; }
            20% { opacity: 0.8; }
            40% { opacity: 0.3; }
            60% { opacity: 0.5; }
            80% { opacity: 0.2; }
            100% { opacity: 0; }
        }
        @keyframes starBurst {
            0% { opacity: 0; transform: scale(0) rotate(0deg); }
            30% { opacity: 1; transform: scale(1.5) rotate(180deg); }
            60% { opacity: 1; transform: scale(1) rotate(360deg); }
            100% { opacity: 0; transform: scale(2) rotate(540deg); }
        }

    </style>
</head>
<body>

    <div id="splashScreen">
        <div class="splash-logo">
            <div class="logo-amida">
                <!-- Á∏¶Á∑ö -->
                <div class="logo-line-v"></div>
                <div class="logo-line-v"></div>
                <div class="logo-line-v"></div>
                <div class="logo-line-v"></div>
                <!-- Ê®™Á∑ö -->
                <div class="logo-line-h"></div>
                <div class="logo-line-h"></div>
                <div class="logo-line-h"></div>
                <div class="logo-line-h"></div>
                <div class="logo-line-h"></div>
                <div class="logo-line-h"></div>
                <!-- „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ -->
                <div class="logo-particle"></div>
                <div class="logo-particle"></div>
                <div class="logo-particle"></div>
            </div>
            <div class="logo-title">Á•û„ÅÇ„Åø„Å†</div>
            <div class="logo-subtitle">DIVINE LOTTERY</div>
        </div>
    </div>

    <!-- „Ç∞„É≠„Éº„Éê„É´„Éò„ÉÉ„ÉÄ„Éº -->
    <header id="globalHeader">
        <div class="header-left">
            <button class="menu-icon-btn" onclick="openMenu()">
                <span></span><span></span><span></span>
            </button>
            <button class="back-icon-btn hidden" id="backBtn" onclick="goBack()">‚Üê</button>
        </div>
        <div class="header-title" id="headerTitle">Á•û„ÅÇ„Åø„Å†</div>
        <div class="header-right">
            <button class="header-action-btn hidden" id="resetBtn" onclick="handleActionBtn()">üîÑ „É™„Çª„ÉÉ„Éà</button>
        </div>
    </header>

    <!-- „Çµ„Ç§„Éâ„É°„Éã„É•„Éº -->
    <div id="menuOverlay" onclick="closeMenu()"></div>
    <nav id="sideMenu">
        <div class="side-menu-header">
            <h2>Á•û„ÅÇ„Åø„Å†</h2>
        </div>
        <div class="side-menu-item" onclick="goHomeFromMenu()">
            <span>üè†</span> „Éõ„Éº„É†
        </div>
        <div class="side-menu-item" onclick="toggleSound()">
            <span id="soundIcon">üîä</span> <span id="soundText">„Çµ„Ç¶„É≥„Éâ ON</span>
        </div>
        <div class="side-menu-item" onclick="openSettings()">
            <span>‚öôÔ∏è</span> Ë®≠ÂÆö
        </div>
        <div class="side-menu-item" onclick="closeMenu()">
            <span>‚ùå</span> Èñâ„Åò„Çã
        </div>
    </nav>

    <!-- Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
    <div id="settingsOverlay" onclick="closeSettings()">
        <div class="settings-card" onclick="event.stopPropagation()">
            <h3 style="margin:0 0 20px 0; text-align:center;">‚öôÔ∏è Ë®≠ÂÆö</h3>

            <div class="settings-section">
                <div class="settings-label">ÁõÆÈö†„Åó„É¢„Éº„Éâ</div>
                <div class="settings-options">
                    <label class="settings-option" data-mode="goal">
                        <input type="radio" name="blindMode" value="goal" checked>
                        <span class="option-content">
                            <span class="option-title">üéÅ „Ç¥„Éº„É´Èö†„Åó„É¢„Éº„Éâ</span>
                            <span class="option-desc">ÈÅì„ÅØË¶ã„Åà„Çã„ÅåÁµêÊûú„ÅØÁùÄ„Åè„Åæ„ÅßÔºü</span>
                        </span>
                    </label>
                    <label class="settings-option" data-mode="curtain">
                        <input type="radio" name="blindMode" value="curtain">
                        <span class="option-content">
                            <span class="option-title">üé≠ „Ç´„Éº„ÉÜ„É≥„É¢„Éº„Éâ</span>
                            <span class="option-desc">Áúü„Çì‰∏≠„ÇíÈö†„Åô</span>
                        </span>
                    </label>
                </div>
            </div>

            <button class="settings-close-btn" onclick="closeSettings()">Èñâ„Åò„Çã</button>
        </div>
    </div>

    <!-- ‰∫∫Êï∞ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
    <div id="playerSelectOverlay" onclick="closePlayerSelect(event)">
        <div class="player-select-card" onclick="event.stopPropagation()">
            <button class="player-select-close" onclick="closePlayerSelect()">&times;</button>
            <div class="player-select-title">‰Ωï‰∫∫„ÅßÈÅä„Å≥„Åæ„Åô„ÅãÔºü</div>
            <div class="player-select-subtitle">Â∑¶Âè≥„Å´„Çπ„ÉØ„Ç§„Éó„Åó„Å¶ÈÅ∏Êäû</div>
            <div class="carousel-container">
                <button class="carousel-nav prev" onclick="carouselPrev()">&lt;</button>
                <div class="carousel-track" id="carouselTrack">
                    <!-- JavaScript„ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
                </div>
                <button class="carousel-nav next" onclick="carouselNext()">&gt;</button>
            </div>
            <div class="carousel-indicator" id="carouselIndicator">
                <!-- JavaScript„ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
            </div>
            <button class="player-select-btn" onclick="confirmPlayerCount()">„Åì„ÅÆ‰∫∫Êï∞„Åß„Çπ„Çø„Éº„ÉàÔºÅ</button>
        </div>
    </div>

    <div id="resultModalOverlay">
        <div class="result-card">
            <div class="result-title">ÁµêÊûú„ÅØ...</div>
            <div class="result-value" id="modalResultText"></div>
            <div class="result-btn-area">
                <button class="result-btn main-btn" onclick="closeModal()">OK</button>
                <button class="result-btn-small" onclick="shareResult()">üì§</button>
            </div>
            <div class="result-timer-bar">
                <div class="result-timer-progress" id="resultTimerProgress"></div>
            </div>
        </div>
    </div>

    <div id="menuScreen" class="screen">
        <div class="menu-card normal-card" onclick="selectMode('normal')">
            <div class="menu-icon-wrapper">
                <div class="amida-icon">
                    <div class="amida-v-line"></div>
                    <div class="amida-v-line"></div>
                    <div class="amida-v-line"></div>
                    <div class="amida-h-line"></div>
                    <div class="amida-h-line"></div>
                    <div class="amida-h-line"></div>
                    <div class="amida-pointer"></div>
                </div>
            </div>
            <h3 style="margin:0; color:#333;">„Åµ„Å§„ÅÜ„ÅÆ„ÅÇ„Åø„Å†</h3>
            <p style="margin:8px 0 0; color:#888; font-size:0.9rem;">Áü≠„Åè„Çµ„ÇØ„Çµ„ÇØÊ±∫„ÇÅ„Çã</p>
        </div>
        <div class="menu-card race-card" onclick="openRaceSetup()">
            <div class="menu-icon-wrapper">
                <div class="race-icon">
                    <div class="finish-sparkle"></div>
                    <div class="finish-sparkle"></div>
                    <div class="finish-sparkle"></div>
                    <div class="race-flag"></div>
                    <div class="race-animal rabbit"></div>
                    <div class="race-animal cat"></div>
                    <div class="race-animal dog"></div>
                    <div class="race-track"></div>
                </div>
            </div>
            <h3 style="margin:0; color:#333;">ÂãïÁâ©„É¨„Éº„Çπ</h3>
            <p style="margin:8px 0 0; color:#888; font-size:0.9rem;">Èï∑„Äú„ÅÑ„Ç≥„Éº„Çπ„ÅßÁ´∂‰∫â</p>
        </div>
    </div>

    <!-- ÂãïÁâ©„É¨„Éº„ÇπÂ∞ÇÁî®ÁîªÈù¢ -->
    <div id="raceSetupScreen" class="screen">
        <div class="race-ground-pattern"></div>
        <div class="race-setup-content">
            <div class="race-section-title">
                <span class="icon">üèÉ</span>
                ÂèÇÂä†„Ç≠„É£„É©„ÇØ„Çø„Éº
            </div>

            <button class="add-character-btn" onclick="openCharacterModal()">
                <span class="plus-icon">+</span>
                ÂèÇÂä†„Ç≠„É£„É©„ÇíËøΩÂä†
            </button>

            <div class="character-list" id="characterList">
                <!-- „Ç≠„É£„É©„ÇØ„Çø„Éº„Åå„Åì„Åì„Å´ËøΩÂä†„Åï„Çå„Çã -->
            </div>
        </div>

        <div class="race-bottom-bar">
            <div class="race-bottom-content">
                <div class="participant-count-box">
                    <span class="participant-label">ÂèÇÂä†Êï∞</span>
                    <div class="participant-count" id="participantCount">0</div>
                </div>
                <button class="race-next-btn" id="raceNextBtn" onclick="goToRaceGoalScreen()" disabled>
                    „Ç¥„Éº„É´„ÅÆÈ†ÖÁõÆ„ÇíÈÅ∏Êäû
                    <span>‚Üí</span>
                </button>
            </div>
        </div>
    </div>

    <!-- „Ç≠„É£„É©„ÇØ„Çø„ÉºËøΩÂä†„É¢„Éº„ÉÄ„É´ -->
    <div id="characterModal" onclick="closeCharacterModal(event)">
        <div class="character-modal-card" onclick="event.stopPropagation()">
            <div class="character-modal-header">
                <span class="character-modal-title" id="characterModalTitle">„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíËøΩÂä†</span>
                <button class="character-modal-close" onclick="closeCharacterModal()">&times;</button>
            </div>

            <div class="animal-grid" id="animalGrid">
                <!-- ÂãïÁâ©„Ç¢„Ç§„Ç≥„É≥„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Çã -->
            </div>

            <div class="name-input-area">
                <label class="name-input-label">„Å™„Åæ„Åà</label>
                <div class="name-input-row">
                    <input type="text" class="name-input" id="characterNameInput" placeholder="„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆÂêçÂâç" maxlength="10">
                    <button class="random-name-btn" onclick="setRandomName()">„Åä„Åæ„Åã„Åõ</button>
                </div>
            </div>

            <div class="character-modal-buttons">
                <button class="modal-cancel-btn" onclick="closeCharacterModal()">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="modal-confirm-btn" id="characterConfirmBtn" onclick="confirmCharacter()" disabled>Ê±∫ÂÆö</button>
            </div>
        </div>
    </div>

    <!-- „Ç¥„Éº„É´ÈÅ∏ÊäûËÇ¢ÁîªÈù¢ -->
    <div id="raceGoalScreen" class="screen">
        <div class="race-goal-content">
            <div class="race-section-title">
                <span class="icon">üèÅ</span>
                „Ç¥„Éº„É´„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÂÖ•Âäõ
            </div>
            <p style="color:#666; font-size:0.85rem; margin-bottom:15px; text-align:center;">
                ‚Üê „Çπ„ÉØ„Ç§„Éó„ÅßÂâäÈô§ / <span id="minGoalCount">2</span>ÂÄã‰ª•‰∏äÂøÖË¶Å
            </p>

            <div class="race-goal-list" id="raceGoalList">
                <!-- „Ç¥„Éº„É´ÈÅ∏ÊäûËÇ¢„Åå„Åì„Åì„Å´ËøΩÂä†„Åï„Çå„Çã -->
            </div>

            <div style="display:flex; justify-content:center; margin-bottom:20px;">
                <button class="race-add-goal-btn" id="raceAddGoalBtn" onclick="addRaceGoalItem()">Ôºã</button>
            </div>
        </div>

        <div class="race-bottom-bar">
            <div class="race-bottom-content">
                <button class="race-next-btn" id="raceStartSetupBtn" onclick="goToStartLineScreen()" disabled>
                    „Çπ„Çø„Éº„Éà„É©„Ç§„É≥„Å∏
                    <span>‚Üí</span>
                </button>
            </div>
        </div>
    </div>

    <!-- „Çπ„Çø„Éº„Éà„É©„Ç§„É≥ÈÖçÁΩÆÁîªÈù¢ -->
    <div id="raceStartScreen" class="screen">
        <div class="start-instruction">
            „Ç≠„É£„É©„ÇØ„Çø„Éº„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶<br>Â•Ω„Åç„Å™„Çπ„Çø„Éº„Éà„É©„Ç§„É≥„Å´ÈÖçÁΩÆ„Åó„Çà„ÅÜÔºÅ
        </div>

        <div class="waiting-characters" id="waitingCharacters">
            <!-- ÈÖçÁΩÆÂæÖ„Å°„ÅÆ„Ç≠„É£„É©„ÇØ„Çø„Éº -->
        </div>

        <div class="start-line-area" id="startLineArea">
            <!-- „Çπ„Çø„Éº„Éà„É©„Ç§„É≥„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Çã -->
        </div>

        <button class="race-start-btn" id="raceStartBtn" onclick="startRaceCountdown()" disabled>
            „É¨„Éº„Çπ„Çπ„Çø„Éº„ÉàÔºÅ
        </button>
    </div>

    <!-- „É¨„Éº„ÇπÈñãÂßã„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ -->
    <div class="race-countdown-overlay" id="raceCountdownOverlay">
        <div class="countdown-text" id="countdownText"></div>
    </div>

    <div id="setupScreen" class="screen">
        <div class="setup-header">
            <div class="setup-header-left">
                <div class="active-template-badge" id="activeTemplateBadge" onclick="openTemplateEditor()">
                    <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                </div>
            </div>
            <h3 id="listTitle" style="margin:0; color:#333;">ÈÅ∏ÊäûËÇ¢„ÇíÂÖ•Âäõ</h3>
            <div class="setup-header-right">
                <button class="template-trigger-btn" id="templateTriggerBtn" onclick="openTemplateEditor()">
                    üìã
                </button>
            </div>
        </div>

        <p style="color:#888; font-size:0.8rem; margin-bottom:20px;">‚Üê„Çπ„ÉØ„Ç§„Éó„ÅßÂâäÈô§</p>
        <div id="goalList"></div>
        <div class="add-btn-area">
            <button class="add-btn" id="addBtn" onclick="addGoalItem()">Ôºã</button>
        </div>
        <button class="submit-btn" onclick="startGame()">„Åì„Çå„ÅßÊ±∫ÂÆöÔºÅ</button>
    </div>

    <!-- „Ç¢„Ç§„Ç≥„É≥ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
    <div id="iconPickerOverlay">
        <div class="icon-picker-card" onclick="event.stopPropagation()">
            <h3 style="margin:0 0 15px 0; text-align:center;">üé® „Ç¢„Ç§„Ç≥„É≥„ÇíÈÅ∏Êäû</h3>
            <div id="iconGrid" class="icon-grid"></div>
            <button class="settings-close-btn" onclick="closeIconPicker()">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
    </div>

    <!-- „ÉÜ„É≥„Éó„É¨„Éº„Éà„É¢„Éº„ÉÄ„É´ -->
    <div id="templateEditorOverlay">
        <div class="template-editor-card" onclick="event.stopPropagation()">
            <div class="template-editor-header">
                <button class="te-edit-toggle-btn" id="teEditToggleBtn" onclick="toggleEditMode()">Á∑®ÈõÜ</button>
                <button class="te-back-btn" id="teBackBtn" onclick="teGoBack()">‚Üê</button>
                <h3 id="teTitle">üìã „ÉÜ„É≥„Éó„É¨„Éº„Éà</h3>
                <button class="te-close-btn" onclick="closeTemplateEditor()">‚úï</button>
            </div>

            <div class="te-hint-area" id="teHintArea">
                <!-- ÈÅ∏Êäû„É¢„Éº„Éâ: „ÅäÊ∞ó„Å´ÂÖ•„Çä / Á∑®ÈõÜ„É¢„Éº„Éâ: „Éâ„É©„ÉÉ„Ç∞„Éí„É≥„Éà -->
            </div>

            <div class="template-editor-content" id="teContent">
                <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
            </div>

            <div class="template-editor-footer" id="teFooter">
                <button class="te-reset-btn" onclick="resetToDefault()">üîÑ ÂàùÊúüÁä∂ÊÖã„Å´Êàª„Åô</button>
            </div>
        </div>
    </div>

    <div id="gameScreen" class="screen">
        <div id="buttonLayer"></div>
        <div id="dropZoneLayer"></div>

        <canvas id="amidaCanvas"></canvas>
        <div id="tankLayer"></div>
        <div id="curtain">?</div>
        <button id="raceBtn" onclick="startRaceRun()" disabled>GO!</button>
        <button id="fastForwardBtn">‚è©</button>

        <!-- „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÖçÁΩÆUI -->
        <div id="charPlacementUI">
            <div class="placement-title">„Ç≠„É£„É©„ÇØ„Çø„Éº„Çí„Çπ„Çø„Éº„Éà‰ΩçÁΩÆ„Å´„Éâ„É©„ÉÉ„Ç∞ÔºÅ</div>
            <div class="placement-chars" id="placementChars">
                <!-- JavaScript„ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
            </div>
        </div>
    </div>

    <!-- „Ç´„Çπ„Çø„É†Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞ÔºàÊúÄÂâçÈù¢„Å´ÈÖçÁΩÆÔºâ -->
    <div id="confirmOverlay">
        <div class="confirm-card">
            <div class="confirm-icon" id="confirmIcon">‚ö†Ô∏è</div>
            <div class="confirm-message" id="confirmMessage">„É°„ÉÉ„Çª„Éº„Ç∏</div>
            <div class="confirm-buttons">
                <button class="confirm-btn confirm-cancel" id="confirmCancelBtn" onclick="confirmCancel()">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="confirm-btn confirm-ok" id="confirmOkBtn" onclick="confirmOk()">OK</button>
            </div>
        </div>
    </div>

    <script>
        const MAX_COUNT = 8;
        const MIN_COUNT = 2;
        const screens = ['menuScreen', 'setupScreen', 'gameScreen', 'raceSetupScreen', 'raceGoalScreen', 'raceStartScreen'];
        let currentMode = 'normal';
        const numCircle = ['‚ë†', '‚ë°', '‚ë¢', '‚ë£', '‚ë§', '‚ë•', '‚ë¶', '‚ëß'];

        // „Éá„Éï„Ç©„É´„Éà„ÅÆ„Éó„É™„Çª„ÉÉ„Éà„Éá„Éº„Çø
        const DEFAULT_PRESET_GENRES = {
            food: {
                name: 'È£ü‰∫ã',
                color: '#ff6b6b',
                icon: 'üçΩÔ∏è',
                items: {
                    lunch: {
                        label: '„É©„É≥„ÉÅ',
                        type: 'random',
                        choices: ['„É©„Éº„É°„É≥', '„Ç´„É¨„Éº', 'ÂÆöÈ£ü', '‰∏º„ÇÇ„ÅÆ', '„Éë„Çπ„Çø', '„ÅÜ„Å©„Çì', '„Åù„Å∞', '„Éè„É≥„Éê„Éº„Ç∞', '„Çø„Ç§ÊñôÁêÜ', '„Éô„Éà„Éä„É†ÊñôÁêÜ', '„Ç§„É≥„Éâ„Ç´„É¨„Éº', '„Ç™„É†„É©„Ç§„Çπ', '„Éî„Ç∂', 'ÁÑº„Åç„Åù„Å∞']
                    },
                    dinner: {
                        label: '„Éá„Ç£„Éä„Éº',
                        type: 'random',
                        choices: ['ÂíåÈ£ü', '‰∏≠ËèØ', 'Ê¥ãÈ£ü', 'ÁÑºËÇâ', 'ÂØøÂè∏', 'Èçã', 'Â±ÖÈÖíÂ±ã', '„Ç§„Çø„É™„Ç¢„É≥', '„Éï„É¨„É≥„ÉÅ', 'ÈüìÂõΩÊñôÁêÜ', 'ÁÑº„ÅçÈ≥•', '„Åó„ÇÉ„Å∂„Åó„ÇÉ„Å∂', '„Çπ„ÉÜ„Éº„Ç≠', 'Â§©„Å∑„Çâ']
                    },
                    ramen: {
                        label: '„É©„Éº„É°„É≥',
                        type: 'random',
                        choices: ['ÈÜ§Ê≤π', 'Âë≥Âôå', 'Â°©', 'Ë±öÈ™®', '„Å§„ÅëÈ∫∫', 'ÊãÖ„ÄÖÈ∫∫', 'ÂÆ∂Á≥ª', '‰∫åÈÉéÁ≥ª', 'ÁÖÆÂπ≤„Åó', 'È∂èÁôΩÊπØ', 'Ê≤π„Åù„Å∞', '„Åæ„Åú„Åù„Å∞']
                    },
                    fastfood: {
                        label: '„Éï„Ç°„Çπ„Éà„Éï„Éº„Éâ',
                        type: 'random',
                        choices: ['„Éû„ÉÉ„ÇØ', '„É¢„Çπ', '„Ç±„É≥„Çø', 'ÂêâÈáéÂÆ∂', '„Åô„ÅçÂÆ∂', 'ÊùæÂ±ã', '„Éê„Éº„Ç¨„Éº„Ç≠„É≥„Ç∞', '„Çµ„Éñ„Ç¶„Çß„Ç§', '„Å™„ÅãÂçØ', '„Åã„Å§„ÇÑ', 'CoCoÂ£±', 'Êó•È´òÂ±ã']
                    },
                    konbini: {
                        label: '„Ç≥„É≥„Éì„Éã',
                        type: 'random',
                        choices: ['„Çª„Éñ„É≥', '„Éï„Ç°„Éü„Éû', '„É≠„Éº„ÇΩ„É≥', '„Éü„Éã„Çπ„Éà„ÉÉ„Éó', '„Éá„Ç§„É™„Éº„É§„Éû„Ç∂„Ç≠']
                    }
                }
            },
            drink: {
                name: '„Éâ„É™„É≥„ÇØ',
                color: '#54a0ff',
                icon: '‚òï',
                items: {
                    cafe: {
                        label: '„Ç´„Éï„Çß',
                        type: 'random',
                        choices: ['„Çπ„Çø„Éê', '„Éâ„Éà„Éº„É´', '„Çø„É™„Éº„Ç∫', '„Ç≥„É°„ÉÄ', '„Çµ„É≥„Éû„É´„ÇØ', '„Éô„É≠„Éº„ÉÅ„Çß', 'Êòü‰πÉÁèàÁê≤', '„É´„Éé„Ç¢„Éº„É´', '„Éó„É≠„É≥„Éà']
                    },
                    alcohol: {
                        label: '„ÅäÈÖí',
                        type: 'random',
                        choices: ['„Éì„Éº„É´', '„Éè„Ç§„Éú„Éº„É´', '„Çµ„ÉØ„Éº', '„ÉØ„Ç§„É≥', 'Êó•Êú¨ÈÖí', '„Ç´„ÇØ„ÉÜ„É´', 'ÁÑºÈÖé', '„Ç¶„Ç§„Çπ„Ç≠„Éº', 'Ê¢ÖÈÖí', '„Éû„ÉÉ„Ç≥„É™']
                    },
                    softdrink: {
                        label: '„ÇΩ„Éï„Éà„Éâ„É™„É≥„ÇØ',
                        type: 'random',
                        choices: ['„Ç≥„Éº„É©', '„ÅäËå∂', '„Ç∏„É•„Éº„Çπ', 'Ê∞¥', '„Ç≥„Éº„Éí„Éº', '„Ç®„Éä„Éâ„É™', '„Çπ„É†„Éº„Ç∏„Éº', 'ÁÇ≠ÈÖ∏Ê∞¥', '„Ç≥„Ç≥„Ç¢', '„Éü„É´„ÇØ„ÉÜ„Ç£„Éº']
                    },
                    sweets: {
                        label: '„Çπ„Ç§„Éº„ÉÑ',
                        type: 'random',
                        choices: ['„Ç±„Éº„Ç≠', '„Ç¢„Ç§„Çπ', '„ÉÅ„Éß„Ç≥', '„Éó„É™„É≥', '„Éâ„Éº„Éä„ÉÑ', '„ÇØ„É¨„Éº„Éó', '„Éë„Éï„Çß', '„Çø„É´„Éà', '„Ç∑„É•„Éº„ÇØ„É™„Éº„É†', '„Éë„É≥„Ç±„Éº„Ç≠']
                    }
                }
            },
            people: {
                name: '‰∫∫„ÉªÈ†ÜÁï™',
                color: '#5f27cd',
                icon: 'üë•',
                items: {
                    person: {
                        label: 'ÊãÖÂΩì',
                        type: 'dynamic',
                        template: 'alphabet_san'
                    },
                    order: {
                        label: 'È†ÜÁï™',
                        type: 'dynamic',
                        template: 'number_banme'
                    },
                    team: {
                        label: '„ÉÅ„Éº„É†',
                        type: 'dynamic',
                        template: 'team_alphabet'
                    },
                    number: {
                        label: 'Áï™Âè∑',
                        type: 'dynamic',
                        template: 'number_ban'
                    },
                    role: {
                        label: 'ÂΩπÂâ≤',
                        type: 'random',
                        choices: ['„É™„Éº„ÉÄ„Éº', '„Çµ„Éñ„É™„Éº„ÉÄ„Éº', 'Êõ∏Ë®ò', '‰ºöË®à', 'Â∫ÉÂ†±', 'Ê∏âÂ§ñ', '‰ºÅÁîª', 'Âè∏‰ºö', '„Çø„Ç§„É†„Ç≠„Éº„Éë„Éº']
                    }
                }
            },
            play: {
                name: 'ÈÅä„Å≥',
                color: '#ff9f43',
                icon: 'üéÆ',
                items: {
                    janken: {
                        label: '„Åò„ÇÉ„Çì„Åë„Çì',
                        type: 'fixed',
                        choices: ['„Ç∞„Éº', '„ÉÅ„Éß„Ç≠', '„Éë„Éº']
                    },
                    game: {
                        label: '„Ç≤„Éº„É†',
                        type: 'random',
                        choices: ['„Çπ„Ç§„ÉÉ„ÉÅ', 'PS5', '„Çπ„Éû„Éõ„Ç≤„Éº', '„Éú„Éâ„Ç≤', '„Ç´„É©„Ç™„Ç±', '„Éì„É™„É§„Éº„Éâ', '„ÉÄ„Éº„ÉÑ', 'È∫ªÈõÄ', '„Éà„É©„É≥„Éó', 'UNO', '„Éú„Ç¶„É™„É≥„Ç∞']
                    },
                    sport: {
                        label: '„Çπ„Éù„Éº„ÉÑ',
                        type: 'random',
                        choices: ['„Çµ„ÉÉ„Ç´„Éº', 'ÈáéÁêÉ', '„Éê„Çπ„Ç±', '„ÉÜ„Éã„Çπ', '„Éú„Ç¶„É™„É≥„Ç∞', '„Éê„Éâ„Éü„É≥„Éà„É≥', 'ÂçìÁêÉ', '„Ç¥„É´„Éï', '„Éï„ÉÉ„Éà„Çµ„É´', '„Éê„É¨„Éº']
                    },
                    movie: {
                        label: 'Êò†Áîª',
                        type: 'random',
                        choices: ['„Ç¢„ÇØ„Ç∑„Éß„É≥', '„Ç≥„É°„Éá„Ç£', '„Éõ„É©„Éº', 'ÊÅãÊÑõ', 'SF', '„Ç¢„Éã„É°', '„Éü„Çπ„ÉÜ„É™„Éº', '„Éï„Ç°„É≥„Çø„Ç∏„Éº', '„Éâ„Ç≠„É•„É°„É≥„Çø„É™„Éº']
                    },
                    date: {
                        label: '„Éá„Éº„Éà',
                        type: 'random',
                        choices: ['Êò†Áîª', 'Ê∞¥ÊóèÈ§®', 'ÈÅäÂúíÂú∞', '„Ç∑„Éß„ÉÉ„Éî„É≥„Ç∞', '„Éâ„É©„Ç§„Éñ', '„Ç´„Éï„Çß', 'ÂãïÁâ©Âúí', 'ÁæéË°ìÈ§®', 'Ê∏©Ê≥â', '„Éî„ÇØ„Éã„ÉÉ„ÇØ']
                    }
                }
            },
            life: {
                name: 'ÁîüÊ¥ª',
                color: '#1dd1a1',
                icon: 'üè†',
                items: {
                    yesno: {
                        label: 'YES/NO',
                        type: 'fixed',
                        choices: ['YES', 'NO']
                    },
                    weekday: {
                        label: 'ÊõúÊó•',
                        type: 'fixed',
                        choices: ['ÊúàÊõú', 'ÁÅ´Êõú', 'Ê∞¥Êõú', 'Êú®Êõú', 'ÈáëÊõú', 'ÂúüÊõú', 'Êó•Êõú']
                    },
                    place: {
                        label: 'Â†¥ÊâÄ',
                        type: 'random',
                        choices: ['ÈßÖÂâç', 'ÂÖ¨Âúí', '„É¢„Éº„É´', '„Ç´„Éï„Çß', 'Ëá™ÂÆÖ', '„Ç™„É≥„É©„Ç§„É≥', 'Âõ≥Êõ∏È§®', '„Éï„Ç°„Éü„É¨„Çπ', '‰ºöË≠∞ÂÆ§', 'Ê≤≥Â∑ùÊï∑']
                    },
                    time: {
                        label: 'ÊôÇÈñìÂ∏Ø',
                        type: 'fixed',
                        choices: ['Êúù', 'Êòº', 'Â§ïÊñπ', 'Â§ú', 'Ê∑±Â§ú']
                    },
                    season: {
                        label: 'Â≠£ÁØÄ',
                        type: 'fixed',
                        choices: ['Êò•', 'Â§è', 'Áßã', 'ÂÜ¨']
                    }
                }
            }
        };

        // „ÉÜ„Éº„Éû„Ç´„É©„ÉºÈÅ∏ÊäûËÇ¢
        const themeColors = [
            '#ff6b6b', '#ff9f43', '#feca57', '#1dd1a1', '#54a0ff',
            '#5f27cd', '#ff6b9d', '#c44569', '#778ca3', '#2d3436'
        ];

        // „Ç∏„É£„É≥„É´„Ç¢„Ç§„Ç≥„É≥ÈÅ∏ÊäûËÇ¢Ôºà20Á®ÆÈ°ûÔºâ
        const genreIcons = [
            'üçΩÔ∏è', '‚òï', 'üë•', 'üéÆ', 'üè†',  // „Éá„Éï„Ç©„É´„Éà5„Å§
            'üéµ', 'üìö', '‚úàÔ∏è', 'üíº', 'üé®',  // Èü≥Ê•Ω„ÄÅÊú¨„ÄÅÊóÖË°å„ÄÅ‰ªï‰∫ã„ÄÅ„Ç¢„Éº„Éà
            '‚öΩ', 'üé¨', 'üõí', 'üí∞', '‚ù§Ô∏è',  // „Çπ„Éù„Éº„ÉÑ„ÄÅÊò†Áîª„ÄÅË≤∑„ÅÑÁâ©„ÄÅ„ÅäÈáë„ÄÅÊÅãÊÑõ
            'üéÅ', 'üìÖ', 'üîß', 'üåü', 'üéØ',  // „Éó„É¨„Çº„É≥„Éà„ÄÅ‰∫àÂÆö„ÄÅ„ÉÑ„Éº„É´„ÄÅÁâπÂà•„ÄÅÁõÆÊ®ô
            'üéì', 'üè•', 'üêæ', 'üå∏'         // Â≠¶Ê†°„ÄÅÂåªÁôÇ„ÄÅ„Éö„ÉÉ„Éà„ÄÅÂ≠£ÁØÄ
        ];

        // ÂãïÁöÑ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆÁîüÊàêÈñ¢Êï∞
        const dynamicTemplates = {
            'alphabet_san': (n) => String.fromCharCode(65 + n) + '„Åï„Çì',
            'number_banme': (n) => (n + 1) + 'Áï™ÁõÆ',
            'team_alphabet': (n) => '„ÉÅ„Éº„É†' + String.fromCharCode(65 + n),
            'number_ban': (n) => (n + 1) + 'Áï™'
        };

        // „É¶„Éº„Ç∂„Éº„ÅÆ„Ç´„Çπ„Çø„É†„Éá„Éº„ÇøÔºàlocalStorage„Åã„ÇâË™≠„ÅøËæº„ÅøÔºâ
        let presetGenres = JSON.parse(JSON.stringify(DEFAULT_PRESET_GENRES));

        let currentGenre = 'food'; // ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆ„Ç∏„É£„É≥„É´
        let activeTemplateGenre = null; // ÈÅ©Áî®‰∏≠„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆ„Ç∏„É£„É≥„É´„Ç≠„Éº
        let activeTemplateSub = null; // ÈÅ©Áî®‰∏≠„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆ„Çµ„Éñ„Ç≠„Éº

        // localStorage„Åã„ÇâË™≠„ÅøËæº„Åø
        function loadCustomPresets() {
            const saved = localStorage.getItem('amidakuji_presets');
            if (saved) {
                try {
                    presetGenres = JSON.parse(saved);
                } catch (e) {
                    presetGenres = JSON.parse(JSON.stringify(DEFAULT_PRESET_GENRES));
                }
            }
        }

        // localStorage„Å´‰øùÂ≠ò
        function saveCustomPresets() {
            localStorage.setItem('amidakuji_presets', JSON.stringify(presetGenres));
        }

        // ÂàùÊúüÂåñÊôÇ„Å´Ë™≠„ÅøËæº„Åø
        loadCustomPresets();

        // „Ç¢„Ç§„Ç≥„É≥ÈÅ∏ÊäûÁî®
        const availableIcons = [
            'üòÄ', 'üòé', 'ü•≥', 'üòá', 'ü§©', 'üòã',
            'üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä',
            'üçé', 'üçï', 'üçî', 'üç£', 'üçú', 'üç©',
            '‚≠ê', '‚ù§Ô∏è', 'üî•', 'üíé', 'üéØ', 'üé≤',
            'üöÄ', 'üé∏', 'üéÆ', 'üìö', 'üí°', 'üé®'
        ];
        let currentIconTarget = null; // „Ç¢„Ç§„Ç≥„É≥ÈÅ∏ÊäûÂØæË±°„ÅÆDOMË¶ÅÁ¥†

        // ÁõÆÈö†„Åó„É¢„Éº„ÉâË®≠ÂÆö: 'curtain'Ôºà„Ç´„Éº„ÉÜ„É≥Ôºâor 'goal'Ôºà„Ç¥„Éº„É´Èö†„ÅóÔºâ
        let blindMode = 'goal';
        let shuffledGoalLabels = []; // „Ç∑„É£„ÉÉ„Éï„É´„Åï„Çå„ÅüÁµêÊûúË°®Á§∫Áî®

        const canvas = document.getElementById('amidaCanvas');
        const ctx = canvas.getContext('2d');
        let ladders = [];
        let players = [];
        let goalLabels = [];
        let columnWidth = 0;
        let topMargin = 75;
        const tankHeight = 50; // „Çø„É≥„ÇØ„ÅÆÈ´ò„Åï

        let stepHeight = 0;
        let isAnimating = false;
        let animationId = null;
        let startedPlayerCount = 0;
        let dpr = 1;

        // Êó©ÈÄÅ„ÇäÊ©üËÉΩÔºà1x ‚Üí 2x ‚Üí 4x „É´„Éº„ÉóÔºâ
        const speedLevels = [1, 2, 4];
        let currentSpeedIndex = 0;
        let currentSpeedMultiplier = speedLevels[0];

        const characters = ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêº', 'üê®'];
        const colors = ['#ff6b6b', '#54a0ff', '#5f27cd', '#ff9f43', '#1dd1a1', '#ff85a2', '#2d6a4f', '#ffd93d'];

        // =========================================
        // „Çµ„Ç¶„É≥„Éâ„Ç∑„Çπ„ÉÜ„É†
        // =========================================
        let audioCtx = null;
        let bgmOscillators = [];
        let bgmGain = null;
        let isBgmPlaying = false;
        let isSoundEnabled = true; // „Çµ„Ç¶„É≥„ÉâON/OFF

        function toggleSound() {
            isSoundEnabled = !isSoundEnabled;
            const icon = document.getElementById('soundIcon');
            const text = document.getElementById('soundText');

            if (isSoundEnabled) {
                icon.textContent = 'üîä';
                text.textContent = '„Çµ„Ç¶„É≥„Éâ ON';

                // AudioContext„ÇíÂÜçÈñãÔºà„É¶„Éº„Ç∂„Éº„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥‰∏≠„Å´ÂÆüË°åÔºâ
                if (audioCtx && audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }

                // ÁèæÂú®„ÅÆÁîªÈù¢„ÇíÂèñÂæó
                const currentScreen = screenHistory[screenHistory.length - 1];

                // „Ç≤„Éº„É†ÁîªÈù¢„ÅÆÂ†¥Âêà
                if (currentScreen === 'gameScreen') {
                    if (isAnimating) {
                        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰∏≠„Å™„ÇâÁßªÂãïÈü≥„ÇíÂÜçÈñã
                        startMoveSound();
                    }
                    // „Ç≤„Éº„É†BGM„ÇíÂÜçÈñã
                    isBgmPlaying = false;
                    startBgm();
                }
                // Ë®≠ÂÆöÁîªÈù¢„ÅÆÂ†¥Âêà„ÅØ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóBGM„ÇíÂÜçÈñã
                else if (currentScreen === 'setupScreen') {
                    isSetupBgmPlaying = false;
                    startSetupBgm();
                }
            } else {
                icon.textContent = 'üîá';
                text.textContent = '„Çµ„Ç¶„É≥„Éâ OFF';
                // ÂÖ®„Å¶„ÅÆÈü≥„ÇíÂÅúÊ≠¢
                stopBgm();
                stopSetupBgm();
                stopMoveSound();
            }
        }

        function initAudio() {
            if (!isSoundEnabled) return false;
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            return true;
        }

        // „Éú„Çø„É≥Êäº‰∏ãÈü≥Ôºà„Éù„ÉÉ„ÉóÈü≥Ôºâ
        function playButtonSound() {
            if (!initAudio()) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.1);

            gain.gain.setValueAtTime(0.6, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);

            osc.start(audioCtx.currentTime);
            osc.stop(audioCtx.currentTime + 0.15);
        }

        // ÁßªÂãïÈü≥Ôºà„Ç≥„É≠„Ç≥„É≠Ëª¢„Åå„ÇãÈü≥Ôºâ
        let moveSoundInterval = null;
        let moveSoundGain = null;

        function startMoveSound() {
            if (!isSoundEnabled) return;
            if (moveSoundInterval) return;
            if (!initAudio()) return;

            moveSoundGain = audioCtx.createGain();
            moveSoundGain.gain.value = 0.15;
            moveSoundGain.connect(audioCtx.destination);

            playMoveTick();
        }

        function playMoveTick() {
            if (!isAnimating || !isSoundEnabled) {
                stopMoveSound();
                return;
            }

            const osc = audioCtx.createOscillator();
            const tickGain = audioCtx.createGain();

            osc.connect(tickGain);
            tickGain.connect(moveSoundGain);

            // „É©„É≥„ÉÄ„É†„Å™È´ò„Åï„Åß„Ç≥„É≠„Ç≥„É≠ÊÑü
            const baseFreq = 300 + Math.random() * 200;
            osc.frequency.setValueAtTime(baseFreq, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(baseFreq * 0.8, audioCtx.currentTime + 0.05);

            osc.type = 'sine';
            tickGain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            tickGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.08);

            osc.start(audioCtx.currentTime);
            osc.stop(audioCtx.currentTime + 0.08);

            // Êó©ÈÄÅ„ÇäÂÄçÁéá„Å´Âøú„Åò„Å¶ÈñìÈöî„ÇíË™øÊï¥
            const interval = 100 / currentSpeedMultiplier;
            moveSoundInterval = setTimeout(playMoveTick, interval);
        }

        function stopMoveSound() {
            if (moveSoundInterval) {
                clearTimeout(moveSoundInterval);
                moveSoundInterval = null;
            }
        }

        // Ê∞¥„ÅåÊ∫ú„Åæ„ÇãÈü≥
        function playWaterSound() {
            if (!initAudio()) return;
            const duration = 2;

            // „Éê„Éñ„É´Èü≥„ÇíË§áÊï∞ÁîüÊàê
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    const filter = audioCtx.createBiquadFilter();

                    osc.connect(filter);
                    filter.connect(gain);
                    gain.connect(audioCtx.destination);

                    filter.type = 'lowpass';
                    filter.frequency.value = 800;

                    const baseFreq = 200 + Math.random() * 300;
                    osc.frequency.setValueAtTime(baseFreq, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(baseFreq * 0.5, audioCtx.currentTime + 0.2);

                    osc.type = 'sine';
                    gain.gain.setValueAtTime(0.35, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.25);

                    osc.start(audioCtx.currentTime);
                    osc.stop(audioCtx.currentTime + 0.25);
                }, i * 200);
            }
        }

        // „Éï„Ç°„É≥„Éï„Ç°„Éº„É¨ÔºàÂÖ®Âì°ÁµÇ‰∫ÜÊôÇÔºâ
        function playFanfare() {
            if (!initAudio()) return;
            const notes = [523, 659, 784, 1047]; // C5, E5, G5, C6
            const times = [0, 0.15, 0.3, 0.45];

            notes.forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();

                osc.connect(gain);
                gain.connect(audioCtx.destination);

                osc.frequency.value = freq;
                osc.type = 'triangle';

                const startTime = audioCtx.currentTime + times[i];
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.3, startTime + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.5);

                osc.start(startTime);
                osc.stop(startTime + 0.5);
            });
        }

        // „ÇØ„É©„ÉÉ„Ç´„ÉºÈü≥ÔºàÂÄãÂà•ÁµêÊûúÁô∫Ë°®ÊôÇÔºâ
        function playCrackerSound() {
            if (!initAudio()) return;

            // „Éé„Ç§„Ç∫„Éê„Éº„Çπ„ÉàÔºà„Éë„É≥ÔºÅ„Å®„ÅÑ„ÅÜÈü≥Ôºâ
            const bufferSize = audioCtx.sampleRate * 0.15;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);

            for (let i = 0; i < bufferSize; i++) {
                // ÊúÄÂàù„ÅØÂ§ß„Åç„Åè„ÄÅÊÄ•ÈÄü„Å´Ê∏õË°∞
                const envelope = Math.exp(-i / (audioCtx.sampleRate * 0.02));
                data[i] = (Math.random() * 2 - 1) * envelope;
            }

            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;

            const noiseGain = audioCtx.createGain();
            noiseGain.gain.value = 0.4;

            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 1000;

            noise.connect(filter);
            filter.connect(noiseGain);
            noiseGain.connect(audioCtx.destination);

            noise.start();

            // È´òÈü≥„ÅÆ„Ç≠„É©„Ç≠„É©ÔºàÁ¥ôÂêπÈõ™ÊÑüÔºâ
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();

                    osc.connect(gain);
                    gain.connect(audioCtx.destination);

                    osc.frequency.value = 2000 + Math.random() * 2000;
                    osc.type = 'sine';

                    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.1);
                }, i * 30);
            }
        }

        // BGMÔºà„Ç∑„É≥„Éó„É´„Å™„É´„Éº„ÉóÔºâ
        function startBgm() {
            if (!isSoundEnabled) return;
            if (isBgmPlaying) return;
            if (!initAudio()) return;
            isBgmPlaying = true;

            bgmGain = audioCtx.createGain();
            bgmGain.gain.value = 0.35;
            bgmGain.connect(audioCtx.destination);

            playBgmLoop();
        }

        function playBgmLoop() {
            if (!isBgmPlaying) return;

            // „Ç∑„É≥„Éó„É´„Å™„Ç¢„É´„Éö„Ç∏„Ç™
            const notes = [262, 330, 392, 330, 262, 330, 392, 523];
            const noteLength = 0.25;

            notes.forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                const noteGain = audioCtx.createGain();

                osc.connect(noteGain);
                noteGain.connect(bgmGain);

                osc.frequency.value = freq;
                osc.type = 'sine';

                const startTime = audioCtx.currentTime + i * noteLength;
                noteGain.gain.setValueAtTime(0.5, startTime);
                noteGain.gain.exponentialRampToValueAtTime(0.01, startTime + noteLength * 0.9);

                osc.start(startTime);
                osc.stop(startTime + noteLength);

                bgmOscillators.push(osc);
            });

            // „É´„Éº„Éó
            setTimeout(() => {
                if (isBgmPlaying) playBgmLoop();
            }, notes.length * noteLength * 1000);
        }

        function stopBgm() {
            isBgmPlaying = false;
            bgmOscillators.forEach(osc => {
                try { osc.stop(); } catch(e) {}
            });
            bgmOscillators = [];
            // Âç≥Â∫ß„Å´Èü≥„ÇíÊ∂à„Åô
            if (bgmGain) {
                bgmGain.gain.value = 0;
            }
        }

        // „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁîªÈù¢Áî®BGMÔºà„Éè„Ç§„Éè„ÉÉ„Éà„ÅÆ„Åø„ÅÆÂ∞èÊ∞óÂë≥„Çà„ÅÑ„É™„Ç∫„É†Ôºâ
        let isSetupBgmPlaying = false;
        let setupBgmGain = null;
        let setupBgmTimeout = null;

        function startSetupBgm() {
            if (!isSoundEnabled) return;
            if (isSetupBgmPlaying) return;
            if (!initAudio()) return;
            isSetupBgmPlaying = true;

            setupBgmGain = audioCtx.createGain();
            setupBgmGain.gain.value = 0.2;
            setupBgmGain.connect(audioCtx.destination);

            playSetupBgmLoop();
        }

        // „Éè„Ç§„Éè„ÉÉ„Éà
        function playHiHat(time, volume = 0.12, long = false) {
            if (!isSetupBgmPlaying) return;

            const duration = long ? 0.12 : 0.05;
            const bufferSize = audioCtx.sampleRate * duration;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }

            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;

            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 7000;

            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(volume, time);
            const decay = long ? 0.15 : 0.06;
            gain.gain.exponentialRampToValueAtTime(0.01, time + decay);

            noise.connect(filter);
            filter.connect(gain);
            gain.connect(setupBgmGain);

            noise.start(time);
            noise.stop(time + duration + 0.05);
        }

        function playSetupBgmLoop() {
            if (!isSetupBgmPlaying) return;

            const bpm = 120;
            const beat = 60 / bpm;
            const now = audioCtx.currentTime;

            // „ÉÅ„ÉÉ„Éª„Éª„ÉÅ„ÉÅ„Éº „ÅÆ„É™„Ç∫„É†„Éë„Çø„Éº„É≥
            for (let i = 0; i < 4; i++) {
                const offset = i * beat * 2;
                playHiHat(now + offset, 0.16, false);             // „ÉÅ„ÉÉ
                playHiHat(now + offset + beat * 0.7, 0.10, false); // „ÉÅ
                playHiHat(now + offset + beat * 0.95, 0.14, true); // „ÉÅ„ÉºÔºàÈüø„ÅèÔºâ
            }

            // 8Êãç„Åß„É´„Éº„Éó
            const loopDuration = beat * 8 * 1000;
            setupBgmTimeout = setTimeout(() => {
                if (isSetupBgmPlaying) playSetupBgmLoop();
            }, loopDuration - 30);
        }

        function stopSetupBgm() {
            isSetupBgmPlaying = false;
            if (setupBgmTimeout) {
                clearTimeout(setupBgmTimeout);
                setupBgmTimeout = null;
            }
            // Âç≥Â∫ß„Å´Èü≥„ÇíÊ∂à„Åô
            if (setupBgmGain) {
                setupBgmGain.gain.value = 0;
            }
        }

        // Êó©ÈÄÅ„Çä„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„ÉàË®≠ÂÆö
        document.addEventListener('DOMContentLoaded', () => {
            const ffBtn = document.getElementById('fastForwardBtn');
            ffBtn.addEventListener('click', toggleSpeed);
            updateSpeedBtn();
        });

        function toggleSpeed() {
            currentSpeedIndex = (currentSpeedIndex + 1) % speedLevels.length;
            currentSpeedMultiplier = speedLevels[currentSpeedIndex];
            updateSpeedBtn();
        }

        function updateSpeedBtn() {
            const ffBtn = document.getElementById('fastForwardBtn');
            ffBtn.classList.remove('speed-2x', 'speed-4x');

            if (currentSpeedMultiplier === 1) {
                ffBtn.textContent = '‚ñ∂'; // 1ÂÄç„ÅØ1„Å§
            } else if (currentSpeedMultiplier === 2) {
                ffBtn.textContent = '‚ñ∂‚ñ∂'; // 2ÂÄç„ÅØ2„Å§
                ffBtn.classList.add('speed-2x');
            } else if (currentSpeedMultiplier === 4) {
                ffBtn.textContent = '‚ñ∂‚ñ∂‚ñ∂'; // 4ÂÄç„ÅØ3„Å§
                ffBtn.classList.add('speed-4x');
            }
        }

        function resetSpeed() {
            currentSpeedIndex = 0;
            currentSpeedMultiplier = speedLevels[0];
            updateSpeedBtn();
        }

        function showFastForwardBtn() {
            document.getElementById('fastForwardBtn').classList.add('visible');
        }

        window.onload = () => {
            setTimeout(() => {
                document.getElementById('splashScreen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('splashScreen').style.display = 'none';
                    showScreen('menuScreen');
                }, 500);
            }, 1200);

            // ÂàùÊúüÁä∂ÊÖã„Çíhistory„Å´ËøΩÂä†
            history.replaceState({ screen: 'menuScreen' }, '', '');
        };

        // „Çπ„Éû„Éõ„ÅÆ„Éê„ÉÉ„ÇØ„Éú„Çø„É≥ÂØæÂøú
        window.addEventListener('popstate', (event) => {
            // „Çµ„Ç§„Éâ„É°„Éã„É•„Éº„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Çå„Å∞Èñâ„Åò„Çã
            if (document.getElementById('sideMenu').classList.contains('open')) {
                closeMenu();
                // Â±•Ê≠¥„ÇíÊàª„Åï„Å™„ÅÑ„Çà„ÅÜ„Å´ÂÜçÂ∫¶pushState
                history.pushState({ screen: screenHistory[screenHistory.length - 1] }, '', '');
                return;
            }

            if (screenHistory.length > 1) {
                screenHistory.pop(); // ÁèæÂú®„ÅÆÁîªÈù¢„ÇíÂâäÈô§
                const prevScreen = screenHistory[screenHistory.length - 1];

                // „Ç≤„Éº„É†ÁîªÈù¢„Åã„ÇâÊàª„ÇãÂ†¥Âêà„ÅØ„É™„Çª„ÉÉ„Éà
                if (prevScreen === 'menuScreen' || prevScreen === 'setupScreen') {
                    isAnimating = false;
                    if (animationId) cancelAnimationFrame(animationId);
                    // BGM„Å®ÁßªÂãïÈü≥„ÇíÂÅúÊ≠¢
                    stopBgm();
                    stopMoveSound();
                }

                showScreen(prevScreen, false);
            } else {
                // ÊúÄÂàù„ÅÆÁîªÈù¢„Å™„ÇâÂ±•Ê≠¥„ÇíÊàª„ÅôÔºà„Ç¢„Éó„É™ÁµÇ‰∫Ü„Å™„Å©Ôºâ
                history.back();
            }
        });

        // ÁîªÈù¢Â±•Ê≠¥„ÇíÁÆ°ÁêÜ
        let screenHistory = ['menuScreen'];

        function showScreen(id, addToHistory = true) {
            screens.forEach(s => document.getElementById(s).style.display = 'none');
            const el = document.getElementById(id);
            el.style.display = (id === 'menuScreen') ? 'flex' : 'block';

            // „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„Çí„É™„Çª„ÉÉ„Éà
            window.scrollTo(0, 0);

            // Â±•Ê≠¥„Å´ËøΩÂä†
            if (addToHistory && screenHistory[screenHistory.length - 1] !== id) {
                screenHistory.push(id);
                // „Éñ„É©„Ç¶„Ç∂Â±•Ê≠¥„Å´„ÇÇËøΩÂä†
                history.pushState({ screen: id }, '', '');
            }

            // „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁîªÈù¢„ÅÆBGMÂà∂Âæ°
            if (id === 'setupScreen') {
                startSetupBgm();
            } else {
                stopSetupBgm();
            }

            // „Éò„ÉÉ„ÉÄ„Éº„ÇíÊõ¥Êñ∞
            updateHeader(id);
        }

        function updateHeader(screenId) {
            const backBtn = document.getElementById('backBtn');
            const resetBtn = document.getElementById('resetBtn');
            const headerTitle = document.getElementById('headerTitle');

            // Êàª„Çã„Éú„Çø„É≥„ÅÆË°®Á§∫/ÈùûË°®Á§∫Ôºà„É°„Éã„É•„ÉºÁîªÈù¢„Å®„Åµ„Å§„ÅÜ„ÅÆ„ÅÇ„Åø„Å†„É¢„Éº„Éâ„Åß„ÅØÈùûË°®Á§∫Ôºâ
            if (screenId === 'menuScreen' || currentMode === 'normal') {
                backBtn.classList.add('hidden');
            } else {
                backBtn.classList.remove('hidden');
            }

            // „É™„Çª„ÉÉ„Éà„Éú„Çø„É≥„ÅÆË°®Á§∫/ÈùûË°®Á§∫
            if (screenId === 'gameScreen') {
                resetBtn.classList.remove('hidden');
            } else {
                resetBtn.classList.add('hidden');
            }

            // „Çø„Ç§„Éà„É´Êõ¥Êñ∞
            switch(screenId) {
                case 'menuScreen':
                    headerTitle.textContent = 'Á•û„ÅÇ„Åø„Å†';
                    break;
                case 'setupScreen':
                    headerTitle.textContent = currentMode === 'normal' ? '„Åµ„Å§„ÅÜ„ÅÆ„ÅÇ„Åø„Å†' : 'ÂãïÁâ©„É¨„Éº„Çπ';
                    break;
                case 'gameScreen':
                    headerTitle.textContent = currentMode === 'normal' ? '„Åµ„Å§„ÅÜ„ÅÆ„ÅÇ„Åø„Å†' : 'ÂãïÁâ©„É¨„Éº„Çπ';
                    break;
            }
        }

        function goBack() {
            if (screenHistory.length > 1) {
                screenHistory.pop(); // ÁèæÂú®„ÅÆÁîªÈù¢„ÇíÂâäÈô§
                const prevScreen = screenHistory[screenHistory.length - 1];

                // „Ç≤„Éº„É†ÁîªÈù¢„Åã„ÇâÊàª„ÇãÂ†¥Âêà„ÅØ„É™„Çª„ÉÉ„Éà
                if (prevScreen === 'menuScreen' || prevScreen === 'setupScreen') {
                    isAnimating = false;
                    if (animationId) cancelAnimationFrame(animationId);
                    // BGM„Å®ÁßªÂãïÈü≥„ÇíÂÅúÊ≠¢
                    stopBgm();
                    stopMoveSound();
                }

                showScreen(prevScreen, false);
            }
        }

        function openMenu() {
            document.getElementById('menuOverlay').classList.add('open');
            document.getElementById('sideMenu').classList.add('open');
        }

        function closeMenu() {
            document.getElementById('menuOverlay').classList.remove('open');
            document.getElementById('sideMenu').classList.remove('open');
        }

        function openSettings() {
            closeMenu();
            // ÁèæÂú®„ÅÆË®≠ÂÆö„ÇíÂèçÊò†
            document.querySelector(`input[name="blindMode"][value="${blindMode}"]`).checked = true;
            document.getElementById('settingsOverlay').classList.add('open');
        }

        // „Ç´„Çπ„Çø„É†Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞
        let confirmCallback = null;
        let confirmCancelCallback = null;
        let pendingBlindMode = null;

        function showConfirm(message, onOk, onCancel, icon = '‚ö†Ô∏è', okText = 'OK', cancelText = '„Ç≠„É£„É≥„Çª„É´') {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmIcon').textContent = icon;
            document.getElementById('confirmOkBtn').textContent = okText;
            document.getElementById('confirmCancelBtn').textContent = cancelText;
            confirmCallback = onOk;
            confirmCancelCallback = onCancel || null;
            document.getElementById('confirmOverlay').classList.add('open');
        }

        function confirmOk() {
            document.getElementById('confirmOverlay').classList.remove('open');
            if (confirmCallback) {
                confirmCallback();
                confirmCallback = null;
            }
            confirmCancelCallback = null;
        }

        function confirmCancel() {
            document.getElementById('confirmOverlay').classList.remove('open');
            if (confirmCancelCallback) {
                confirmCancelCallback();
            }
            // „Ç≠„É£„É≥„Çª„É´ÊôÇ„ÅØÂÖÉ„Å´Êàª„Åô
            if (pendingBlindMode !== null) {
                document.querySelector(`input[name="blindMode"][value="${blindMode}"]`).checked = true;
                pendingBlindMode = null;
            }
            confirmCallback = null;
            confirmCancelCallback = null;
        }

        // Ë®≠ÂÆöÁîªÈù¢„ÅÆ„É¢„Éº„ÉâÈÅ∏Êäû„Ç§„Éô„É≥„Éà„ÇíË®≠ÂÆö
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.settings-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    const newMode = option.dataset.mode;
                    // „Ç≤„Éº„É†ÁîªÈù¢„Åß„É¢„Éº„Éâ„ÇíÂ§âÊõ¥„Åó„Çà„ÅÜ„Å®„Åó„ÅüÂ†¥Âêà
                    if (newMode !== blindMode && document.getElementById('gameScreen').style.display !== 'none') {
                        e.preventDefault();
                        pendingBlindMode = newMode;
                        showConfirm('„É¢„Éº„Éâ„ÇíÂ§âÊõ¥„Åô„Çã„Å®\n„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åô„ÄÇ\n\nÂ§âÊõ¥„Åó„Åæ„Åô„ÅãÔºü', () => {
                            blindMode = newMode;
                            document.querySelector(`input[name="blindMode"][value="${newMode}"]`).checked = true;
                            document.getElementById('settingsOverlay').classList.remove('open');
                            shuffleLadders();
                            pendingBlindMode = null;
                        }, () => {
                            // „Ç≠„É£„É≥„Çª„É´ÊôÇ
                            document.querySelector(`input[name="blindMode"][value="${blindMode}"]`).checked = true;
                            pendingBlindMode = null;
                        });
                    }
                });
            });
        });

        function closeSettings() {
            // „Ç≤„Éº„É†ÁîªÈù¢‰ª•Â§ñ„Åß„ÅØÁõ¥Êé•ÈÅ©Áî®
            const selected = document.querySelector('input[name="blindMode"]:checked');
            if (selected && document.getElementById('gameScreen').style.display === 'none') {
                blindMode = selected.value;
            }
            document.getElementById('settingsOverlay').classList.remove('open');
        }

        function goHomeFromMenu() {
            closeMenu();
            isAnimating = false;
            if (animationId) cancelAnimationFrame(animationId);
            players = [];
            ladders = [];
            screenHistory = ['menuScreen'];
            stopBgm();
            // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ©Áî®„ÇíÂàùÊúüÂåñ
            activeTemplateGenre = null;
            activeTemplateSub = null;
            updateActiveTemplateBadge();
            showScreen('menuScreen', false);
        }

        function goHome() {
            isAnimating = false;
            if (animationId) cancelAnimationFrame(animationId);
            players = [];
            ladders = [];
            screenHistory = ['menuScreen'];
            stopBgm();
            // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ©Áî®„ÇíÂàùÊúüÂåñ
            activeTemplateGenre = null;
            activeTemplateSub = null;
            updateActiveTemplateBadge();
            showScreen('menuScreen', false);
        }

        // =========================================
        // ‰∫∫Êï∞ÈÅ∏Êäû„Ç´„É´„Éº„Çª„É´
        // =========================================
        const playerCountOptions = [2, 3, 4, 5, 6, 7, 8];
        let currentCarouselIndex = 1; // „Éá„Éï„Ç©„É´„Éà„ÅØ3‰∫∫Ôºà„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ1Ôºâ
        let carouselTouchStartX = 0;
        let carouselTouchEndX = 0;

        function openPlayerSelect() {
            currentCarouselIndex = 1; // 3‰∫∫„Å´„É™„Çª„ÉÉ„Éà
            initCarousel();
            document.getElementById('playerSelectOverlay').classList.add('open');
        }

        function closePlayerSelect(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('playerSelectOverlay').classList.remove('open');
        }

        function initCarousel() {
            const track = document.getElementById('carouselTrack');
            const indicator = document.getElementById('carouselIndicator');

            // „Ç´„É´„Éº„Çª„É´„Ç¢„Ç§„ÉÜ„É†ÁîüÊàê
            track.innerHTML = '';
            playerCountOptions.forEach((count, index) => {
                const item = document.createElement('div');
                item.className = 'carousel-item' + (index === currentCarouselIndex ? ' active' : '');
                item.innerHTML = `<span class="number">${count}</span><span class="label">‰∫∫</span>`;
                item.onclick = () => goToCarouselItem(index);
                track.appendChild(item);
            });

            // „Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÁîüÊàê
            indicator.innerHTML = '';
            playerCountOptions.forEach((_, index) => {
                const dot = document.createElement('div');
                dot.className = 'carousel-dot' + (index === currentCarouselIndex ? ' active' : '');
                dot.onclick = () => goToCarouselItem(index);
                indicator.appendChild(dot);
            });

            updateCarouselPosition();

            // „Çπ„ÉØ„Ç§„ÉóÂØæÂøú
            track.addEventListener('touchstart', handleCarouselTouchStart, { passive: true });
            track.addEventListener('touchend', handleCarouselTouchEnd, { passive: true });
        }

        function handleCarouselTouchStart(e) {
            carouselTouchStartX = e.touches[0].clientX;
        }

        function handleCarouselTouchEnd(e) {
            carouselTouchEndX = e.changedTouches[0].clientX;
            const diff = carouselTouchStartX - carouselTouchEndX;
            if (Math.abs(diff) > 50) {
                if (diff > 0) {
                    carouselNext();
                } else {
                    carouselPrev();
                }
            }
        }

        function carouselPrev() {
            if (currentCarouselIndex > 0) {
                currentCarouselIndex--;
                updateCarouselPosition();
            }
        }

        function carouselNext() {
            if (currentCarouselIndex < playerCountOptions.length - 1) {
                currentCarouselIndex++;
                updateCarouselPosition();
            }
        }

        function goToCarouselItem(index) {
            currentCarouselIndex = index;
            updateCarouselPosition();
        }

        function updateCarouselPosition() {
            const track = document.getElementById('carouselTrack');
            const items = track.querySelectorAll('.carousel-item');
            const dots = document.querySelectorAll('.carousel-dot');
            const angleStep = 360 / playerCountOptions.length;
            const radius = 140;

            items.forEach((item, index) => {
                const angle = (index - currentCarouselIndex) * angleStep;
                const rad = angle * Math.PI / 180;
                const x = Math.sin(rad) * radius;
                const z = Math.cos(rad) * radius - radius;
                const scale = (z + radius * 2) / (radius * 2) * 0.5 + 0.5;
                const opacity = index === currentCarouselIndex ? 1 : 0.5;

                item.style.transform = `translateX(${x}px) translateZ(${z}px) scale(${scale})`;
                item.style.opacity = opacity;
                item.style.zIndex = Math.round(scale * 10);
                item.classList.toggle('active', index === currentCarouselIndex);
            });

            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentCarouselIndex);
            });
        }

        function confirmPlayerCount() {
            const playerCount = playerCountOptions[currentCarouselIndex];
            closePlayerSelect();

            // race „É¢„Éº„Éâ„ÅßÈÅ∏Êäû„Åó„Åü‰∫∫Êï∞ÂàÜ„ÅÆ„Çπ„É≠„ÉÉ„Éà„Çí‰ΩúÊàê
            currentMode = 'race';
            document.getElementById('listTitle').innerText = 'ÂèÇÂä†ËÄÖ„ÇíÂÖ•Âäõ';
            document.getElementById('templateTriggerBtn').style.display = 'none';

            const list = document.getElementById('goalList');
            list.innerHTML = '';

            for (let i = 0; i < playerCount; i++) {
                addGoalItem();
            }

            showScreen('setupScreen');
        }

        // =========================================
        // ÂãïÁâ©„É¨„Éº„ÇπÂ∞ÇÁî®Ê©üËÉΩ
        // =========================================
        const animalList = [
            { emoji: 'üê∞', name: '„ÅÜ„Åï„Åé' },
            { emoji: 'üê±', name: '„Å≠„Åì' },
            { emoji: 'üê∂', name: '„ÅÑ„Å¨' },
            { emoji: 'üêª', name: '„Åè„Åæ' },
            { emoji: 'üêº', name: '„Éë„É≥„ÉÄ' },
            { emoji: 'ü¶ä', name: '„Åç„Å§„Å≠' },
            { emoji: 'üêØ', name: '„Å®„Çâ' },
            { emoji: 'ü¶Å', name: '„É©„Ç§„Ç™„É≥' },
            { emoji: 'üê∏', name: '„Åã„Åà„Çã' },
            { emoji: 'üêµ', name: '„Åï„Çã' },
            { emoji: 'üêß', name: '„Éö„É≥„ÇÆ„É≥' },
            { emoji: 'üê¶', name: '„Å®„Çä' },
            { emoji: 'üê¢', name: '„Åã„ÇÅ' },
            { emoji: 'üêç', name: '„Å∏„Å≥' },
            { emoji: 'ü¶Ñ', name: '„É¶„Éã„Ç≥„Éº„É≥' }
        ];

        const randomNames = [
            '„ÅØ„ÇÑ„Å¶', '„Å≤„Åã„Çä', '„Å§„Å∞„Åï', '„Åù„Çâ', '„ÇÜ„ÇÅ',
            '„Åª„Åó', '„Åã„Åú', '„ÅÜ„Åø', '„ÇÑ„Åæ', '„ÇÇ„Çä',
            '„Åü„ÅÑ„Çà„ÅÜ', '„Å§„Åç', '„Å´„Åò', '„Åè„ÇÇ', '„ÅÇ„ÇÅ',
            '„Åï„Åè„Çâ', '„ÇÇ„ÇÇ', '„Çä„Çì', '„ÅÇ„Åä„ÅÑ', '„Åø„Å©„Çä'
        ];

        let raceCharacters = []; // {id, animal, name, selected}
        let selectedAnimalEmoji = null;
        let editingCharacterId = null;
        let raceGoals = [];
        let startLineAssignments = []; // {lineIndex, character}

        function openRaceSetup() {
            currentMode = 'race';
            // „Ç≠„É£„É©„ÇØ„Çø„Éº„ÅØÁ∂≠ÊåÅÔºà„É™„Çª„ÉÉ„Éà„Åó„Å™„ÅÑÔºâ
            selectedAnimalEmoji = null;
            renderCharacterList();
            updateParticipantCount();
            showScreen('raceSetupScreen');
        }

        // „Ç≠„É£„É©„ÇØ„Çø„ÉºËøΩÂä†„É¢„Éº„ÉÄ„É´
        function openCharacterModal(editId = null) {
            editingCharacterId = editId;
            selectedAnimalEmoji = null;

            if (editId !== null) {
                const char = raceCharacters.find(c => c.id === editId);
                if (char) {
                    selectedAnimalEmoji = char.animal;
                    document.getElementById('characterNameInput').value = char.name;
                    document.getElementById('characterModalTitle').textContent = '„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÁ∑®ÈõÜ';
                }
            } else {
                document.getElementById('characterNameInput').value = '';
                document.getElementById('characterModalTitle').textContent = '„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíËøΩÂä†';
            }

            renderAnimalGrid();
            updateCharacterConfirmBtn();
            document.getElementById('characterModal').classList.add('open');
        }

        function closeCharacterModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('characterModal').classList.remove('open');
            editingCharacterId = null;
        }

        function renderAnimalGrid() {
            const grid = document.getElementById('animalGrid');
            const usedAnimals = raceCharacters
                .filter(c => editingCharacterId === null || c.id !== editingCharacterId)
                .map(c => c.animal);

            grid.innerHTML = animalList.map(animal => {
                const isUsed = usedAnimals.includes(animal.emoji);
                const isSelected = selectedAnimalEmoji === animal.emoji;
                return `<div class="animal-option ${isSelected ? 'selected' : ''} ${isUsed ? 'used' : ''}"
                            onclick="selectAnimal('${animal.emoji}')">${animal.emoji}</div>`;
            }).join('');
        }

        function selectAnimal(emoji) {
            selectedAnimalEmoji = emoji;
            renderAnimalGrid();
            updateCharacterConfirmBtn();
        }

        function setRandomName() {
            // ÂêçÂâç„Çí„É©„É≥„ÉÄ„É†ÈÅ∏Êäû
            const name = randomNames[Math.floor(Math.random() * randomNames.length)];
            document.getElementById('characterNameInput').value = name;

            // „Ç¢„Ç§„Ç≥„É≥„ÅåÊú™ÈÅ∏Êäû„ÅÆÂ†¥Âêà„ÅØ„ÄÅ‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Ç¢„Ç§„Ç≥„É≥„Åã„Çâ„É©„É≥„ÉÄ„É†ÈÅ∏Êäû
            if (!selectedAnimalEmoji) {
                const usedAnimals = raceCharacters
                    .filter(c => editingCharacterId === null || c.id !== editingCharacterId)
                    .map(c => c.animal);
                const availableAnimals = animalList.filter(a => !usedAnimals.includes(a.emoji));

                if (availableAnimals.length > 0) {
                    const randomAnimal = availableAnimals[Math.floor(Math.random() * availableAnimals.length)];
                    selectedAnimalEmoji = randomAnimal.emoji;
                    renderAnimalGrid();
                }
            }

            updateCharacterConfirmBtn();
        }

        function updateCharacterConfirmBtn() {
            const name = document.getElementById('characterNameInput').value.trim();
            const btn = document.getElementById('characterConfirmBtn');
            btn.disabled = !selectedAnimalEmoji || !name;
        }

        document.getElementById('characterNameInput')?.addEventListener('input', updateCharacterConfirmBtn);

        function confirmCharacter() {
            const name = document.getElementById('characterNameInput').value.trim();
            if (!selectedAnimalEmoji || !name) return;

            if (editingCharacterId !== null) {
                // Á∑®ÈõÜ„É¢„Éº„Éâ
                const char = raceCharacters.find(c => c.id === editingCharacterId);
                if (char) {
                    char.animal = selectedAnimalEmoji;
                    char.name = name;
                }
            } else {
                // Êñ∞Ë¶èËøΩÂä†
                raceCharacters.push({
                    id: Date.now(),
                    animal: selectedAnimalEmoji,
                    name: name,
                    selected: false
                });
            }

            closeCharacterModal();
            renderCharacterList();
            updateParticipantCount();
        }

        function renderCharacterList() {
            const list = document.getElementById('characterList');
            list.innerHTML = raceCharacters.map(char => `
                <div class="character-item ${char.selected ? 'selected' : ''}" data-id="${char.id}">
                    <div class="delete-bg">ÂâäÈô§</div>
                    <div class="character-avatar">${char.animal}</div>
                    <div class="character-info">
                        <div class="character-name">${char.name}</div>
                        <div class="character-animal">${getAnimalName(char.animal)}</div>
                    </div>
                    <button class="char-edit-btn" data-id="${char.id}">‚úèÔ∏è</button>
                    <button class="char-delete-btn" data-id="${char.id}">üóëÔ∏è</button>
                </div>
            `).join('');

            // „ÇØ„É™„ÉÉ„ÇØ„ÅßÈÅ∏Êäû/Ëß£Èô§
            list.querySelectorAll('.character-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // „Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅØÈô§Â§ñ
                    if (e.target.closest('.char-edit-btn') || e.target.closest('.char-delete-btn')) return;
                    const id = parseInt(item.dataset.id);
                    toggleCharacterSelection(id);
                });
            });

            // Á∑®ÈõÜ„Éú„Çø„É≥
            list.querySelectorAll('.char-edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = parseInt(btn.dataset.id);
                    openCharacterModal(id);
                });
            });

            // ÂâäÈô§„Éú„Çø„É≥
            list.querySelectorAll('.char-delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = parseInt(btn.dataset.id);
                    const item = btn.closest('.character-item');
                    deleteCharacterWithAnimation(item, id);
                });
            });
        }

        function getAnimalName(emoji) {
            const animal = animalList.find(a => a.emoji === emoji);
            return animal ? animal.name : '';
        }

        function deleteCharacterWithAnimation(item, id) {
            item.style.transform = 'translateX(-100%)';
            item.style.opacity = '0';
            setTimeout(() => {
                raceCharacters = raceCharacters.filter(c => c.id !== id);
                renderCharacterList();
                updateParticipantCount();
            }, 200);
        }

        function toggleCharacterSelection(id) {
            const char = raceCharacters.find(c => c.id === id);
            if (!char) return;

            const selectedCount = raceCharacters.filter(c => c.selected).length;

            if (char.selected) {
                char.selected = false;
            } else if (selectedCount < 8) {
                char.selected = true;
            }

            renderCharacterList();
            updateParticipantCount();
        }

        function updateParticipantCount() {
            const count = raceCharacters.filter(c => c.selected).length;
            document.getElementById('participantCount').textContent = count;
            document.getElementById('raceNextBtn').disabled = count < 2;
        }

        // „Ç¥„Éº„É´ÈÅ∏ÊäûËÇ¢ÁîªÈù¢
        function goToRaceGoalScreen() {
            const selectedCount = raceCharacters.filter(c => c.selected).length;
            document.getElementById('minGoalCount').textContent = selectedCount;

            raceGoals = [];
            const goalList = document.getElementById('raceGoalList');
            goalList.innerHTML = '';

            // ÈÅ∏Êäû‰∫∫Êï∞ÂàÜ„ÅÆÁ©∫Ê¨Ñ„Çí‰ΩúÊàê
            for (let i = 0; i < selectedCount; i++) {
                addRaceGoalItem();
            }

            showScreen('raceGoalScreen');
        }

        function addRaceGoalItem() {
            const goalList = document.getElementById('raceGoalList');
            const index = goalList.children.length;
            if (index >= 8) return;

            const item = document.createElement('div');
            item.className = 'race-goal-item';
            item.innerHTML = `
                <div class="race-goal-index">${index + 1}</div>
                <input type="text" class="race-goal-input" placeholder="ÈÅ∏ÊäûËÇ¢„ÇíÂÖ•Âäõ" maxlength="20"
                       oninput="updateRaceGoalBtn()">
            `;

            // „Çπ„ÉØ„Ç§„ÉóÂâäÈô§
            item.addEventListener('touchstart', (e) => raceGoalTouchStart(e, item));
            item.addEventListener('touchmove', (e) => raceGoalTouchMove(e, item));
            item.addEventListener('touchend', (e) => raceGoalTouchEnd(e, item));

            goalList.appendChild(item);
            updateRaceGoalBtn();

            if (goalList.children.length >= 8) {
                document.getElementById('raceAddGoalBtn').style.display = 'none';
            }
        }

        let goalTouchStartX = 0;
        let goalTouchCurrentX = 0;

        function raceGoalTouchStart(e, item) {
            goalTouchStartX = e.touches[0].clientX;
            goalTouchCurrentX = goalTouchStartX;
        }

        function raceGoalTouchMove(e, item) {
            goalTouchCurrentX = e.touches[0].clientX;
            const diff = goalTouchStartX - goalTouchCurrentX;
            if (diff > 10) {
                const translateX = Math.min(0, Math.max(-80, -diff));
                item.style.transform = `translateX(${translateX}px)`;
            }
        }

        function raceGoalTouchEnd(e, item) {
            const diff = goalTouchStartX - goalTouchCurrentX;
            const minCount = raceCharacters.filter(c => c.selected).length;
            const currentCount = document.getElementById('raceGoalList').children.length;

            if (diff > 80 && currentCount > minCount) {
                item.style.transform = 'translateX(-100%)';
                item.style.opacity = '0';
                setTimeout(() => {
                    item.remove();
                    reindexRaceGoals();
                    updateRaceGoalBtn();
                    document.getElementById('raceAddGoalBtn').style.display = 'flex';
                }, 200);
            } else {
                item.style.transform = '';
            }
        }

        function reindexRaceGoals() {
            const items = document.getElementById('raceGoalList').children;
            Array.from(items).forEach((item, i) => {
                item.querySelector('.race-goal-index').textContent = i + 1;
            });
        }

        function updateRaceGoalBtn() {
            const inputs = document.querySelectorAll('.race-goal-input');
            const minCount = raceCharacters.filter(c => c.selected).length;
            let filledCount = 0;

            inputs.forEach(input => {
                if (input.value.trim()) filledCount++;
            });

            document.getElementById('raceStartSetupBtn').disabled = filledCount < minCount;
        }

        // „Çπ„Çø„Éº„Éà„É©„Ç§„É≥ÈÖçÁΩÆÔºà„Ç≤„Éº„É†ÁîªÈù¢ÂÜÖ„ÅßÂÆüË°åÔºâ
        function goToStartLineScreen() {
            const selectedChars = raceCharacters.filter(c => c.selected);
            const goalInputs = document.querySelectorAll('.race-goal-input');

            raceGoals = Array.from(goalInputs)
                .map(input => input.value.trim())
                .filter(v => v);

            // „Ç¥„Éº„É´„ÇígoalList„Å´Ë®≠ÂÆö
            goalList = raceGoals;

            // ÈÖçÁΩÆÁî®„ÅÆÈÖçÂàó„ÇíÂàùÊúüÂåñ
            startLineAssignments = new Array(selectedChars.length).fill(null);
            raceSelectedChars = selectedChars;

            // „Ç≤„Éº„É†ÁîªÈù¢„Å´ÈÅ∑Áßª„Åó„Å¶„ÅÇ„Åø„Å†„Åè„Åò„ÇíÊèèÁîª
            showScreen('gameScreen');
            setTimeout(() => {
                drawAmidakujiForRace();
            }, 100);
        }

        // „É¨„Éº„Çπ„É¢„Éº„ÉâÁî®„ÅÆ„ÅÇ„Åø„Å†„Åè„ÅòÊèèÁîªÈñ¢Êï∞
        function drawAmidakujiForRace() {
            const count = goalList.length;
            if (count < 2) return;

            currentMode = 'race';
            startedPlayerCount = 0;

            // BGMÈñãÂßã
            startBgm();

            dpr = window.devicePixelRatio || 1;
            let cssWidth = document.body.clientWidth;
            let cssHeight = window.innerHeight * 3.0;

            canvas.width = cssWidth * dpr;
            canvas.height = cssHeight * dpr;
            canvas.style.width = cssWidth + 'px';
            canvas.style.height = cssHeight + 'px';

            ctx.scale(dpr, dpr);

            let logicalWidth = cssWidth;
            let logicalHeight = cssHeight;

            columnWidth = logicalWidth / count;

            let baseSteps = 50;
            const extraSteps = (count - 2) * 5;
            const steps = baseSteps + extraSteps;

            const ladderHeight = logicalHeight - topMargin - 250;
            stepHeight = ladderHeight / steps;

            // „É¨„Éº„Çπ„É¢„Éº„Éâ„Åß„ÅØ„Ç´„Éº„ÉÜ„É≥„Å™„Åó
            const curtain = document.getElementById('curtain');
            curtain.style.opacity = 0;

            createLadders(count, steps);

            players = [];

            // „Ç¥„Éº„É´„É©„Éô„É´„Çí„Ç∑„É£„ÉÉ„Éï„É´
            shuffledGoalLabels = shuffleArray([...goalList]);
            goalLabels = shuffledGoalLabels;

            const FIXED_MAX_COLUMNS = 8;
            const rawSize = Math.floor((window.innerWidth - 10) / FIXED_MAX_COLUMNS);
            const calculatedSize = Math.floor(rawSize * 0.9);

            const btnLayer = document.getElementById('buttonLayer');
            btnLayer.innerHTML = '';

            for(let i=0; i<count; i++) {
                let startX = (i * columnWidth) + (columnWidth / 2);

                players.push({
                    id: i,
                    xIdx: i,
                    y: topMargin,
                    nextXIdx: undefined,
                    moveProgress: 0,
                    state: 'idle',
                    hasTurnedAtLevel: -1,
                    scale: 0,
                    currentSpeed: 6.3,

                    sliding: false,
                    slideTargetX: 0,
                    slideTargetY: 0,
                    slideStartX: 0,
                    slideStartY: 0,

                    reactedEndpoints: new Set(),
                    cameFromCurve: false,
                    curveExitY: undefined,

                    char: characters[i],
                    color: colors[i],
                    trail: [{x: startX, y: topMargin}, {x: startX, y: topMargin}]
                });
            }

            // „Çø„É≥„ÇØ„ÇíÁîüÊàê
            createTanks(count, logicalHeight);

            const raceBtn = document.getElementById('raceBtn');
            raceBtn.style.display = 'block';
            raceBtn.disabled = true; // ÈÖçÁΩÆÂÆå‰∫Ü„Åæ„ÅßÁÑ°Âäπ

            // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÇíÁîüÊàê
            createDropZones(count, columnWidth, topMargin);

            // Êó©ÈÄÅ„Çä„Éú„Çø„É≥„ÇíË°®Á§∫ÔºàÈÄüÂ∫¶„É™„Çª„ÉÉ„ÉàÔºâ
            resetSpeed();
            showFastForwardBtn();

            drawFrame();

            window.scrollTo({ top: document.body.scrollHeight, behavior: 'instant' });
            setTimeout(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });

                // „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÖçÁΩÆUI„ÇíË°®Á§∫
                if (raceSelectedChars.length > 0) {
                    setTimeout(() => {
                        showCharPlacementUI();
                    }, 500);
                }
            }, 800);
        }

        let raceSelectedChars = [];
        let placementDragId = null;
        let placementGhost = null;

        // „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÖçÁΩÆUI„ÇíË°®Á§∫
        function showCharPlacementUI() {
            const container = document.getElementById('placementChars');
            container.innerHTML = raceSelectedChars.map(char => {
                const isPlaced = startLineAssignments.includes(char);
                return `
                    <div class="placement-char ${isPlaced ? 'placed' : ''}" data-id="${char.id}">
                        <div class="char-avatar">${char.animal}</div>
                        <div class="char-name">${char.name}</div>
                    </div>
                `;
            }).join('');

            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
            container.querySelectorAll('.placement-char:not(.placed)').forEach(el => {
                const id = parseInt(el.dataset.id);

                // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„Éà
                el.addEventListener('touchstart', (e) => placementDragStart(e, id, el), { passive: false });
                el.addEventListener('touchmove', (e) => placementDragMove(e), { passive: false });
                el.addEventListener('touchend', (e) => placementDragEnd(e, id));

                // „Éû„Ç¶„Çπ„Ç§„Éô„É≥„Éà
                el.addEventListener('mousedown', (e) => placementMouseStart(e, id, el));
            });

            document.getElementById('charPlacementUI').classList.add('show');
        }

        function hideCharPlacementUI() {
            document.getElementById('charPlacementUI').classList.remove('show');
        }

        // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÇíÁîüÊàê
        function createDropZones(count, columnWidth, topMargin) {
            const dropLayer = document.getElementById('dropZoneLayer');
            dropLayer.innerHTML = '';
            dropLayer.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                pointer-events: none;
            `;

            const zoneHeight = 70;

            for (let i = 0; i < count; i++) {
                const zone = document.createElement('div');
                zone.className = 'start-drop-zone';
                zone.dataset.index = i;
                zone.style.cssText = `
                    left: ${(i * columnWidth) + (columnWidth / 2) - 35}px;
                    top: ${topMargin - zoneHeight - 10}px;
                    width: 70px;
                    height: ${zoneHeight}px;
                    pointer-events: auto;
                `;
                zone.innerHTML = `<span class="zone-label">„É¨„Éº„É≥${i + 1}</span>`;
                dropLayer.appendChild(zone);
            }
        }

        // „Éâ„É©„ÉÉ„Ç∞ÈñãÂßãÔºà„Çø„ÉÉ„ÉÅÔºâ
        function placementDragStart(e, id, el) {
            e.preventDefault();
            placementDragId = id;
            const touch = e.touches[0];
            createPlacementGhost(id, touch.clientX, touch.clientY);
            el.style.opacity = '0.3';
            highlightDropZones(true);
        }

        // „Éâ„É©„ÉÉ„Ç∞ÁßªÂãïÔºà„Çø„ÉÉ„ÉÅÔºâ
        function placementDragMove(e) {
            if (!placementGhost) return;
            e.preventDefault();
            const touch = e.touches[0];
            updatePlacementGhost(touch.clientX, touch.clientY);
            checkDropZoneHover(touch.clientX, touch.clientY);
        }

        // „Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫ÜÔºà„Çø„ÉÉ„ÉÅÔºâ
        function placementDragEnd(e, id) {
            if (placementGhost) {
                const touch = e.changedTouches[0];
                const dropZone = findDropZoneAt(touch.clientX, touch.clientY);
                if (dropZone) {
                    const zoneIndex = parseInt(dropZone.dataset.index);
                    placeCharacterInZone(id, zoneIndex);
                }
                placementGhost.remove();
                placementGhost = null;
            }
            highlightDropZones(false);
            placementDragId = null;

            // ÂÖÉ„ÅÆË¶ÅÁ¥†„ÇíÊàª„Åô
            document.querySelectorAll('.placement-char').forEach(el => el.style.opacity = '1');
            showCharPlacementUI(); // UI„ÇíÊõ¥Êñ∞
            updateDropZoneDisplay();
            checkAllPlaced();
        }

        // „Éû„Ç¶„Çπ„Éâ„É©„ÉÉ„Ç∞
        function placementMouseStart(e, id, el) {
            placementDragId = id;
            createPlacementGhost(id, e.clientX, e.clientY);
            el.style.opacity = '0.3';
            highlightDropZones(true);

            const moveHandler = (e) => {
                if (!placementGhost) return;
                updatePlacementGhost(e.clientX, e.clientY);
                checkDropZoneHover(e.clientX, e.clientY);
            };

            const upHandler = (e) => {
                if (placementGhost) {
                    const dropZone = findDropZoneAt(e.clientX, e.clientY);
                    if (dropZone) {
                        const zoneIndex = parseInt(dropZone.dataset.index);
                        placeCharacterInZone(id, zoneIndex);
                    }
                    placementGhost.remove();
                    placementGhost = null;
                }
                highlightDropZones(false);
                placementDragId = null;

                document.querySelectorAll('.placement-char').forEach(el => el.style.opacity = '1');
                showCharPlacementUI();
                updateDropZoneDisplay();
                checkAllPlaced();

                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('mouseup', upHandler);
            };

            document.addEventListener('mousemove', moveHandler);
            document.addEventListener('mouseup', upHandler);
        }

        function createPlacementGhost(id, x, y) {
            const char = raceCharacters.find(c => c.id === id);
            placementGhost = document.createElement('div');
            placementGhost.className = 'drag-ghost';
            placementGhost.innerHTML = `
                <div class="char-avatar" style="width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#ffecd2,#fcb69f);display:flex;align-items:center;justify-content:center;font-size:1.8rem;">${char.animal}</div>
                <div class="char-name" style="font-size:0.8rem;font-weight:bold;margin-top:5px;">${char.name}</div>
            `;
            document.body.appendChild(placementGhost);
            updatePlacementGhost(x, y);
        }

        function updatePlacementGhost(x, y) {
            if (placementGhost) {
                placementGhost.style.left = (x - 40) + 'px';
                placementGhost.style.top = (y - 50) + 'px';
            }
        }

        function highlightDropZones(show) {
            document.querySelectorAll('.start-drop-zone').forEach(zone => {
                if (show && !zone.classList.contains('occupied')) {
                    zone.style.borderColor = '#e74c3c';
                } else {
                    zone.style.borderColor = '';
                }
            });
        }

        function checkDropZoneHover(x, y) {
            document.querySelectorAll('.start-drop-zone').forEach(zone => {
                zone.classList.remove('highlight');
            });
            const zone = findDropZoneAt(x, y);
            if (zone) {
                zone.classList.add('highlight');
            }
        }

        function findDropZoneAt(x, y) {
            const elements = document.elementsFromPoint(x, y);
            return elements.find(el => el.classList.contains('start-drop-zone'));
        }

        function placeCharacterInZone(charId, zoneIndex) {
            const char = raceCharacters.find(c => c.id === charId);
            if (!char) return;

            // „Åô„Åß„Å´‰ªñ„ÅÆÂ†¥ÊâÄ„Å´„ÅÑ„Åü„ÇâÂ§ñ„Åô
            const prevIndex = startLineAssignments.indexOf(char);
            if (prevIndex !== -1) {
                startLineAssignments[prevIndex] = null;
            }

            // „Åù„ÅÆ„Çæ„Éº„É≥„Å´Êó¢„Å´„Ç≠„É£„É©„Åå„ÅÑ„Åü„ÇâÂÖ•„ÇåÊõø„Åà
            const existingChar = startLineAssignments[zoneIndex];
            if (existingChar && prevIndex !== -1) {
                startLineAssignments[prevIndex] = existingChar;
            }

            startLineAssignments[zoneIndex] = char;
        }

        // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
        function updateDropZoneDisplay() {
            const zones = document.querySelectorAll('.start-drop-zone');
            zones.forEach((zone, i) => {
                const char = startLineAssignments[i];
                if (char) {
                    zone.classList.add('occupied');
                    zone.innerHTML = `
                        <div class="zone-char">
                            <div class="char-avatar" style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#ffecd2,#fcb69f);display:flex;align-items:center;justify-content:center;font-size:1.4rem;">${char.animal}</div>
                            <div class="char-name" style="font-size:0.7rem;font-weight:bold;margin-top:2px;">${char.name}</div>
                        </div>
                    `;
                } else {
                    zone.classList.remove('occupied');
                    zone.innerHTML = `<span class="zone-label">„É¨„Éº„É≥${i + 1}</span>`;
                }
            });
        }

        // ÂÖ®Âì°ÈÖçÁΩÆ„Åï„Çå„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function checkAllPlaced() {
            const allPlaced = startLineAssignments.every(c => c !== null);
            document.getElementById('raceBtn').disabled = !allPlaced;

            if (allPlaced) {
                hideCharPlacementUI();
            }
        }

        // „É¨„Éº„ÇπÈñãÂßãÊºîÂá∫
        function startRaceCountdown() {
            const overlay = document.getElementById('raceCountdownOverlay');
            const text = document.getElementById('countdownText');
            overlay.classList.add('show');

            const sequence = ['„ÅÑ„Å°„Å´„Å§„ÅÑ„Å¶„Äú', '„Çà„Éº„ÅÑ', '„Éâ„É≥ÔºÅ'];
            let i = 0;

            function showNext() {
                if (i < sequence.length) {
                    text.textContent = sequence[i];
                    text.style.animation = 'none';
                    text.offsetHeight; // reflow
                    text.style.animation = 'countdownPop 0.5s ease-out';
                    i++;
                    setTimeout(showNext, 1000);
                } else {
                    overlay.classList.remove('show');
                    actuallyStartRace();
                }
            }

            showNext();
        }

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ËøΩÂä†
        let raceParticipantNames = [];

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('listTitle').innerText = (mode === 'normal') ? 'ÈÅ∏ÊäûËÇ¢„ÇíÂÖ•Âäõ' : 'ÂèÇÂä†ËÄÖ„ÇíÂÖ•Âäõ';

            // „ÉÜ„É≥„Éó„É¨„Éº„Éà„Éú„Çø„É≥„ÅÆË°®Á§∫/ÈùûË°®Á§∫
            document.getElementById('templateTriggerBtn').style.display = (mode === 'normal') ? 'flex' : 'none';

            const list = document.getElementById('goalList');
            list.innerHTML = '';
            addGoalItem();
            addGoalItem();
            showScreen('setupScreen');
        }

        // „Éó„É™„Çª„ÉÉ„ÉàÈÅ©Áî®
        // ÂãïÁöÑ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åã„Çâ1„Å§„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÁîüÊàê
        function generateDynamicChoice(template, index) {
            const templateFunc = dynamicTemplates[template];
            if (templateFunc) {
                return templateFunc(index);
            }
            return '';
        }

        function applyPreset(presetKey) {
            const genre = presetGenres[currentGenre];
            if (!genre || !genre.items[presetKey]) return;

            const preset = genre.items[presetKey];
            const list = document.getElementById('goalList');
            const currentSlotCount = list.children.length || 2; // ÁèæÂú®„ÅÆÊû†Êï∞ÔºàÊúÄ‰Ωé2Ôºâ

            let items = [];

            if (preset.type === 'dynamic') {
                // Êû†Êï∞„Å´Âêà„Çè„Åõ„Å¶ÂãïÁöÑÁîüÊàê
                const templateFunc = dynamicTemplates[preset.template];
                if (templateFunc) {
                    for (let i = 0; i < currentSlotCount; i++) {
                        items.push(templateFunc(i));
                    }
                }
            } else if (preset.type === 'random') {
                // „Éó„Éº„É´„Åã„Çâ„É©„É≥„ÉÄ„É†ÊäΩÂá∫ÔºàÂùáÁ≠âÁ¢∫ÁéáÔºâ
                items = getRandomChoices(preset.choices, currentSlotCount);
            } else if (preset.type === 'fixed') {
                // Âõ∫ÂÆöÈÅ∏ÊäûËÇ¢
                items = [...preset.choices];
            }

            list.innerHTML = '';

            items.forEach((item, i) => {
                if (i < MAX_COUNT) {
                    addGoalItem(item);
                }
            });

            checkAddBtn();
        }

        // „É©„É≥„ÉÄ„É†ÈÅ∏ÊäûËÇ¢„ÇíÂèñÂæóÔºàÂùáÁ≠âÁ¢∫Áéá„ÄÅÈáçË§á„Å™„ÅóÔºâ
        function getRandomChoices(pool, count) {
            const result = [];
            const available = [...pool];

            for (let i = 0; i < count && available.length > 0; i++) {
                const idx = Math.floor(Math.random() * available.length);
                result.push(available.splice(idx, 1)[0]);
            }

            return result;
        }

        // „Ç∏„É£„É≥„É´ÈÅ∏Êäû
        function selectGenre(genreKey) {
            currentGenre = genreKey;

            // „Ç∏„É£„É≥„É´„Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.genre-btn').forEach(btn => {
                const btnGenre = btn.dataset.genre;
                const genre = presetGenres[btnGenre];
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = '#333';
                btn.style.borderColor = genre?.color || '#e0e0e0';

                if (btnGenre === genreKey) {
                    btn.classList.add('active');
                    btn.style.background = genre?.color || '#333';
                    btn.style.color = 'white';
                    btn.style.borderColor = genre?.color || '#333';
                }
            });

            // „Çµ„Éñ„Ç´„ÉÜ„Ç¥„É™„ÇíÊõ¥Êñ∞
            renderSubPresets(genreKey);
        }

        // „Çµ„Éñ„Ç´„ÉÜ„Ç¥„É™„ÇíÊèèÁîª
        function renderSubPresets(genreKey) {
            const container = document.getElementById('subPresetContainer');
            container.innerHTML = '';

            const genre = presetGenres[genreKey];
            if (!genre) return;

            Object.keys(genre.items).forEach(key => {
                const item = genre.items[key];
                const btn = document.createElement('button');
                btn.className = 'preset-btn sub-btn';
                btn.textContent = item.label;
                btn.onclick = () => applyPreset(key);
                container.appendChild(btn);
            });

            // „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„Çí„É™„Çª„ÉÉ„Éà
            container.scrollLeft = 0;
        }

        // ÂàùÊúüË°®Á§∫
        document.addEventListener('DOMContentLoaded', () => {
            // „ÉÜ„É≥„Éó„É¨„Éº„Éà„Éë„Éç„É´Áî®„ÅÆÂàùÊúüÂåñ„ÅÆ„Åø
        });

        // =========================================
        // =========================================
        // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊ©üËÉΩÔºàÈÅ∏Êäû/Á∑®ÈõÜ„É¢„Éº„ÉâÂàá„ÇäÊõø„ÅàÔºâ
        // =========================================
        let teNavStack = [];
        let teCurrentView = 'genres';
        let teSelectedGenre = null;
        let teSelectedSub = null;
        let teOpenGenre = null;
        let teEditMode = false; // false: ÈÅ∏Êäû„É¢„Éº„Éâ, true: Á∑®ÈõÜ„É¢„Éº„Éâ

        // „ÅäÊ∞ó„Å´ÂÖ•„Çä„Éá„Éº„Çø
        let favorites = JSON.parse(localStorage.getItem('amidakuji_favorites') || '[]');
        function saveFavorites() {
            localStorage.setItem('amidakuji_favorites', JSON.stringify(favorites));
        }

        function openTemplateEditor() {
            teNavStack = [];
            teCurrentView = 'genres';
            teSelectedGenre = null;
            teSelectedSub = null;
            teOpenGenre = null;
            teEditMode = false;
            renderTemplateEditor();
            document.getElementById('templateEditorOverlay').classList.add('open');
        }

        function closeTemplateEditor() {
            document.getElementById('templateEditorOverlay').classList.remove('open');
        }

        function toggleEditMode() {
            teEditMode = !teEditMode;
            teNavStack = [];
            teCurrentView = 'genres';
            teOpenGenre = null;
            renderTemplateEditor();
        }

        function teGoBack() {
            if (teNavStack.length > 0) {
                const prev = teNavStack.pop();
                teCurrentView = prev.view;
                teSelectedGenre = prev.genre;
                teSelectedSub = prev.sub;
                teOpenGenre = prev.openGenre;
                renderTemplateEditor();
            }
        }

        function teNavigateTo(view, genre, sub) {
            teNavStack.push({ view: teCurrentView, genre: teSelectedGenre, sub: teSelectedSub, openGenre: teOpenGenre });
            teCurrentView = view;
            if (genre !== undefined) teSelectedGenre = genre;
            if (sub !== undefined) teSelectedSub = sub;
            renderTemplateEditor();
        }

        function renderTemplateEditor() {
            const content = document.getElementById('teContent');
            const backBtn = document.getElementById('teBackBtn');
            const title = document.getElementById('teTitle');
            const footer = document.getElementById('teFooter');
            const hintArea = document.getElementById('teHintArea');
            const editBtn = document.getElementById('teEditToggleBtn');

            backBtn.classList.toggle('hidden', teNavStack.length === 0);
            editBtn.classList.toggle('active', teEditMode);
            editBtn.textContent = teEditMode ? 'ÂÆå‰∫Ü' : 'Á∑®ÈõÜ';

            // „Éï„ÉÉ„Çø„ÉºÔºàÁ∑®ÈõÜ„É¢„Éº„Éâ„ÅÆgenresÁîªÈù¢„ÅÆ„ÅøË°®Á§∫Ôºâ
            footer.classList.toggle('show', teEditMode && teCurrentView === 'genres');

            // „Éí„É≥„Éà„Ç®„É™„Ç¢
            if (teCurrentView === 'genres') {
                if (teEditMode) {
                    hintArea.innerHTML = '<div class="te-drag-hint">üí° Èï∑Êäº„Åó„Åß‰∏¶„Å≥Êõø„Åà</div>';
                } else {
                    renderFavoritesInHint(hintArea);
                }
            } else {
                hintArea.innerHTML = '';
            }

            if (teCurrentView === 'genres') {
                title.textContent = 'üìã „ÉÜ„É≥„Éó„É¨„Éº„Éà';
                renderAccordionList(content);
            } else if (teCurrentView === 'choices') {
                title.textContent = presetGenres[teSelectedGenre]?.items[teSelectedSub]?.label || 'ÈÅ∏ÊäûËÇ¢';
                renderChoicesList(content);
            } else if (teCurrentView === 'edit_genre') {
                title.textContent = '„Ç∏„É£„É≥„É´Á∑®ÈõÜ';
                renderEditGenre(content);
            } else if (teCurrentView === 'edit_sub') {
                title.textContent = '„Ç´„ÉÜ„Ç¥„É™Á∑®ÈõÜ';
                renderEditSub(content);
            } else if (teCurrentView === 'add_genre') {
                title.textContent = 'Êñ∞„Åó„ÅÑ„Ç∏„É£„É≥„É´';
                renderAddGenre(content);
            } else if (teCurrentView === 'add_sub') {
                title.textContent = 'Êñ∞„Åó„ÅÑ„Ç´„ÉÜ„Ç¥„É™';
                renderAddSub(content);
            }
        }

        // „ÅäÊ∞ó„Å´ÂÖ•„ÇäË°®Á§∫Ôºà„Éí„É≥„Éà„Ç®„É™„Ç¢ÂÜÖÔºâ
        function renderFavoritesInHint(container) {
            if (favorites.length === 0) {
                container.innerHTML = '<div class="te-no-fav">‚òÖ „ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ÁôªÈå≤„Åô„Çã„Å®„ÄÅ„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</div>';
                return;
            }
            let html = '<div class="te-favorites-scroll">';
            favorites.forEach(function(fav) {
                const genre = presetGenres[fav.genreKey];
                if (!genre || !genre.items[fav.subKey]) return;
                const item = genre.items[fav.subKey];
                const color = genre.color || '#333';
                html += '<div class="te-fav-item" onclick="applyFavorite(\'' + fav.genreKey + '\',\'' + fav.subKey + '\')">';
                html += '<div class="te-fav-color" style="background:' + color + '"></div>';
                html += '<span>' + item.label + '</span>';
                html += '</div>';
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function applyFavorite(genreKey, subKey) {
            const genre = presetGenres[genreKey];
            if (!genre || !genre.items[subKey]) return;
            const item = genre.items[subKey];
            
            // Ë©≥Á¥∞„Éó„É¨„Éì„É•„Éº„ÇíÁîüÊàê
            let detail = '';
            if (item.choices && item.choices.length > 0) {
                detail = item.choices.join('„ÄÅ');
            } else if (item.type === 'dynamic') {
                const templateDesc = {
                    'alphabet_san': 'A„Åï„Çì„ÄÅB„Åï„Çì„ÄÅC„Åï„Çì„ÄÅD„Åï„Çì ...',
                    'number_banme': '1Áï™ÁõÆ„ÄÅ2Áï™ÁõÆ„ÄÅ3Áï™ÁõÆ„ÄÅ4Áï™ÁõÆ ...',
                    'team_alphabet': 'A„ÉÅ„Éº„É†„ÄÅB„ÉÅ„Éº„É†„ÄÅC„ÉÅ„Éº„É†„ÄÅD„ÉÅ„Éº„É† ...',
                    'number_ban': '1Áï™„ÄÅ2Áï™„ÄÅ3Áï™„ÄÅ4Áï™ ...'
                };
                detail = templateDesc[item.template] || 'ÂÖ•ÂäõÊï∞„Å´Âøú„Åò„Å¶Ëá™ÂãïÁîüÊàê„Åï„Çå„Åæ„Åô';
            }

            showTemplateConfirm(genre.name, item.label, detail, genre.color, function() {
                currentGenre = genreKey;
                activeTemplateGenre = genreKey;
                activeTemplateSub = subKey;
                applyPreset(subKey);
                updateActiveTemplateBadge();
                closeTemplateEditor();
                showToast('‚úÖ „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü');
            });
        }

        // ÈÅ©Áî®‰∏≠„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆ„Éê„ÉÉ„Ç∏„ÇíÊõ¥Êñ∞
        function updateActiveTemplateBadge() {
            const badge = document.getElementById('activeTemplateBadge');
            if (!activeTemplateGenre || !activeTemplateSub) {
                badge.classList.remove('show');
                return;
            }
            const genre = presetGenres[activeTemplateGenre];
            if (!genre || !genre.items[activeTemplateSub]) {
                badge.classList.remove('show');
                return;
            }
            const item = genre.items[activeTemplateSub];
            badge.style.background = genre.color || '#333';
            badge.innerHTML = '<span class="active-template-badge-icon">' + (genre.icon || 'üìÅ') + '</span>' +
                              '<span class="active-template-badge-name">' + item.label + '</span>';
            badge.classList.add('show');
        }

        function showTemplateConfirm(genreName, itemLabel, detail, color, onConfirm) {
            // Êó¢Â≠ò„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„ÅÇ„Çå„Å∞ÂâäÈô§
            const existing = document.getElementById('templateConfirmOverlay');
            if (existing) existing.remove();

            const overlay = document.createElement('div');
            overlay.id = 'templateConfirmOverlay';
            overlay.className = 'template-confirm-overlay';
            overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };

            overlay.innerHTML = 
                '<div class="template-confirm-card">' +
                    '<div class="template-confirm-header" style="background:' + (color || '#333') + '">' +
                        '<span class="template-confirm-genre">' + genreName + '</span>' +
                    '</div>' +
                    '<div class="template-confirm-body">' +
                        '<div class="template-confirm-label">' + itemLabel + '</div>' +
                        '<div class="template-confirm-detail">' + detail + '</div>' +
                        '<div class="template-confirm-msg">„Åì„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ©Áî®„Åó„Åæ„Åô„ÅãÔºü</div>' +
                    '</div>' +
                    '<div class="template-confirm-footer">' +
                        '<button class="template-confirm-cancel">„Ç≠„É£„É≥„Çª„É´</button>' +
                        '<button class="template-confirm-ok">ÈÅ©Áî®„Åô„Çã</button>' +
                    '</div>' +
                '</div>';

            overlay.querySelector('.template-confirm-cancel').onclick = function() { overlay.remove(); };
            overlay.querySelector('.template-confirm-ok').onclick = function() { overlay.remove(); onConfirm(); };

            document.body.appendChild(overlay);
        }

        function isFavorite(genreKey, subKey) {
            return favorites.some(f => f.genreKey === genreKey && f.subKey === subKey);
        }

        function toggleFavorite(genreKey, subKey) {
            const idx = favorites.findIndex(f => f.genreKey === genreKey && f.subKey === subKey);
            if (idx >= 0) {
                favorites.splice(idx, 1);
                saveFavorites();
                showToast('‚òÜ „ÅäÊ∞ó„Å´ÂÖ•„Çä„ÇíËß£Èô§„Åó„Åæ„Åó„Åü');
            } else {
                favorites.push({ genreKey, subKey });
                saveFavorites();
                showToast('‚òÖ „ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ÁôªÈå≤„Åó„Åæ„Åó„Åü');
            }
            renderTemplateEditor();
        }

        function renderAccordionList(container) {
            let html = '';
            Object.keys(presetGenres).forEach(function(key, idx) {
                const genre = presetGenres[key];
                const isOpen = teOpenGenre === key;
                const color = genre.color || '#333';
                const icon = genre.icon || 'üìÅ';
                html += '<div class="te-genre-item' + (isOpen ? ' open' : '') + '" data-genre="' + key + '" data-idx="' + idx + '">';

                if (teEditMode) {
                    // Á∑®ÈõÜ„É¢„Éº„Éâ: „Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ
                    html += '<div class="te-genre-header" style="background:' + color + '" onclick="toggleGenreAccordion(\'' + key + '\')" ontouchstart="startGenreDrag(event,\'' + key + '\')" ontouchend="endDrag()" ontouchmove="onDragMove(event)">';
                } else {
                    // ÈÅ∏Êäû„É¢„Éº„Éâ: „Éâ„É©„ÉÉ„Ç∞‰∏çÂèØ
                    html += '<div class="te-genre-header" style="background:' + color + '" onclick="toggleGenreAccordion(\'' + key + '\')">';
                }
                html += '<span class="te-genre-icon">' + icon + '</span><span class="te-genre-title">' + genre.name + '</span><span class="te-genre-arrow">‚ñº</span></div>';
                html += '<div class="te-genre-body"><div class="te-genre-body-inner"><div class="te-genre-content" style="border-left:4px solid ' + color + '">';
                html += '<div class="te-sub-list">';

                Object.keys(genre.items).forEach(function(subKey, subIdx) {
                    const item = genre.items[subKey];
                    const isFav = isFavorite(key, subKey);
                    // ÈÅ∏ÊäûËÇ¢„ÅÆ„Éó„É¨„Éì„É•„Éº
                    let preview = '';
                    if (item.choices && item.choices.length > 0) {
                        const maxShow = 3;
                        const shown = item.choices.slice(0, maxShow).join('„Éª');
                        preview = shown + (item.choices.length > maxShow ? '...' : '');
                    } else if (item.type === 'dynamic') {
                        // dynamic„Çø„Ç§„Éó„ÅØtemplate„Åã„ÇâË™¨Êòé„ÇíÁîüÊàê
                        const templateDesc = {
                            'alphabet_san': 'A„Åï„Çì„ÉªB„Åï„Çì„ÉªC„Åï„Çì...',
                            'number_banme': '1Áï™ÁõÆ„Éª2Áï™ÁõÆ„Éª3Áï™ÁõÆ...',
                            'team_alphabet': 'A„ÉÅ„Éº„É†„ÉªB„ÉÅ„Éº„É†...',
                            'number_ban': '1Áï™„Éª2Áï™„Éª3Áï™...'
                        };
                        preview = templateDesc[item.template] || 'Ëá™ÂãïÁîüÊàê';
                    }

                    if (teEditMode) {
                        // Á∑®ÈõÜ„É¢„Éº„Éâ
                        const tl = item.type === 'dynamic' ? 'Ëá™Âãï' : item.type === 'fixed' ? 'Âõ∫ÂÆö' : '„É©„É≥„ÉÄ„É†';
                        const cnt = item.choices ? item.choices.length + 'ÂÄã' : '';
                        html += '<div class="te-sub-item" data-genre="' + key + '" data-sub="' + subKey + '" data-idx="' + subIdx + '" onclick="teNavigateTo(\'choices\',\'' + key + '\',\'' + subKey + '\')" ontouchstart="startSubDrag(event,\'' + key + '\',\'' + subKey + '\')" ontouchend="endDrag()" ontouchmove="onDragMove(event)">';
                        html += '<span class="te-sub-name">' + item.label + '</span><span class="te-sub-info">' + tl + ' ' + cnt + '</span>';
                        html += '<span class="te-sub-arrow">‚Ä∫</span></div>';
                    } else {
                        // ÈÅ∏Êäû„É¢„Éº„Éâ: „Çø„ÉÉ„Éó„ÅßÈÅ©Áî®„ÄÅ‚òÖ„Åß„ÅäÊ∞ó„Å´ÂÖ•„Çä
                        html += '<div class="te-sub-item" onclick="applyFavorite(\'' + key + '\',\'' + subKey + '\')">';
                        html += '<span class="te-sub-name">' + item.label + '</span><span class="te-sub-info">' + preview + '</span>';
                        html += '<span class="te-sub-fav" onclick="event.stopPropagation();toggleFavorite(\'' + key + '\',\'' + subKey + '\')" style="color:' + (isFav ? '#ffc107' : '#ccc') + '">' + (isFav ? '‚òÖ' : '‚òÜ') + '</span>';
                        html += '</div>';
                    }
                });

                html += '</div>';
                if (teEditMode) {
                    html += '<div class="te-genre-actions">';
                    html += '<button class="te-genre-action-btn edit" onclick="event.stopPropagation();teNavigateTo(\'edit_genre\',\'' + key + '\')">Á∑®ÈõÜ</button>';
                    html += '<button class="te-genre-action-btn add" onclick="event.stopPropagation();teNavigateTo(\'add_sub\',\'' + key + '\')">+ ËøΩÂä†</button>';
                    html += '</div>';
                }
                html += '</div></div></div></div>';
            });

            if (teEditMode) {
                html += '<div class="te-add-genre-btn" onclick="teNavigateTo(\'add_genre\')">Ôºã Êñ∞„Åó„ÅÑ„Ç∏„É£„É≥„É´„ÇíËøΩÂä†</div>';
            }
            container.innerHTML = html;
        }

        // „Éâ„É©„ÉÉ„Ç∞‰∏¶„Å≥Êõø„Åà
        let dragTimer = null;
        let isDragging = false;
        let dragType = null;
        let dragKey = null;
        let dragSubKey = null;
        let dragElement = null;
        let lastSwapTime = 0;
        let dragStartY = 0;

        function startGenreDrag(e, key) {
            dragStartY = e.touches[0].clientY;
            dragTimer = setTimeout(function() {
                isDragging = true;
                dragType = 'genre';
                dragKey = key;
                const el = document.querySelector('.te-genre-item[data-genre="' + key + '"]');
                if (el) { el.classList.add('dragging'); dragElement = el; }
                navigator.vibrate && navigator.vibrate(50);
            }, 500);
        }

        function startSubDrag(e, genreKey, subKey) {
            dragStartY = e.touches[0].clientY;
            dragTimer = setTimeout(function() {
                isDragging = true;
                dragType = 'sub';
                dragKey = genreKey;
                dragSubKey = subKey;
                const el = document.querySelector('.te-sub-item[data-genre="' + genreKey + '"][data-sub="' + subKey + '"]');
                if (el) { el.classList.add('dragging'); dragElement = el; }
                navigator.vibrate && navigator.vibrate(50);
            }, 500);
        }

        function onDragMove(e) {
            if (dragTimer) { clearTimeout(dragTimer); dragTimer = null; }
            if (!isDragging) return;
            e.preventDefault();

            const now = Date.now();
            if (now - lastSwapTime < 200) return; // „Çπ„ÉØ„ÉÉ„ÉóÈñìÈöîÂà∂Èôê

            const touch = e.touches[0];
            const elements = document.elementsFromPoint(touch.clientX, touch.clientY);

            // ÂÖ®„Å¶„ÅÆË¶ÅÁ¥†„Åã„Çâdrag-overÁ≥ª„ÇØ„É©„Çπ„ÇíÂâäÈô§
            document.querySelectorAll('.drag-over, .drag-over-up').forEach(el => {
                el.classList.remove('drag-over', 'drag-over-up');
            });

            if (dragType === 'genre') {
                const target = elements.find(el => el.classList.contains('te-genre-item') && el.dataset.genre && el.dataset.genre !== dragKey);
                if (target) {
                    const targetRect = target.getBoundingClientRect();
                    const targetCenter = targetRect.top + targetRect.height / 2;

                    if (touch.clientY < targetCenter) {
                        target.classList.add('drag-over-up');
                    } else {
                        target.classList.add('drag-over');
                    }

                    // ‰∏ÄÂÆöË∑ùÈõ¢ÁßªÂãï„Åó„Åü„Çâ„Çπ„ÉØ„ÉÉ„Éó
                    if (Math.abs(touch.clientY - targetCenter) < targetRect.height * 0.3) {
                        animateSwapGenres(dragKey, target.dataset.genre);
                        lastSwapTime = now;
                    }
                }
            } else if (dragType === 'sub') {
                const target = elements.find(el => el.classList.contains('te-sub-item') && el.dataset.genre === dragKey && el.dataset.sub !== dragSubKey);
                if (target) {
                    const targetRect = target.getBoundingClientRect();
                    const targetCenter = targetRect.top + targetRect.height / 2;

                    if (touch.clientY < targetCenter) {
                        target.classList.add('drag-over-up');
                    } else {
                        target.classList.add('drag-over');
                    }

                    if (Math.abs(touch.clientY - targetCenter) < targetRect.height * 0.3) {
                        animateSwapSubs(dragKey, dragSubKey, target.dataset.sub);
                        dragSubKey = target.dataset.sub;
                        lastSwapTime = now;
                    }
                }
            }
        }

        function endDrag() {
            if (dragTimer) { clearTimeout(dragTimer); dragTimer = null; }

            // drag-over„ÇØ„É©„Çπ„ÇíÂâäÈô§
            document.querySelectorAll('.drag-over, .drag-over-up').forEach(el => {
                el.classList.remove('drag-over', 'drag-over-up');
            });

            if (isDragging) {
                if (dragElement) dragElement.classList.remove('dragging');
                saveCustomPresets();
                showToast('‚úÖ ‰∏¶„Å≥È†Ü„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü');
            }
            isDragging = false;
            dragType = null;
            dragKey = null;
            dragSubKey = null;
            dragElement = null;
        }

        function animateSwapGenres(key1, key2) {
            const el1 = document.querySelector('.te-genre-item[data-genre="' + key1 + '"]');
            const el2 = document.querySelector('.te-genre-item[data-genre="' + key2 + '"]');
            if (!el1 || !el2) return;

            const rect1 = el1.getBoundingClientRect();
            const rect2 = el2.getBoundingClientRect();
            const diff = rect2.top - rect1.top;

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
            el1.style.transform = 'translateY(' + diff + 'px) scale(1.03)';
            el2.style.transform = 'translateY(' + (-diff) + 'px)';

            setTimeout(function() {
                el1.style.transform = '';
                el2.style.transform = '';

                // „Éá„Éº„Çø„ÇíÂÖ•„ÇåÊõø„Åà
                const keys = Object.keys(presetGenres);
                const idx1 = keys.indexOf(key1);
                const idx2 = keys.indexOf(key2);
                if (idx1 < 0 || idx2 < 0) return;

                const newObj = {};
                keys.forEach(function(k, i) {
                    if (i === idx1) newObj[keys[idx2]] = presetGenres[keys[idx2]];
                    else if (i === idx2) newObj[keys[idx1]] = presetGenres[keys[idx1]];
                    else newObj[k] = presetGenres[k];
                });

                Object.keys(presetGenres).forEach(k => delete presetGenres[k]);
                Object.assign(presetGenres, newObj);

                // DOMÂÜçÊßãÁØâ
                renderAccordionList(document.getElementById('teContent'));

                // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆË¶ÅÁ¥†„ÇíÂÜçÂèñÂæó„Åó„Å¶„ÇØ„É©„Çπ„ÇíÁ∂≠ÊåÅ
                dragElement = document.querySelector('.te-genre-item[data-genre="' + key1 + '"]');
                if (dragElement) dragElement.classList.add('dragging');
            }, 200);
        }

        function animateSwapSubs(genreKey, sub1, sub2) {
            const el1 = document.querySelector('.te-sub-item[data-genre="' + genreKey + '"][data-sub="' + sub1 + '"]');
            const el2 = document.querySelector('.te-sub-item[data-genre="' + genreKey + '"][data-sub="' + sub2 + '"]');
            if (!el1 || !el2) return;

            const rect1 = el1.getBoundingClientRect();
            const rect2 = el2.getBoundingClientRect();
            const diff = rect2.top - rect1.top;

            el1.style.transform = 'translateY(' + diff + 'px) scale(1.03)';
            el2.style.transform = 'translateY(' + (-diff) + 'px)';

            setTimeout(function() {
                el1.style.transform = '';
                el2.style.transform = '';

                const genre = presetGenres[genreKey];
                if (!genre) return;

                const keys = Object.keys(genre.items);
                const idx1 = keys.indexOf(sub1);
                const idx2 = keys.indexOf(sub2);
                if (idx1 < 0 || idx2 < 0) return;

                const newItems = {};
                keys.forEach(function(k, i) {
                    if (i === idx1) newItems[keys[idx2]] = genre.items[keys[idx2]];
                    else if (i === idx2) newItems[keys[idx1]] = genre.items[keys[idx1]];
                    else newItems[k] = genre.items[k];
                });

                genre.items = newItems;
                renderAccordionList(document.getElementById('teContent'));

                // „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥„ÇíÈñã„ÅÑ„ÅüÁä∂ÊÖã„ÇíÁ∂≠ÊåÅ
                const targetItem = document.querySelector('.te-genre-item[data-genre="' + genreKey + '"]');
                if (targetItem && teOpenGenre === genreKey) targetItem.classList.add('open');

                // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆË¶ÅÁ¥†„ÇíÂÜçÂèñÂæó
                dragElement = document.querySelector('.te-sub-item[data-genre="' + genreKey + '"][data-sub="' + sub2 + '"]');
                if (dragElement) dragElement.classList.add('dragging');
            }, 200);
        }

        function toggleGenreAccordion(key) {
            if (isDragging) return;

            const wasOpen = teOpenGenre === key;

            document.querySelectorAll('.te-genre-item').forEach(function(item) {
                item.classList.remove('open');
            });

            if (!wasOpen) {
                const targetItem = document.querySelector('.te-genre-item[data-genre="' + key + '"]');
                if (targetItem) {
                    targetItem.classList.add('open');
                    teOpenGenre = key;
                    
                    const container = document.getElementById('teContent');
                    if (container && targetItem) {
                        const startTime = performance.now();
                        const duration = 400;
                        const startScroll = container.scrollTop;
                        
                        function easeOutCubic(t) {
                            return 1 - Math.pow(1 - t, 3);
                        }
                        
                        function updateScroll() {
                            const elapsed = performance.now() - startTime;
                            const progress = Math.min(elapsed / duration, 1);
                            const eased = easeOutCubic(progress);
                            
                            const containerRect = container.getBoundingClientRect();
                            const itemRect = targetItem.getBoundingClientRect();
                            const targetScroll = itemRect.top - containerRect.top + container.scrollTop;
                            
                            // ÁèæÂú®‰ΩçÁΩÆ„Åã„ÇâÁõÆÊ®ô‰ΩçÁΩÆ„Å∏„Å™„ÇÅ„Çâ„Åã„Å´Ë£úÈñì
                            container.scrollTop = startScroll + (targetScroll - startScroll) * eased;
                            
                            if (progress < 1) {
                                requestAnimationFrame(updateScroll);
                            }
                        }
                        requestAnimationFrame(updateScroll);
                    }
                }
            } else {
                teOpenGenre = null;
            }
        }

        function renderChoicesList(container) {
            const item = presetGenres[teSelectedGenre]?.items[teSelectedSub];
            if (!item) return;
            const color = presetGenres[teSelectedGenre]?.color || '#333';
            let html = '<div class="te-edit-section"><button class="te-genre-action-btn edit" onclick="teNavigateTo(\'edit_sub\')" style="width:100%;padding:12px">‚úèÔ∏è „Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÇíÁ∑®ÈõÜ</button></div>';
            if (item.type === 'dynamic') {
                html += '<div style="text-align:center;padding:30px;color:#888;background:#f8f9fa;border-radius:12px"><div style="font-size:2rem;margin-bottom:10px">üîÑ</div><div style="font-weight:bold">Ëá™ÂãïÁîüÊàê„Çø„Ç§„Éó</div><div style="font-size:0.85rem;margin-top:5px">Êû†Êï∞„Å´Âøú„Åò„Å¶Ëá™Âãï„ÅßÁîüÊàê„Åï„Çå„Åæ„Åô</div></div>';
            } else {
                html += '<div style="padding:10px;background:' + color + '15;border-radius:12px;border-left:4px solid ' + color + '"><div id="teChoicesContainer">';
                item.choices.forEach(function(c, i) {
                    html += '<div class="te-choice-item"><input type="text" value="' + c + '" onchange="updateChoice(' + i + ',this.value)"><button class="te-choice-delete" onclick="deleteChoice(' + i + ')">‚úï</button></div>';
                });
                html += '</div><button class="te-add-choice" onclick="addNewChoice()">Ôºã ÈÅ∏ÊäûËÇ¢„ÇíËøΩÂä†</button></div>';
            }
            container.innerHTML = html;
        }

        function updateChoice(i, v) { const item = presetGenres[teSelectedGenre]?.items[teSelectedSub]; if (item?.choices) { item.choices[i] = v; saveCustomPresets(); } }
        function deleteChoice(i) { const item = presetGenres[teSelectedGenre]?.items[teSelectedSub]; if (item?.choices?.length > 1) { item.choices.splice(i, 1); saveCustomPresets(); renderTemplateEditor(); } else { showToast('‚ö†Ô∏è ÊúÄ‰Ωé1„Å§„ÅØÂøÖË¶Å„Åß„Åô'); } }
        function addNewChoice() { const item = presetGenres[teSelectedGenre]?.items[teSelectedSub]; if (item?.choices) { item.choices.push('Êñ∞„Åó„ÅÑÈÅ∏ÊäûËÇ¢'); saveCustomPresets(); renderTemplateEditor(); setTimeout(function() { const inputs = document.querySelectorAll('#teChoicesContainer input'); if (inputs.length) { inputs[inputs.length-1].focus(); inputs[inputs.length-1].select(); } }, 100); } }

        function renderEditGenre(container) {
            const genre = presetGenres[teSelectedGenre]; if (!genre) return;
            let colorOpts = '';
            themeColors.forEach(function(c) { colorOpts += '<div class="te-color-option' + (c === genre.color ? ' selected' : '') + '" style="background:' + c + '" data-color="' + c + '" onclick="selectGenreColor(\'' + c + '\')"></div>'; });
            let iconOpts = '';
            genreIcons.forEach(function(ic) { iconOpts += '<div class="te-icon-option' + (ic === genre.icon ? ' selected' : '') + '" onclick="selectGenreIcon(\'' + ic + '\')">' + ic + '</div>'; });
            container.innerHTML = '<div class="te-edit-section"><div class="te-edit-label">ÂêçÂâç</div><input type="text" class="te-edit-input" id="teGenreName" value="' + genre.name + '" maxlength="10"></div><div class="te-edit-section"><div class="te-edit-label">„Ç¢„Ç§„Ç≥„É≥</div><div class="te-icon-picker" id="teIconPicker">' + iconOpts + '</div><input type="hidden" id="teGenreIcon" value="' + (genre.icon || 'üçΩÔ∏è') + '"></div><div class="te-edit-section"><div class="te-edit-label">„ÉÜ„Éº„Éû„Ç´„É©„Éº</div><div class="te-color-picker">' + colorOpts + '</div><input type="hidden" id="teGenreColor" value="' + (genre.color || '#333') + '"></div><button class="te-save-btn" onclick="saveGenreEdit()">üíæ ‰øùÂ≠ò</button><button class="te-delete-btn" onclick="deleteGenre()">üóëÔ∏è „Åì„ÅÆ„Ç∏„É£„É≥„É´„ÇíÂâäÈô§</button>';
        }
        function selectGenreColor(c) { document.getElementById('teGenreColor').value = c; document.querySelectorAll('.te-color-option').forEach(function(o) { o.classList.toggle('selected', o.dataset.color === c); }); }
        function selectGenreIcon(ic) { document.getElementById('teGenreIcon').value = ic; document.querySelectorAll('#teIconPicker .te-icon-option').forEach(function(o) { o.classList.toggle('selected', o.textContent === ic); }); }
        function saveGenreEdit() { const n = document.getElementById('teGenreName').value.trim(), c = document.getElementById('teGenreColor').value, ic = document.getElementById('teGenreIcon').value; if (!n) { showToast('‚ö†Ô∏è ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; } presetGenres[teSelectedGenre].name = n; presetGenres[teSelectedGenre].color = c; presetGenres[teSelectedGenre].icon = ic; saveCustomPresets(); selectGenre(currentGenre); teGoBack(); showToast('‚úÖ ‰øùÂ≠ò„Åó„Åæ„Åó„Åü'); }
        function deleteGenre() { showConfirm('„Åì„ÅÆ„Ç∏„É£„É≥„É´„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü', function() { delete presetGenres[teSelectedGenre]; saveCustomPresets(); if (currentGenre === teSelectedGenre) { currentGenre = Object.keys(presetGenres)[0] || 'food'; selectGenre(currentGenre); } teNavStack = []; teCurrentView = 'genres'; teOpenGenre = null; renderTemplateEditor(); showToast('üóëÔ∏è ÂâäÈô§„Åó„Åæ„Åó„Åü'); }, null, 'üóëÔ∏è', 'ÂâäÈô§', '„Ç≠„É£„É≥„Çª„É´'); }

        function renderEditSub(container) {
            const item = presetGenres[teSelectedGenre]?.items[teSelectedSub]; if (!item) return;
            container.innerHTML = '<div class="te-edit-section"><div class="te-edit-label">ÂêçÂâç</div><input type="text" class="te-edit-input" id="teSubName" value="' + item.label + '" maxlength="15"></div><div class="te-edit-section"><div class="te-edit-label">„Çø„Ç§„Éó</div><div class="te-type-selector"><button class="te-type-btn' + (item.type === 'random' ? ' active' : '') + '" onclick="changeSubType(\'random\')">„É©„É≥„ÉÄ„É†</button><button class="te-type-btn' + (item.type === 'fixed' ? ' active' : '') + '" onclick="changeSubType(\'fixed\')">Âõ∫ÂÆö</button><button class="te-type-btn' + (item.type === 'dynamic' ? ' active' : '') + '" onclick="changeSubType(\'dynamic\')">Ëá™Âãï</button></div></div><button class="te-save-btn" onclick="saveSubEdit()">üíæ ‰øùÂ≠ò</button><button class="te-delete-btn" onclick="deleteSub()">üóëÔ∏è „Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÇíÂâäÈô§</button>';
        }
        function changeSubType(t) { const item = presetGenres[teSelectedGenre]?.items[teSelectedSub]; if (!item) return; item.type = t; if (t === 'dynamic' && !item.template) { item.template = 'number_ban'; delete item.choices; } else if (t !== 'dynamic' && !item.choices) { item.choices = ['ÈÅ∏ÊäûËÇ¢1', 'ÈÅ∏ÊäûËÇ¢2']; delete item.template; } saveCustomPresets(); renderEditSub(document.getElementById('teContent')); }
        function saveSubEdit() { const n = document.getElementById('teSubName').value.trim(); if (!n) { showToast('‚ö†Ô∏è ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; } presetGenres[teSelectedGenre].items[teSelectedSub].label = n; saveCustomPresets(); renderSubPresets(currentGenre); teGoBack(); showToast('‚úÖ ‰øùÂ≠ò„Åó„Åæ„Åó„Åü'); }
        function deleteSub() { showConfirm('„Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü', function() { delete presetGenres[teSelectedGenre].items[teSelectedSub]; saveCustomPresets(); renderSubPresets(currentGenre); teGoBack(); showToast('üóëÔ∏è ÂâäÈô§„Åó„Åæ„Åó„Åü'); }, null, 'üóëÔ∏è', 'ÂâäÈô§', '„Ç≠„É£„É≥„Çª„É´'); }

        function renderAddGenre(container) {
            let colorOpts = ''; themeColors.forEach(function(c, i) { colorOpts += '<div class="te-color-option' + (i === 0 ? ' selected' : '') + '" style="background:' + c + '" data-color="' + c + '" onclick="selectNewGenreColor(\'' + c + '\')"></div>'; });
            let iconOpts = ''; genreIcons.forEach(function(ic, i) { iconOpts += '<div class="te-icon-option' + (i === 0 ? ' selected' : '') + '" onclick="selectNewGenreIcon(\'' + ic + '\')">' + ic + '</div>'; });
            container.innerHTML = '<div class="te-edit-section"><div class="te-edit-label">ÂêçÂâç</div><input type="text" class="te-edit-input" id="teNewGenreName" placeholder="Êñ∞„Åó„ÅÑ„Ç∏„É£„É≥„É´" maxlength="10"></div><div class="te-edit-section"><div class="te-edit-label">„Ç¢„Ç§„Ç≥„É≥</div><div class="te-icon-picker" id="teNewIconPicker">' + iconOpts + '</div><input type="hidden" id="teNewGenreIcon" value="' + genreIcons[0] + '"></div><div class="te-edit-section"><div class="te-edit-label">„ÉÜ„Éº„Éû„Ç´„É©„Éº</div><div class="te-color-picker" id="teNewColorPicker">' + colorOpts + '</div><input type="hidden" id="teNewGenreColor" value="' + themeColors[0] + '"></div><button class="te-save-btn" onclick="addNewGenre()">Ôºã ËøΩÂä†</button>';
        }
        function selectNewGenreColor(c) { document.getElementById('teNewGenreColor').value = c; document.querySelectorAll('#teNewColorPicker .te-color-option').forEach(function(o) { o.classList.toggle('selected', o.dataset.color === c); }); }
        function selectNewGenreIcon(ic) { document.getElementById('teNewGenreIcon').value = ic; document.querySelectorAll('#teNewIconPicker .te-icon-option').forEach(function(o) { o.classList.toggle('selected', o.textContent === ic); }); }
        function addNewGenre() { const n = document.getElementById('teNewGenreName').value.trim(), c = document.getElementById('teNewGenreColor').value, ic = document.getElementById('teNewGenreIcon').value; if (!n) { showToast('‚ö†Ô∏è ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; } const k = 'custom_' + Date.now(); presetGenres[k] = { name: n, color: c, icon: ic, items: {} }; saveCustomPresets(); teGoBack(); showToast('‚úÖ ËøΩÂä†„Åó„Åæ„Åó„Åü'); }

        function renderAddSub(container) {
            container.innerHTML = '<div class="te-edit-section"><div class="te-edit-label">ÂêçÂâç</div><input type="text" class="te-edit-input" id="teNewSubName" placeholder="Êñ∞„Åó„ÅÑ„Ç´„ÉÜ„Ç¥„É™" maxlength="15"></div><div class="te-edit-section"><div class="te-edit-label">„Çø„Ç§„Éó</div><div class="te-type-selector"><button class="te-type-btn active" id="teNewSubTypeRandom" onclick="selectNewSubType(\'random\')">„É©„É≥„ÉÄ„É†</button><button class="te-type-btn" id="teNewSubTypeFixed" onclick="selectNewSubType(\'fixed\')">Âõ∫ÂÆö</button><button class="te-type-btn" id="teNewSubTypeDynamic" onclick="selectNewSubType(\'dynamic\')">Ëá™Âãï</button></div></div><input type="hidden" id="teNewSubType" value="random"><button class="te-save-btn" onclick="addNewSub()">Ôºã ËøΩÂä†</button>';
        }
        function selectNewSubType(t) { document.getElementById('teNewSubType').value = t; document.querySelectorAll('.te-type-selector .te-type-btn').forEach(function(b) { b.classList.remove('active'); }); document.getElementById('teNewSubType' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('active'); }
        function addNewSub() { const n = document.getElementById('teNewSubName').value.trim(), t = document.getElementById('teNewSubType').value; if (!n) { showToast('‚ö†Ô∏è ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; } const k = 'custom_' + Date.now(), item = { label: n, type: t }; if (t === 'dynamic') { item.template = 'number_ban'; } else { item.choices = ['ÈÅ∏ÊäûËÇ¢1', 'ÈÅ∏ÊäûËÇ¢2', 'ÈÅ∏ÊäûËÇ¢3']; } presetGenres[teSelectedGenre].items[k] = item; saveCustomPresets(); renderSubPresets(currentGenre); teGoBack(); showToast('‚úÖ ËøΩÂä†„Åó„Åæ„Åó„Åü'); }

        function resetToDefault() { 
            showConfirm('„Åô„Åπ„Å¶„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí\nÂàùÊúüÁä∂ÊÖã„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü', function() { 
                presetGenres = JSON.parse(JSON.stringify(DEFAULT_PRESET_GENRES)); 
                saveCustomPresets(); 
                currentGenre = 'food'; 
                teNavStack = []; 
                teCurrentView = 'genres'; 
                teOpenGenre = null; 
                teSelectedGenre = null;
                teSelectedSub = null;
                // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁ∑®ÈõÜÁîªÈù¢„ÇíÂÜçÊèèÁîª
                const teContent = document.getElementById('teContent');
                if (teContent) {
                    renderAccordionList(teContent);
                    document.getElementById('teTitle').textContent = 'üìù „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁ∑®ÈõÜ';
                    document.getElementById('teBackBtn').classList.add('hidden');
                    document.getElementById('teFooter').style.display = 'block';
                }
                showToast('üîÑ ÂàùÊúüÁä∂ÊÖã„Å´Êàª„Åó„Åæ„Åó„Åü'); 
            }, null, 'üîÑ', 'Êàª„Åô', '„Ç≠„É£„É≥„Çª„É´'); 
        }

        // „Ç¢„Ç§„Ç≥„É≥„Éî„ÉÉ„Ç´„Éº
        function openIconPicker(targetBtn) {
            currentIconTarget = targetBtn;
            const grid = document.getElementById('iconGrid');
            grid.innerHTML = '';

            availableIcons.forEach(icon => {
                const btn = document.createElement('button');
                btn.className = 'icon-option';
                btn.textContent = icon;
                btn.onclick = () => selectIcon(icon);
                grid.appendChild(btn);
            });

            document.getElementById('iconPickerOverlay').classList.add('open');
        }

        function closeIconPicker() {
            document.getElementById('iconPickerOverlay').classList.remove('open');
            currentIconTarget = null;
        }

        function selectIcon(icon) {
            if (currentIconTarget) {
                currentIconTarget.textContent = icon;
                currentIconTarget.dataset.icon = icon;
            }
            closeIconPicker();
        }

        function addGoalItem(initialValue = '') {
            const list = document.getElementById('goalList');
            const currentCount = list.children.length;
            if (currentCount >= MAX_COUNT) return;

            // ÈÅ©Áî®‰∏≠„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„ÅÇ„Çå„Å∞Ê¨°„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÂèñÂæó
            let templateValue = '';
            if (initialValue === '' && activeTemplateGenre && activeTemplateSub) {
                const genre = presetGenres[activeTemplateGenre];
                if (genre && genre.items[activeTemplateSub]) {
                    const item = genre.items[activeTemplateSub];
                    if (item.type === 'dynamic') {
                        // ÂãïÁöÑÁîüÊàê
                        templateValue = generateDynamicChoice(item.template, currentCount);
                    } else if (item.choices && item.choices.length > 0) {
                        // Êó¢„Å´ÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„ÇãÂÄ§„ÇíÂèñÂæó
                        const usedValues = [];
                        list.querySelectorAll('.goal-input').forEach(function(input) {
                            if (input.value.trim()) {
                                usedValues.push(input.value.trim());
                            }
                        });
                        // „Åæ„Å†‰Ωø„Çè„Çå„Å¶„ÅÑ„Å™„ÅÑÈÅ∏ÊäûËÇ¢„Åã„Çâ„É©„É≥„ÉÄ„É†„Å´ÈÅ∏Êäû
                        const available = item.choices.filter(function(c) {
                            return usedValues.indexOf(c) === -1;
                        });
                        if (available.length > 0) {
                            const randomIdx = Math.floor(Math.random() * available.length);
                            templateValue = available[randomIdx];
                        }
                    }
                }
            }
            const useValue = initialValue || templateValue;

            const div = document.createElement('div');
            div.className = 'goal-item';

            const idx = document.createElement('span');
            idx.className = 'goal-index';
            idx.innerText = (currentCount + 1) + '.';

            // „Ç¢„Ç§„Ç≥„É≥„Éú„Çø„É≥Ôºà„Éé„Éº„Éû„É´„É¢„Éº„Éâ„ÅÆ„ÅøÔºâ
            const iconBtn = document.createElement('button');
            iconBtn.className = 'goal-icon-btn';
            iconBtn.type = 'button';
            iconBtn.textContent = 'üéØ';
            iconBtn.dataset.icon = 'üéØ';
            iconBtn.onclick = (e) => {
                e.stopPropagation();
                openIconPicker(iconBtn);
            };

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'goal-input';
            input.value = useValue;
            input.maxLength = 10;

            if (currentMode === 'normal') {
                input.placeholder = "ÈÅ∏ÊäûËÇ¢" + (numCircle[currentCount] || (currentCount+1));
            } else {
                input.placeholder = String.fromCharCode(65 + currentCount) + "„Åï„Çì";
            }

            // „Çπ„ÉØ„Ç§„ÉóÂâäÈô§Áî®„ÅÆÂ§âÊï∞
            let startX = 0;
            let currentX = 0;
            let isDragging = false;

            const handleTouchStart = (e) => {
                startX = e.touches ? e.touches[0].clientX : e.clientX;
                currentX = startX;
                isDragging = true;
                div.style.transition = 'none';
            };

            const handleTouchMove = (e) => {
                if (!isDragging) return;
                currentX = e.touches ? e.touches[0].clientX : e.clientX;
                const diff = currentX - startX;

                // Â∑¶„Çπ„ÉØ„Ç§„Éó„ÅÆ„ÅøË®±ÂèØ
                if (diff < 0) {
                    div.style.transform = `translateX(${diff}px)`;
                    div.style.backgroundColor = `rgba(255, ${200 + diff}, ${200 + diff}, 1)`;
                }
            };

            const handleTouchEnd = () => {
                if (!isDragging) return;
                isDragging = false;
                div.style.transition = 'transform 0.3s, background-color 0.3s';

                const diff = currentX - startX;

                // 100px‰ª•‰∏äÂ∑¶„Å´„Çπ„ÉØ„Ç§„Éó„Åó„Åü„ÇâÂâäÈô§Á¢∫Ë™ç
                if (diff < -100) {
                    if (document.getElementById('goalList').children.length > MIN_COUNT) {
                        showConfirm('„Åì„ÅÆÈ†ÖÁõÆ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü', () => {
                            // 1. „Åæ„ÅöÊ®™„Å´„Çπ„É©„Ç§„Éâ„Åó„Å¶Ê∂à„Åà„Çã
                            div.style.transition = 'transform 0.25s ease-out, opacity 0.25s ease-out';
                            div.style.transform = 'translateX(-100%)';
                            div.style.opacity = '0';
                            
                            setTimeout(() => {
                                // 2. È´ò„Åï„ÇíÂõ∫ÂÆö„Åó„Å¶„Åã„Çâpadding/margin„ÇíÊ∂à„ÅôÊ∫ñÂÇô
                                div.style.overflow = 'hidden';
                                const currentHeight = div.offsetHeight;
                                div.style.height = currentHeight + 'px';
                                div.style.boxSizing = 'border-box';
                                
                                // 3. Â∞ë„ÅóÈñì„ÇíÁΩÆ„ÅÑ„Å¶„Åã„Çâ„ÄÅ„ÇÜ„Å£„Åè„Çä‚ÜíÊÄ•Âä†ÈÄü„ÅßÈ´ò„Åï„ÇíÁ∏Æ„ÇÅ„Çã
                                setTimeout(() => {
                                    div.style.transition = 'height 0.3s cubic-bezier(0.1, 0, 0.9, 0.2), padding 0.3s cubic-bezier(0.1, 0, 0.9, 0.2), margin 0.3s cubic-bezier(0.1, 0, 0.9, 0.2)';
                                    div.style.height = '0';
                                    div.style.padding = '0';
                                    div.style.marginBottom = '0';
                                    
                                    setTimeout(() => {
                                        div.remove();
                                        updateIndexes();
                                        checkAddBtn();
                                    }, 300);
                                }, 15);
                            }, 250);
                        }, () => {
                            div.style.transform = 'translateX(0)';
                            div.style.backgroundColor = 'white';
                        }, 'üóëÔ∏è', 'ÂâäÈô§', '„Ç≠„É£„É≥„Çª„É´');
                    } else {
                        showConfirm('„Åì„Çå‰ª•‰∏äÊ∏õ„Çâ„Åõ„Åæ„Åõ„Çì', () => {
                            div.style.transform = 'translateX(0)';
                            div.style.backgroundColor = 'white';
                        }, null, '‚ö†Ô∏è', 'OK', '');
                        document.getElementById('confirmCancelBtn').style.display = 'none';
                        setTimeout(() => {
                            document.getElementById('confirmCancelBtn').style.display = 'flex';
                        }, 100);
                    }
                } else {
                    div.style.transform = 'translateX(0)';
                    div.style.backgroundColor = 'white';
                }
            };

            div.addEventListener('touchstart', handleTouchStart, { passive: true });
            div.addEventListener('touchmove', handleTouchMove, { passive: true });
            div.addEventListener('touchend', handleTouchEnd);
            div.addEventListener('mousedown', handleTouchStart);
            div.addEventListener('mousemove', handleTouchMove);
            div.addEventListener('mouseup', handleTouchEnd);
            div.addEventListener('mouseleave', handleTouchEnd);

            div.appendChild(idx);
            if (currentMode === 'normal') {
                div.appendChild(iconBtn);
            }
            div.appendChild(input);
            list.appendChild(div);

            // ËøΩÂä†„Åó„ÅüË¶ÅÁ¥†„ÅåË¶ãÂàá„Çå„Åù„ÅÜ„Å™ÊôÇ„Å†„Åë„Çπ„ÇØ„É≠„Éº„É´
            setTimeout(() => {
                const rect = div.getBoundingClientRect();
                const submitBtn = document.querySelector('.submit-btn');
                const submitRect = submitBtn ? submitBtn.getBoundingClientRect() : null;
                const bottomMargin = submitRect ? submitRect.height + 50 : 100;

                if (rect.bottom > window.innerHeight - bottomMargin) {
                    div.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 50);

            checkAddBtn();
        }

        function updateIndexes() {
            const items = document.querySelectorAll('.goal-item');
            items.forEach((item, index) => {
                item.querySelector('.goal-index').innerText = (index + 1) + '.';
                const input = item.querySelector('.goal-input');
                if (currentMode === 'normal') {
                    input.placeholder = "ÈÅ∏ÊäûËÇ¢" + (numCircle[index] || (index+1));
                } else {
                    input.placeholder = String.fromCharCode(65 + index) + "„Åï„Çì";
                }
            });
        }

        function checkAddBtn() {
            const count = document.getElementById('goalList').children.length;
            const btn = document.getElementById('addBtn');
            if (count >= MAX_COUNT) btn.classList.add('disabled');
            else btn.classList.remove('disabled');
        }

        function startGame() {
            const inputs = document.querySelectorAll('.goal-input');
            const count = inputs.length;

            showScreen('gameScreen');
            startedPlayerCount = 0;

            // BGMÈñãÂßã
            startBgm();

            dpr = window.devicePixelRatio || 1;
            let cssWidth = document.body.clientWidth;
            let cssHeight;

            if (currentMode === 'normal') {
                cssHeight = window.innerHeight * 1.2;
            } else {
                cssHeight = window.innerHeight * 3.0;
            }

            canvas.width = cssWidth * dpr;
            canvas.height = cssHeight * dpr;
            canvas.style.width = cssWidth + 'px';
            canvas.style.height = cssHeight + 'px';

            ctx.scale(dpr, dpr);

            let logicalWidth = cssWidth;
            let logicalHeight = cssHeight;

            columnWidth = logicalWidth / count;

            let baseSteps = (currentMode === 'normal') ? 14 : 50;
            const extraSteps = (count - 2) * 5;
            const steps = baseSteps + extraSteps;

            const ladderHeight = logicalHeight - topMargin - 250;
            stepHeight = ladderHeight / steps;

            const curtain = document.getElementById('curtain');

            // ÁõÆÈö†„Åó„É¢„Éº„Éâ„Å´Âøú„Åò„Å¶„Ç´„Éº„ÉÜ„É≥Ë°®Á§∫„ÇíÂà∂Âæ°
            if (blindMode === 'curtain') {
                curtain.style.opacity = 1;
                const hideSteps = 6.0;
                const curtainHeight = stepHeight * hideSteps;
                curtain.style.height = curtainHeight + 'px';
                curtain.style.top = (topMargin + (steps / 2) * stepHeight - (curtainHeight / 2)) + 'px';
            } else {
                // „Ç¥„Éº„É´Èö†„Åó„É¢„Éº„Éâ„Åß„ÅØ„Ç´„Éº„ÉÜ„É≥„ÅØÈùûË°®Á§∫
                curtain.style.opacity = 0;
            }

            createLadders(count, steps);

            players = [];
            goalLabels = [];

            // ÂÖ•Âäõ„Åï„Çå„Åü„Ç¥„Éº„É´„ÇíÂèñÂæó
            let inputLabels = [];
            for(let i=0; i<count; i++) {
                let val = inputs[i].value.trim();
                if (!val) val = inputs[i].placeholder;
                inputLabels.push(val);
            }

            // „Ç¥„Éº„É´„É©„Éô„É´„Çí„Ç∑„É£„ÉÉ„Éï„É´
            shuffledGoalLabels = shuffleArray([...inputLabels]);
            goalLabels = shuffledGoalLabels;

            const FIXED_MAX_COLUMNS = 8;
            const rawSize = Math.floor((window.innerWidth - 10) / FIXED_MAX_COLUMNS);
            const calculatedSize = Math.floor(rawSize * 0.9);
            const btnSize = calculatedSize + 'px';

            const btnLayer = document.getElementById('buttonLayer');
            btnLayer.innerHTML = '';

            for(let i=0; i<count; i++) {
                let startX = (i * columnWidth) + (columnWidth / 2);

                players.push({
                    id: i,
                    xIdx: i,
                    y: topMargin,
                    nextXIdx: undefined,
                    moveProgress: 0,
                    state: 'idle',
                    hasTurnedAtLevel: -1,
                    scale: 0,
                    currentSpeed: 6.3,

                    sliding: false,
                    slideTargetX: 0,
                    slideTargetY: 0,
                    slideStartX: 0,
                    slideStartY: 0,

                    reactedEndpoints: new Set(),
                    cameFromCurve: false,
                    curveExitY: undefined,

                    char: currentMode === 'race' ? characters[i] : null,
                    color: colors[i],
                    trail: [{x: startX, y: topMargin}, {x: startX, y: topMargin}]
                });

                if (currentMode === 'normal') {
                    const btn = document.createElement('button');
                    btn.className = 'marble-btn';
                    btn.style.setProperty('--btn-color', colors[i]);
                    btn.style.setProperty('--size', btnSize);
                    btn.style.left = (startX - calculatedSize/2) + 'px';
                    btn.onclick = (e) => startNormalEffect(e.currentTarget, i, colors[i]);
                    btnLayer.appendChild(btn);
                }
            }

            // „Çø„É≥„ÇØ„ÇíÁîüÊàêÔºàÁõÆÈö†„Åó„É¢„Éº„ÉâÂØæÂøúÔºâ
            createTanks(count, logicalHeight);

            const raceBtn = document.getElementById('raceBtn');
            if (currentMode === 'normal') {
                raceBtn.style.display = 'none';
                // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„Çí„ÇØ„É™„Ç¢
                document.getElementById('dropZoneLayer').innerHTML = '';
                hideCharPlacementUI();
            } else {
                raceBtn.style.display = 'block';
                raceBtn.disabled = true; // ÈÖçÁΩÆÂÆå‰∫Ü„Åæ„ÅßÁÑ°Âäπ

                // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÇíÁîüÊàê
                createDropZones(count, columnWidth, topMargin);
            }

            // Êó©ÈÄÅ„Çä„Éú„Çø„É≥„ÇíË°®Á§∫ÔºàÈÄüÂ∫¶„É™„Çª„ÉÉ„ÉàÔºâ
            resetSpeed();
            showFastForwardBtn();

            drawFrame();

            window.scrollTo({ top: document.body.scrollHeight, behavior: 'instant' });
            setTimeout(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });

                // ÂãïÁâ©„É¨„Éº„Çπ„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÄÅ„Çπ„ÇØ„É≠„Éº„É´ÂÆå‰∫ÜÂæå„Å´„Ç≠„É£„É©„ÇØ„Çø„ÉºÈÖçÁΩÆUI„ÇíË°®Á§∫
                if (currentMode === 'race' && raceSelectedChars.length > 0) {
                    setTimeout(() => {
                        showCharPlacementUI();
                    }, 500);
                }
            }, 800);
        }

        // ÈÖçÂàó„Çí„Ç∑„É£„ÉÉ„Éï„É´„Åô„ÇãÈñ¢Êï∞
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function isPositionSafe(ladders, col, level) {
            let dirtyLeft = ladders.some(l => l.level === level - 1 && (
                (l.type === 'right_down' && l.colIndex === col - 1) ||
                (l.type === 'left_down' && l.colIndex === col)
            ));

            let dirtyRight = ladders.some(l => l.level === level - 1 && (
                (l.type === 'right_down' && l.colIndex === col) ||
                (l.type === 'left_down' && l.colIndex === col + 1)
            ));

            return !(dirtyLeft || dirtyRight);
        }

        function createLadders(count, steps) {
            const memberCount = count || players.length;
            const stepCount = steps || (currentMode === 'normal' ? 24 : 50);

            // 1%„ÅÆÁ¢∫Áéá„ÅßÁâπÊÆä„Ç≥„Éº„ÇπÔºà„Åù„Çå„Åû„Çå1%Ôºâ
            let specialRoll = Math.random();

            // „Ç´„Éº„Éñ„Å†„Åë„ÅÆÂ§ßÈáè„Ç≥„Éº„ÇπÔºà1%Ôºâ
            if (specialRoll < 0.01) {
                ladders = [];
                let curveCount = Math.floor(stepCount / 5);
                for (let i = 0; i < curveCount; i++) {
                    let col = Math.floor(Math.random() * (memberCount - 1));
                    let level = 2 + Math.floor(Math.random() * (stepCount - 6));
                    let type = Math.random() < 0.5 ? 'right_down' : 'left_down';

                    // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
                    let overlap = ladders.some(l =>
                        Math.abs(l.level - level) < 4 && Math.abs(l.colIndex - col) < 2
                    );
                    if (!overlap) {
                        ladders.push({ colIndex: col, level: level, type: type });
                    }
                }
                if (checkUniqueGoals(memberCount, stepCount)) return;
            }

            // ÂçäÊúà„Å†„Åë„ÅÆÂ§ßÈáè„Ç≥„Éº„ÇπÔºà1%Ôºâ
            if (Math.random() < 0.01) {
                ladders = [];
                let halfMoonCount = Math.floor(stepCount / 5);
                let placedLevels = [];

                for (let i = 0; i < halfMoonCount; i++) {
                    let col = Math.floor(Math.random() * memberCount);
                    let level = 2 + Math.floor(Math.random() * (stepCount - 6));

                    // ÊñπÂêëÊ±∫ÂÆö
                    let direction;
                    if (col === 0) direction = 'left';
                    else if (col === memberCount - 1) direction = 'right';
                    else direction = Math.random() < 0.5 ? 'left' : 'right';

                    // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
                    let overlap = placedLevels.some(pl => Math.abs(pl - level) < 4);
                    if (!overlap) {
                        ladders.push({
                            colIndex: col,
                            level: level,
                            type: direction === 'left' ? 'half_moon_left' : 'half_moon_right',
                            targetCol: col
                        });
                        placedLevels.push(level);

                        // ÂÜÖÂÅ¥„Å´Ê©ã1Êú¨ËøΩÂä†
                        let innerCol = (direction === 'left') ? col : col - 1;
                        if (innerCol >= 0 && innerCol < memberCount - 1) {
                            ladders.push({ colIndex: innerCol, level: level + 2, type: 'normal' });
                        }
                    }
                }
                if (checkUniqueGoals(memberCount, stepCount)) return;
            }

            // Á∑ö„Åå‰∏ÄÊú¨„ÇÇ„Å™„ÅÑ„Ç≥„Éº„ÇπÔºà1%Ôºâ
            if (Math.random() < 0.01) {
                ladders = [];
                // ‰Ωï„ÇÇÈÖçÁΩÆ„Åó„Å™„ÅÑ ‚Üí ÂÖ®Âì°„Åæ„Å£„Åô„Åê‰∏ã„Å´ËêΩ„Å°„Çã
                return;
            }

            // 1%„ÅÆÁ¢∫Áéá„Åß‰∏ÄÊú¨ÈÅì„Éë„Çø„Éº„É≥
            if (Math.random() < 0.01) {
                ladders = [];
                // ÂêÑÂàó„Å´1Êú¨„Å†„Åë
                for (let col = 0; col < memberCount - 1; col++) {
                    const level = Math.floor(Math.random() * stepCount);
                    ladders.push({ colIndex: col, level: level, type: 'normal' });
                }
                if (checkUniqueGoals(memberCount, stepCount)) {
                    return;
                }
            }

            // 5%„ÅÆÁ¢∫Áéá„ÅßÂ§â„Å™„Éë„Çø„Éº„É≥Ôºà„Éê„É©„É≥„ÇπÁÑ°Ë¶ñÔºâ
            const isWeirdPattern = Math.random() < 0.05;

            let maxAttempts = 50;
            let attempt = 0;

            while (attempt < maxAttempts) {
                attempt++;
                ladders = [];

                // „Åæ„Åö„Ç´„Éº„Éñ„ÇíÈÖçÁΩÆ
                let curveCount = 0;
                let curveRanges = [];

                // 10%„ÅÆÁ¢∫Áéá„ÅßÂêå„ÅòÊñπÂêë„ÅÆ2ÈÄ£Á∂ö„Ç´„Éº„Éñ„ÇíÈÖçÁΩÆ
                if (Math.random() < 0.1) {
                    let curveType = (Math.random() > 0.5) ? 'right_down' : 'left_down';
                    let firstLevel = 2 + Math.floor(Math.random() * (stepCount - 10));

                    // 1„Å§ÁõÆ„ÅÆ„Ç´„Éº„Éñ
                    ladders.push({ colIndex: 0, level: firstLevel, type: curveType });
                    curveRanges.push({ colIndex: 0, level: firstLevel, type: curveType });

                    // 2„Å§ÁõÆ„ÅÆ„Ç´„Éº„ÉñÔºà1„Çπ„ÉÜ„ÉÉ„Éó„Åö„Çâ„ÅóÔºâ
                    ladders.push({ colIndex: 0, level: firstLevel + 1, type: curveType });
                    curveRanges.push({ colIndex: 0, level: firstLevel + 1, type: curveType });

                    curveCount = 2;
                }

                // Âêå„Åò„É¨„Éô„É´„ÅßÈö£Êé•Âàó„Å´Ê©ã„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàÂßãÁÇπ„ÉªÁµÇÁÇπ„ÅÆ‰∏°ÊñπÔºâ
                function hasAdjacentBridgeAtLevel(col, level) {
                    return ladders.some(l => {
                        // ÈÄöÂ∏∏Ê©ã„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                        if (l.type === 'normal') {
                            if (l.level === level && (l.colIndex === col - 1 || l.colIndex === col + 1)) {
                                return true;
                            }
                        }
                        // „Ç´„Éº„Éñ„ÅÆÂßãÁÇπ„ÉªÁµÇÁÇπ„ÉÅ„Çß„ÉÉ„ÇØ
                        if (l.type === 'right_down' || l.type === 'left_down') {
                            let curveStartLevel = l.level;
                            let curveEndLevel = l.level + 3;
                            // Èö£Êé•Âàó„ÅÆ„Ç´„Éº„Éñ„ÅÆÂßãÁÇπ„Åæ„Åü„ÅØÁµÇÁÇπ„ÅåÂêå„Åò„É¨„Éô„É´
                            if (l.colIndex === col - 1 || l.colIndex === col + 1) {
                                if (level === curveStartLevel || level === curveEndLevel) {
                                    return true;
                                }
                            }
                        }
                        return false;
                    });
                }

                // ÈÄöÂ∏∏„ÅÆ„Ç´„Éº„ÉñÈÖçÁΩÆ
                let maxCurves = (memberCount === 2) ? 4 : Math.floor(memberCount * 2);

                for (let s = 0; s < stepCount - 4; s++) {
                    for (let i = 0; i < memberCount - 1; i++) {
                        // „Ç´„Éº„Éñ„ÅÆÁ¢∫Áéá
                        let curveChance;
                        if (memberCount === 2) {
                            curveChance = (curveCount === 0) ? 0.25 : 0.12;
                        } else {
                            curveChance = (curveCount === 0) ? 0.18 : 0.08;
                        }

                        if (Math.random() < curveChance && curveCount < maxCurves) {
                            // „Ç´„Éº„Éñ„ÅÆÊñπÂêë„ÅØÂÆåÂÖ®„É©„É≥„ÉÄ„É†
                            let curveType = (Math.random() > 0.5) ? 'right_down' : 'left_down';

                            // „Ç´„Éº„Éñ„ÅÆÂßãÁÇπ„ÉªÁµÇÁÇπ„ÅßÈö£Êé•„ÉÅ„Çß„ÉÉ„ÇØ
                            let curveStartLevel = s;
                            let curveEndLevel = s + 3;
                            if (hasAdjacentBridgeAtLevel(i, curveStartLevel) ||
                                hasAdjacentBridgeAtLevel(i, curveEndLevel)) {
                                continue;
                            }

                            // „Ç´„Éº„Éñ„ÅÆÁØÑÂõ≤ÂÜÖÔºàÂßãÁÇπ„ÄúÁµÇÁÇπÔºâ„Å´Êó¢Â≠ò„Çπ„Éà„É¨„Éº„Éà„Åå„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                            let hasBlockingBridge = ladders.some(l => {
                                if (l.type !== 'normal') return false;
                                // „Ç´„Éº„Éñ„ÅÆÁØÑÂõ≤ÂÜÖ„ÅÆ„É¨„Éô„É´„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                                if (l.level >= curveStartLevel && l.level <= curveEndLevel) {
                                    // Âêå„ÅòcolIndex„Åæ„Åü„ÅØÈö£Êé•Âàó„Å´„Çπ„Éà„É¨„Éº„Éà„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØNG
                                    if (l.colIndex === i || l.colIndex === i - 1 || l.colIndex === i + 1) {
                                        return true;
                                    }
                                }
                                return false;
                            });

                            if (hasBlockingBridge) {
                                continue;
                            }

                            // Êó¢Â≠ò„Ç´„Éº„Éñ„Å®„ÅÆÂπ≤Ê∏â„ÉÅ„Çß„ÉÉ„ÇØ
                            let canPlace = true;
                            for (let curve of curveRanges) {
                                let cStart = curve.level;
                                let cEnd = curve.level + 3;
                                let cCol = curve.colIndex;
                                let cEndCol = (curve.type === 'right_down') ? cCol + 1 : cCol;

                                // Âêå„ÅòÂàó„Åæ„Åü„ÅØÈö£Êé•Âàó„ÅßÁØÑÂõ≤„ÅåË¢´„ÇãÂ†¥Âêà„ÅØNGÔºàÂêå„ÅòÊñπÂêë„Å™„ÇâËøë„Åè„Å¶„ÇÇOKÔºâ
                                if (i === cCol || i === cEndCol || i === cCol - 1 || i === cCol + 1) {
                                    if (curveType === curve.type) {
                                        // Âêå„ÅòÊñπÂêëÔºöÂÆåÂÖ®„Å´Èáç„Å™„ÇãÂ†¥Âêà„ÅÆ„ÅøNG
                                        if (s === cStart) {
                                            canPlace = false;
                                            break;
                                        }
                                    } else {
                                        // ÈÄÜÊñπÂêëÔºöÁØÑÂõ≤„ÅåË¢´„ÇãÂ†¥Âêà„ÅØNG
                                        if (s >= cStart - 5 && s <= cEnd + 2) {
                                            canPlace = false;
                                            break;
                                        }
                                    }
                                }
                            }

                            if (canPlace) {
                                ladders.push({ colIndex: i, level: s, type: curveType });
                                curveRanges.push({ colIndex: i, level: s, type: curveType });
                                curveCount++;

                                // 3„Å§‰ª•‰∏ä„ÅÆÈÅ∏ÊäûËÇ¢„ÅÆÂ†¥Âêà„ÄÅ„Ç´„Éº„Éñ„ÅÆÈö£„Å´„Éö„Ç¢„ÅÆ„Çπ„Éà„É¨„Éº„Éà„ÇíÈÖçÁΩÆ
                                // „Åì„Çå„Å´„Çà„Çä„Ç´„Éº„Éñ„Åå„Äå‰∏ã„Å´Âõû„Å£„Åü„ÄçÊÑü„Åò„ÅåÂá∫„Çã
                                if (memberCount >= 3) {
                                    // „Çπ„Éà„É¨„Éº„Éà„ÅÆcolIndexÊ±∫ÂÆö
                                    // right_down: ÁµÇÁÇπ„ÅØÂàói+1 ‚Üí „Çπ„Éà„É¨„Éº„Éà„ÅØ colIndex=i+1
                                    // left_down: ÁµÇÁÇπ„ÅØÂàói ‚Üí „Çπ„Éà„É¨„Éº„Éà„ÅØ colIndex=i-1
                                    let adjacentCol;
                                    if (curveType === 'right_down') {
                                        adjacentCol = i + 1;
                                    } else {
                                        adjacentCol = i - 1;
                                    }

                                    // ÂøÖÈ†à„ÉÅ„Çß„ÉÉ„ÇØ1: ÊúâÂäπÁØÑÂõ≤ÂÜÖ
                                    if (adjacentCol < 0 || adjacentCol >= memberCount - 1) {
                                        // ÁØÑÂõ≤Â§ñ„Å™„ÇâÈÖçÁΩÆ„Åó„Å™„ÅÑ
                                    }
                                    // ÂøÖÈ†à„ÉÅ„Çß„ÉÉ„ÇØ2: „Ç´„Éº„Éñ„Å®Âêå„ÅòcolIndex„Åß„Å™„ÅÑ
                                    else if (adjacentCol === i) {
                                        // Âêå„ÅòÁ©∫Èñì„Å™„ÇâÈÖçÁΩÆ„Åó„Å™„ÅÑ
                                    }
                                    else {
                                        // „Çπ„Éà„É¨„Éº„Éà„ÅÆlevel: „Ç´„Éº„Éñ„ÅÆ‰∏≠ÈñìÔºàs+2Ôºâ
                                        // sÔºàÂßãÁÇπÔºâ„ÇÑs+3ÔºàÁµÇÁÇπÔºâ„Å®Èáç„Å™„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´
                                        let midLevel = s + 2;

                                        // ÂøÖÈ†à„ÉÅ„Çß„ÉÉ„ÇØ3: ‰ªäËøΩÂä†„Åó„Åü„Ç´„Éº„Éñ„ÅÆÂßãÁÇπ„ÉªÁµÇÁÇπ„Å®Âêå„Åò„É¨„Éô„É´„Åß„Å™„ÅÑ
                                        if (midLevel === s || midLevel === s + 3) {
                                            // ÂßãÁÇπ„ÉªÁµÇÁÇπ„Å®Âêå„Åò„Å™„ÇâÈÖçÁΩÆ„Åó„Å™„ÅÑ
                                        }
                                        // ÂøÖÈ†à„ÉÅ„Çß„ÉÉ„ÇØ4: „Åù„ÅÆ„É¨„Éô„É´„Åå‰ªñ„ÅÆ„Ç´„Éº„Éñ„Å®Âπ≤Ê∏â„Åó„Å™„ÅÑ
                                        else {
                                            let conflictsCurve = curveRanges.some(curve => {
                                                if (curve.colIndex === i && curve.level === s) return false; // ‰ªäËøΩÂä†„Åó„Åü„Ç´„Éº„ÉñËá™‰Ωì„ÅØÈô§Â§ñ
                                                let cStart = curve.level;
                                                let cEnd = curve.level + 3;
                                                // adjacentCol„Åå„Ç´„Éº„Éñ„ÅÆÁØÑÂõ≤ÂÜÖ
                                                if (midLevel >= cStart && midLevel <= cEnd) {
                                                    if (adjacentCol === curve.colIndex ||
                                                        adjacentCol === curve.colIndex - 1 ||
                                                        adjacentCol === curve.colIndex + 1) {
                                                        return true;
                                                    }
                                                }
                                                // „Ç´„Éº„Éñ„ÅÆÂßãÁÇπ„ÉªÁµÇÁÇπ„Å®Âêå„Åò„É¨„Éô„É´„ÇÇÈÅø„Åë„Çã
                                                if (midLevel === cStart || midLevel === cEnd) {
                                                    if (adjacentCol === curve.colIndex ||
                                                        adjacentCol === curve.colIndex - 1 ||
                                                        adjacentCol === curve.colIndex + 1) {
                                                        return true;
                                                    }
                                                }
                                                return false;
                                            });

                                            // ÂøÖÈ†à„ÉÅ„Çß„ÉÉ„ÇØ5: Êó¢Â≠ò„ÅÆÊ©ã„Å®„ÅÆË°ùÁ™Å
                                            let occupied = ladders.some(l =>
                                                l.level === midLevel &&
                                                (l.colIndex === adjacentCol ||
                                                 l.colIndex === adjacentCol - 1 ||
                                                 l.colIndex === adjacentCol + 1)
                                            );

                                            // ÂøÖÈ†à„ÉÅ„Çß„ÉÉ„ÇØ6: ‰∏°ÊñπÂêëÈÅ∏ÊäûËÇ¢„ÇíÈò≤„Åê
                                            let hasAdjacent = hasAdjacentBridgeAtLevel(adjacentCol, midLevel);

                                            if (!conflictsCurve && !occupied && !hasAdjacent && midLevel < stepCount) {
                                                ladders.push({ colIndex: adjacentCol, level: midLevel, type: 'normal' });
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                // „Ç´„Éº„Éñ„Å®Âπ≤Ê∏â„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºà„Çπ„Éà„É¨„Éº„ÉàÁî®Ôºâ
                function conflictsWithCurve(col, level) {
                    for (let curve of curveRanges) {
                        let curveStart = curve.level;
                        let curveEnd = curve.level + 3;
                        let curveCol = curve.colIndex;

                        // „Ç´„Éº„Éñ„ÅÆÁØÑÂõ≤ÂÜÖÔºàÂßãÁÇπ„ÄúÁµÇÁÇπÔºâ„Åã„Å§Èñ¢ÈÄ£„Åô„ÇãÂàó„Å™„ÇâNG
                        if (level >= curveStart && level <= curveEnd) {
                            // „Ç´„Éº„Éñ„ÅÆÂàó„Å®„Åù„ÅÆ‰∏°Èö£„Çí„Éñ„É≠„ÉÉ„ÇØ
                            if (col === curveCol || col === curveCol - 1 || col === curveCol + 1) {
                                return true;
                            }
                        }
                    }
                    return false;
                }

                // Ê¨°„Å´„Çπ„Éà„É¨„Éº„Éà„ÇíÈÖçÁΩÆÔºà„Ç´„Éº„Éñ„Å®Âπ≤Ê∏â„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´Ôºâ
                let columnBridgeCount = new Array(memberCount - 1).fill(0);

                // „Ç´„Éº„Éñ„ÅÆÊï∞„ÇíÂàó„Åî„Å®„Å´„Ç´„Ç¶„É≥„Éà
                for (let curve of curveRanges) {
                    columnBridgeCount[curve.colIndex]++;
                }

                // Ëøë„Åè„ÅÆ„Çπ„Éà„É¨„Éº„ÉàÊï∞„Çí„Ç´„Ç¶„É≥„Éà„Åô„ÇãÈñ¢Êï∞
                function countNearbyBridges(col, level, range) {
                    let count = 0;
                    for (let checkLevel = Math.max(0, level - range); checkLevel <= Math.min(stepCount - 1, level + range); checkLevel++) {
                        if (checkLevel === level) continue; // Ëá™ÂàÜËá™Ë∫´„ÅØÈô§Â§ñ
                        if (ladders.some(l => l.type === 'normal' && l.level === checkLevel &&
                            (l.colIndex === col || l.colIndex === col - 1 || l.colIndex === col + 1))) {
                            count++;
                        }
                    }
                    return count;
                }

                for (let s = 0; s < stepCount; s++) {
                    for (let i = 0; i < memberCount - 1; i++) {
                        // „Ç´„Éº„Éñ„Å®Âπ≤Ê∏â„Åô„Çã„Å™„Çâ„Çπ„Ç≠„ÉÉ„Éó
                        if (conflictsWithCurve(i, s)) continue;

                        if (!isPositionSafe(ladders, i, s)) continue;

                        // Èö£Êé•Âàó„ÅÆÂêå„É¨„Éô„É´„Å´Ê©ã„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºà‰∏°ÊñπÂêëÈÅ∏ÊäûËÇ¢„ÇíÈò≤„ÅêÔºâ
                        if (hasAdjacentBridgeAtLevel(i, s)) continue;

                        // Êó¢Â≠ò„ÅÆÊ©ã„Å®„ÅÆË°ùÁ™Å„ÉÅ„Çß„ÉÉ„ÇØ
                        let occupied = ladders.some(l =>
                            (l.level === s && (l.colIndex === i || l.colIndex === i - 1 || l.colIndex === i + 1))
                        );

                        if (!occupied) {
                            // Ëøë„Åè„ÅÆ„Çπ„Éà„É¨„Éº„ÉàÊï∞„Å´Âøú„Åò„Å¶Á¢∫Áéá„Çí‰∏ã„Åí„Çã
                            let nearbyCount = countNearbyBridges(i, s, 3);
                            let baseProbability = 0.35;
                            // ÈÄ£Á∂öÊï∞„ÅåÂ¢ó„Åà„Çã„Åª„Å©Á¢∫ÁéáÊ∏õÂ∞ë: 0Êú¨‚Üí35%, 1Êú¨‚Üí23%, 2Êú¨‚Üí15%, 3Êú¨‚Üí10%, 4Êú¨‚Üí7%
                            let probability = baseProbability * Math.pow(0.65, nearbyCount);

                            if (Math.random() < probability) {
                                ladders.push({ colIndex: i, level: s, type: 'normal' });
                                columnBridgeCount[i]++;
                            }
                        }
                    }
                }

                // Â§â„Å™„Éë„Çø„Éº„É≥„Åß„Å™„Åë„Çå„Å∞„Éê„É©„É≥„ÇπË™øÊï¥
                if (!isWeirdPattern) {
                    // ÂêÑÂàó„Å´ÊúÄ‰Ωé3Êú¨„ÅÆÊ©ã„Çí‰øùË®º
                    const minBridgesPerColumn = Math.max(3, Math.floor(stepCount / 6));

                    for (let col = 0; col < memberCount - 1; col++) {
                        let attempts = 0;
                        while (columnBridgeCount[col] < minBridgesPerColumn && attempts < 30) {
                            attempts++;
                            const level = Math.floor(Math.random() * stepCount);

                            // „Ç´„Éº„Éñ„Å®Âπ≤Ê∏â„Åó„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                            if (conflictsWithCurve(col, level)) continue;

                            // Èö£Êé•Âàó„ÅÆÂêå„É¨„Éô„É´„Å´Ê©ã„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                            if (hasAdjacentBridgeAtLevel(col, level)) continue;

                            if (isPositionSafe(ladders, col, level)) {
                                let occupied = ladders.some(l =>
                                    l.level === level &&
                                    (l.colIndex === col || l.colIndex === col - 1 || l.colIndex === col + 1)
                                );
                                if (!occupied) {
                                    ladders.push({ colIndex: col, level: level, type: 'normal' });
                                    columnBridgeCount[col]++;
                                }
                            }
                        }
                    }

                    // ‰∏äÈÉ®„Éª‰∏≠ÈÉ®„Éª‰∏ãÈÉ®„Å´Ê©ã„Åå„ÅÇ„Çã„ÅãÁ¢∫Ë™ç
                    const areaSize = Math.floor(stepCount / 3);
                    const areas = [
                        { start: 0, end: areaSize },
                        { start: areaSize, end: areaSize * 2 },
                        { start: areaSize * 2, end: stepCount }
                    ];

                    for (let col = 0; col < memberCount - 1; col++) {
                        for (let area of areas) {
                            const hasBridgeInArea = ladders.some(l =>
                                l.colIndex === col && l.level >= area.start && l.level < area.end
                            );
                            if (!hasBridgeInArea) {
                                // „Ç´„Éº„Éñ„Å®Âπ≤Ê∏â„Åó„Å™„ÅÑ‰ΩçÁΩÆ„ÇíÊé¢„Åô
                                let placed = false;
                                for (let attempt = 0; attempt < 10 && !placed; attempt++) {
                                    const level = area.start + Math.floor(Math.random() * (area.end - area.start));
                                    if (!conflictsWithCurve(col, level) && !hasAdjacentBridgeAtLevel(col, level)) {
                                        let occupied = ladders.some(l =>
                                            l.level === level &&
                                            (l.colIndex === col || l.colIndex === col - 1 || l.colIndex === col + 1)
                                        );
                                        if (!occupied) {
                                            ladders.push({ colIndex: col, level: level, type: 'normal' });
                                            placed = true;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                // ÂçäÊúà„É©„Ç§„É≥„ÅÆÈÖçÁΩÆÔºà3„Å§‰ª•‰∏ä„ÅÆÈÅ∏ÊäûËÇ¢„ÅÆÂ†¥Âêà„ÅÆ„ÅøÔºâ
                if (memberCount >= 3) {
                    let placedHalfMoons = [];

                    for (let col = 0; col < memberCount; col++) {
                        if (Math.random() > 0.8) continue;

                        // ÊñπÂêë„ÇíÊ±∫ÂÆöÔºà‰∏°Á´Ø„ÅØÂ§ñÂÅ¥„ÅÆ„Åø„ÄÅ‰∏≠Èñì„ÅØ„É©„É≥„ÉÄ„É†Ôºâ
                        let direction;
                        if (col === 0) direction = 'left';
                        else if (col === memberCount - 1) direction = 'right';
                        else direction = Math.random() < 0.5 ? 'left' : 'right';

                        // Â§ñÂÅ¥ÔºàËÜ®„Çâ„ÇÄÂÅ¥Ôºâ„Å®ÂÜÖÂÅ¥„ÅÆÊ©ãÂàó
                        let outerCol = (direction === 'left') ? col - 1 : col;
                        let innerCol = (direction === 'left') ? col : col - 1;

                        // ÈÖçÁΩÆÂèØËÉΩ„Å™„É¨„Éô„É´„Çí„Åô„Åπ„Å¶ÂèéÈõÜ
                        let validLevels = [];

                        for (let level = 2; level < stepCount - 5; level++) {
                            let startLevel = level;
                            let endLevel = level + 3;

                            // ‰ªñ„ÅÆÂçäÊúà„Å®Èáç„Å™„Çâ„Å™„ÅÑ„ÅãÔºà„É¨„Éô„É´Â∑Æ3‰ª•‰∏äÂøÖË¶ÅÔºâ
                            let tooClose = placedHalfMoons.some(hm =>
                                Math.abs(hm.level - level) < 4
                            );
                            if (tooClose) continue;

                            // ÂßãÁÇπ„ÉªÁµÇÁÇπ„Å´Ê©ã„Åå„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                            let hasStartEndBridge = ladders.some(l => {
                                if (l.type !== 'normal') return false;
                                if (l.level !== startLevel && l.level !== endLevel) return false;
                                return (l.colIndex === col || l.colIndex === col - 1);
                            });
                            if (hasStartEndBridge) continue;

                            // Â§ñÂÅ¥„ÅÆÁØÑÂõ≤ÂÜÖ„Å´Ê©ã„Åå„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                            if (outerCol >= 0 && outerCol < memberCount - 1) {
                                let hasOuterBridge = ladders.some(l =>
                                    l.type === 'normal' &&
                                    l.colIndex === outerCol &&
                                    l.level > startLevel &&
                                    l.level < endLevel
                                );
                                if (hasOuterBridge) continue;
                            }

                            // „Ç´„Éº„Éñ„Å®„ÅÆÂπ≤Ê∏â„ÉÅ„Çß„ÉÉ„ÇØ
                            let hasCurveConflict = ladders.some(l => {
                                if (l.type !== 'right_down' && l.type !== 'left_down') return false;
                                let curveStart = l.level;
                                let curveEnd = l.level + 3;
                                if (l.colIndex === col || l.colIndex === col - 1) {
                                    return !(endLevel < curveStart || startLevel > curveEnd);
                                }
                                return false;
                            });
                            if (hasCurveConflict) continue;

                            // ÂÜÖÂÅ¥„ÅÆÊ©ã„ÉÅ„Çß„ÉÉ„ÇØ
                            if (innerCol >= 0 && innerCol < memberCount - 1) {
                                let bridgesInRange = ladders.filter(l =>
                                    l.type === 'normal' &&
                                    l.colIndex === innerCol &&
                                    l.level > startLevel &&
                                    l.level < endLevel
                                );

                                // 0Êú¨„ÅÆÂ†¥Âêà„ÄÅËøΩÂä†ÂèØËÉΩ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                                if (bridgesInRange.length === 0) {
                                    let midLevel = level + 2;
                                    let canAdd = !ladders.some(l =>
                                        l.type === 'normal' &&
                                        l.level === midLevel &&
                                        (l.colIndex === innerCol - 1 || l.colIndex === innerCol + 1)
                                    );
                                    if (!canAdd) continue;
                                }

                                validLevels.push(level);
                            }
                        }

                        // ÈÖçÁΩÆÂèØËÉΩ„Å™„É¨„Éô„É´„Åå„ÅÇ„Çå„Å∞„É©„É≥„ÉÄ„É†„Å´ÈÅ∏Êäû
                        if (validLevels.length > 0) {
                            let level = validLevels[Math.floor(Math.random() * validLevels.length)];
                            let startLevel = level;
                            let endLevel = level + 3;

                            // ÂÜÖÂÅ¥„ÅÆÊ©ã„ÇíË™øÊï¥
                            if (innerCol >= 0 && innerCol < memberCount - 1) {
                                let bridgesInRange = ladders.filter(l =>
                                    l.type === 'normal' &&
                                    l.colIndex === innerCol &&
                                    l.level > startLevel &&
                                    l.level < endLevel
                                );

                                if (bridgesInRange.length > 1) {
                                    let keepBridge = bridgesInRange[Math.floor(bridgesInRange.length / 2)];
                                    ladders = ladders.filter(l => {
                                        if (l.type !== 'normal' || l.colIndex !== innerCol) return true;
                                        if (l.level > startLevel && l.level < endLevel) {
                                            return l === keepBridge;
                                        }
                                        return true;
                                    });
                                }

                                if (bridgesInRange.length === 0) {
                                    let midLevel = level + 2;
                                    ladders.push({ colIndex: innerCol, level: midLevel, type: 'normal' });
                                }
                            }

                            ladders.push({
                                colIndex: col,
                                level: level,
                                type: direction === 'left' ? 'half_moon_left' : 'half_moon_right',
                                targetCol: col
                            });
                            placedHalfMoons.push({ col: col, level: level });
                        }
                    }
                }

                // ÂÖ®Âì°„ÅÆ„Ç¥„Éº„É´„Çí„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„Åó„Å¶ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
                if (checkUniqueGoals(memberCount, stepCount)) {
                    return;
                }
            }
        }

        // ÂÖ®Âì°„ÅÆ„Ç¥„Éº„É´„Çí„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„Åó„Å¶ÈáçË§á„Åå„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        // ÂêÑ„Éó„É¨„Ç§„É§„Éº„ÅÆ‰∫àÊ∏¨„Ç¥„Éº„É´Âàó„Çí‰øùÂ≠ò
        let predictedGoals = []; // startIdx -> goalColIdx

        function checkUniqueGoals(memberCount, stepCount) {
            let goals = [];
            predictedGoals = [];

            for (let startIdx = 0; startIdx < memberCount; startIdx++) {
                let xIdx = startIdx;
                let lvl = 0;

                while (lvl < stepCount) {
                    // ÂçäÊúà„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÔºàtargetCol„Çí‰ΩøÁî®Ôºâ
                    let halfMoon = ladders.find(l =>
                        (l.type === 'half_moon_left' || l.type === 'half_moon_right') &&
                        l.level === lvl &&
                        l.targetCol === xIdx
                    );

                    if (halfMoon) {
                        // ÂçäÊúà„ÅØÂêå„ÅòÂàó„Å´Êàª„Çã„ÅÆ„Åß xIdx „ÅØÂ§â„Çè„Çâ„Å™„ÅÑ„ÄÅ3„É¨„Éô„É´ÈÄ≤„ÇÄ
                        lvl += 3;
                        continue;
                    }

                    // Âè≥„Å∏„ÅÆÊ©ãÔºànormal „Åæ„Åü„ÅØ right_downÔºâ
                    let rightBridge = ladders.find(l =>
                        l.colIndex === xIdx && l.level === lvl &&
                        (l.type === 'normal' || l.type === 'right_down')
                    );

                    // Â∑¶„Å∏„ÅÆÊ©ãÔºànormal „Åæ„Åü„ÅØ left_downÔºâ
                    let leftBridge = ladders.find(l =>
                        l.colIndex === xIdx - 1 && l.level === lvl &&
                        (l.type === 'normal' || l.type === 'left_down')
                    );

                    // Âè≥‰∏ã„Åã„Çâ„ÅÆÂÖ•Âäõ
                    let incomingRightDown = ladders.find(l =>
                        l.colIndex === xIdx - 1 && l.level === lvl && l.type === 'right_down'
                    );

                    // Â∑¶‰∏ã„Åã„Çâ„ÅÆÂÖ•Âäõ
                    let incomingLeftDown = ladders.find(l =>
                        l.colIndex === xIdx && l.level === lvl && l.type === 'left_down'
                    );

                    if (rightBridge) {
                        xIdx++;
                        if (rightBridge.type === 'right_down') lvl += 2; // „Ç´„Éº„Éñ„ÅØËøΩÂä†„Åß2„É¨„Éô„É´ÈÄ≤„ÇÄ
                    } else if (leftBridge) {
                        xIdx--;
                        if (leftBridge.type === 'left_down') lvl += 2;
                    } else if (incomingRightDown) {
                        xIdx--;
                    } else if (incomingLeftDown) {
                        xIdx++;
                    }

                    lvl++;
                }

                goals.push(xIdx);
                predictedGoals[startIdx] = xIdx;
            }

            // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
            let uniqueGoals = new Set(goals);
            return uniqueGoals.size === memberCount;
        }

        function handleActionBtn() {
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÅúÊ≠¢
            isAnimating = false;
            if(animationId) cancelAnimationFrame(animationId);

            // ÁßªÂãïÈü≥„ÇíÂÅúÊ≠¢
            stopMoveSound();

            // „Åæ„Å†‰∏Ä„Å§„ÇÇÈÅ∏Êäû„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØË≥™Âïè„Å™„Åó„Åß„Ç≥„Éº„ÇπÂ§âÊõ¥
            if (startedPlayerCount === 0) {
                playShuffleEffect(() => shuffleLadders());
                return;
            }

            // ÈÅ∏ÊäûÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅØ„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÅßÁ¢∫Ë™ç
            showConfirm('„Ç≥„Éº„Çπ„Çí‰Ωú„ÇäÂ§â„Åà„Åæ„Åô„ÅãÔºü',
                () => {
                    playShuffleEffect(() => shuffleLadders());
                },
                () => {
                    resetResults();
                },
                'üîÑ',
                '‰Ωú„ÇäÂ§â„Åà„Çã',
                '„ÇÇ„ÅÜ‰∏ÄÂ∫¶'
            );
        }

        // „Ç∑„É£„ÉÉ„Éï„É´„Ç®„Éï„Çß„ÇØ„ÉàÔºàËôπËâ≤„Éï„É©„ÉÉ„Ç∑„É•ÔºÜ„Ç≠„É©„Ç≠„É©Ôºâ
        function playShuffleEffect(callback) {
            playButtonSound();

            // „Éï„É©„ÉÉ„Ç∑„É•„Ç™„Éº„Éê„Éº„É¨„Ç§‰ΩúÊàê
            let flash = document.createElement('div');
            flash.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: linear-gradient(45deg, #00ffff, #ff00ff, #ffff00, #00ff00);
                opacity: 0; z-index: 9999; pointer-events: none;
                animation: shuffleFlash 0.6s ease-out forwards;
            `;
            document.body.appendChild(flash);

            // ËôπËâ≤„Åå‰∏ÄÁï™ÊøÉ„ÅÑÊôÇÔºà120msÂæåÔºâ„Å´„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÂÆüË°å
            setTimeout(() => {
                if (callback) callback();
            }, 120);

            // „Ç≠„É©„Ç≠„É©„Éë„Éº„ÉÜ„Ç£„ÇØ„É´
            for (let i = 0; i < 30; i++) {
                let star = document.createElement('div');
                let x = Math.random() * 100;
                let y = Math.random() * 100;
                let size = 10 + Math.random() * 20;
                let hue = Math.random() * 360;
                star.innerHTML = '‚ú¶';
                star.style.cssText = `
                    position: fixed; left: ${x}%; top: ${y}%;
                    font-size: ${size}px; color: hsl(${hue}, 100%, 70%);
                    z-index: 10000; pointer-events: none; opacity: 0;
                    text-shadow: 0 0 10px hsl(${hue}, 100%, 50%);
                    animation: starBurst 0.8s ${Math.random() * 0.2}s ease-out forwards;
                `;
                document.body.appendChild(star);
                setTimeout(() => star.remove(), 1200);
            }

            setTimeout(() => flash.remove(), 700);
        }

        function resetResults() {
            cancelAnimationFrame(animationId);
            isAnimating = false;
            startedPlayerCount = 0;
            document.getElementById('curtain').style.opacity = 0;

            if (typeof confetti === 'function') confetti.reset();

            // „Çø„É≥„ÇØ„Çí„É™„Çª„ÉÉ„Éà
            resetTanks();

            // ÈÄüÂ∫¶„ÅØÁ∂≠ÊåÅÔºà„É™„Çª„ÉÉ„Éà„Åó„Å™„ÅÑÔºâ

            players.forEach(p => {
                p.xIdx = p.id;
                p.y = topMargin;
                p.state = 'idle';
                p.nextXIdx = undefined;
                p.sliding = false;
                p.slidingUp = false;
                p.slidingHalfMoon = false;
                p.hasTurnedAtLevel = -1;
                p.moveProgress = 0;
                p.reported = false;
                p.scale = 0;
                p.currentSpeed = 6.3;
                p.reactedEndpoints = new Set();  // ÂèçÂøúÊ∏à„ÅøÁµÇÁÇπ„Çí„É™„Çª„ÉÉ„Éà
                p.cameFromCurve = false;
                p.curveExitY = undefined;
                let startX = (p.xIdx * columnWidth) + (columnWidth / 2);
                p.trail = [{x: startX, y: topMargin}, {x: startX, y: topMargin}];
            });

            const btnLayer = document.getElementById('buttonLayer');
            btnLayer.innerHTML = '';

            const count = players.length;
            const FIXED_MAX_COLUMNS = 8;
            const rawSize = Math.floor((window.innerWidth - 10) / FIXED_MAX_COLUMNS);
            const calculatedSize = Math.floor(rawSize * 0.9);
            const btnSize = calculatedSize + 'px';

            if (currentMode === 'normal') {
                for(let i=0; i<count; i++) {
                    let startX = (i * columnWidth) + (columnWidth / 2);
                    const btn = document.createElement('button');
                    btn.className = 'marble-btn';
                    btn.style.setProperty('--btn-color', colors[i]);
                    btn.style.setProperty('--size', btnSize);
                    btn.style.left = (startX - calculatedSize/2) + 'px';
                    btn.onclick = (e) => startNormalEffect(e.currentTarget, i, colors[i]);
                    btnLayer.appendChild(btn);
                }
            } else {
                document.getElementById('raceBtn').style.display = 'block';
            }

            window.scrollTo({ top: 0, behavior: 'smooth' });
            drawFrame();
        }

        function shuffleLadders() {
            resetResults();
            const inputs = document.querySelectorAll('.goal-input');
            const count = inputs.length;
            let baseSteps = (currentMode === 'normal') ? 14 : 50;
            const extraSteps = (count - 2) * 5;
            const steps = baseSteps + extraSteps;

            // „Ç¥„Éº„É´„É©„Éô„É´„ÇíÂÜç„Ç∑„É£„ÉÉ„Éï„É´
            let inputLabels = [];
            for(let i=0; i<count; i++) {
                let val = inputs[i].value.trim();
                if (!val) val = inputs[i].placeholder;
                inputLabels.push(val);
            }
            shuffledGoalLabels = shuffleArray([...inputLabels]);
            goalLabels = shuffledGoalLabels;

            // „Çø„É≥„ÇØ„ÅÆ„É©„Éô„É´„ÇíÊõ¥Êñ∞
            tankElements.forEach((tankData, i) => {
                const label = tankData.tank.querySelector('.label');
                if (label) {
                    if (blindMode === 'goal') {
                        label.textContent = '?';
                        label.dataset.realLabel = goalLabels[i];
                    } else {
                        label.textContent = goalLabels[i];
                    }
                }
            });

            // „Ç´„Éº„ÉÜ„É≥„ÅÆË°®Á§∫/ÈùûË°®Á§∫
            const curtain = document.getElementById('curtain');
            if (blindMode === 'curtain') {
                curtain.style.opacity = 1;
            } else {
                curtain.style.opacity = 0;
            }

            createLadders(count, steps);
            drawFrame();
        }

        function startNormalEffect(btn, index, color) {
            if(btn.classList.contains('is-squeezing')) return;

            btn.disabled = true;

            // „Éú„Çø„É≥ÂäπÊûúÈü≥
            playButtonSound();

            // „Éó„É¨„Ç§„É§„Éº„Å´ÈñãÂßãÈ†ÜÂ∫è„ÇíË®òÈå≤
            players[index].startOrder = startedPlayerCount;

            // ÊúÄÂæå„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÊäº„Åó„ÅüÁû¨Èñì„Å´„Ç´„Éº„ÉÜ„É≥„ÇíÊ∂à„ÅôÔºà„Ç´„Éº„ÉÜ„É≥„É¢„Éº„Éâ„ÅÆ„ÅøÔºâ
            startedPlayerCount++;
            if (startedPlayerCount >= players.length && blindMode === 'curtain') {
                document.getElementById('curtain').style.opacity = 0;
            }

            btn.classList.add('is-squeezing');
            const baseDuration = parseFloat(getComputedStyle(document.body).getPropertyValue('--anim-duration')) * 1000;

            // „Éú„Çø„É≥„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®„ÅÆÈÄüÂ∫¶ÂÄçÁéáÔºà2x‚Üí1.5ÂÄçÈÄü„ÄÅ4x‚Üí2ÂÄçÈÄüÔºâ
            const btnSpeedMultiplier = getButtonAnimSpeed();
            const duration = baseDuration / btnSpeedMultiplier;

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈÄüÂ∫¶„ÇÇË™øÊï¥
            btn.style.animationDuration = (baseDuration / btnSpeedMultiplier / 1000) + 's';

            setTimeout(() => {
                popAndDrop(btn, index, color);
            }, duration);
        }

        // „Éú„Çø„É≥„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®„ÅÆÈÄüÂ∫¶ÂÄçÁéá„ÇíÂèñÂæó
        function getButtonAnimSpeed() {
            if (currentSpeedMultiplier === 2) {
                return 1.5;
            } else if (currentSpeedMultiplier === 4) {
                return 2;
            }
            return 1;
        }

        function popAndDrop(btn, index, color) {
            btn.classList.remove('is-squeezing');
            btn.classList.add('is-popped');

            const rect = btn.getBoundingClientRect();
            const originalSize = rect.width;
            const ballSize = originalSize * 0.4;

            const ball = document.createElement('div');
            ball.className = 'drop-ball';
            ball.style.width = ballSize + 'px';
            ball.style.height = ballSize + 'px';
            ball.style.setProperty('--ball-color', color);

            const layerRect = document.getElementById('buttonLayer').getBoundingClientRect();
            const centerX = rect.left - layerRect.left + rect.width / 2;
            const centerY = rect.top - layerRect.top + rect.height / 2;

            ball.style.left = (centerX - ballSize/2) + 'px';
            ball.style.top = (centerY - ballSize/2) + 'px';

            document.getElementById('buttonLayer').appendChild(ball);

            const jumpHeight = 20;
            const dropDistance = 40;
            const baseTotalDuration = 500;

            // „Éú„Çø„É≥„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®„ÅÆÈÄüÂ∫¶ÂÄçÁéá
            const btnSpeedMultiplier = getButtonAnimSpeed();
            const totalDuration = baseTotalDuration / btnSpeedMultiplier;

            const anim = ball.animate([
                { transform: `translateY(0) rotate(0deg) scale(1)`, easing: 'cubic-bezier(0.1, 0.9, 0.2, 1)' },
                { transform: `translateY(-${jumpHeight}px) rotate(180deg) scale(1)`, offset: 0.35, easing: 'cubic-bezier(0.8, 0, 1, 1)' },
                { transform: `translateY(${dropDistance}px) rotate(360deg) scale(1)` }
            ], {
                duration: totalDuration,
                fill: 'forwards'
            });

            anim.onfinish = () => {
                btn.style.visibility = 'hidden';
                ball.remove();
                startAmidaLogic(index);
            };
        }

        function startAmidaLogic(index) {
            players[index].state = 'moving';
            isAnimating = true;

            // ÁßªÂãïÈü≥„ÇíÈñãÂßã
            startMoveSound();

            if(!animationId) animateLoop();
        }

        function startRaceRun() {
            if (isAnimating) return;

            // „Ç≠„É£„É©„ÇØ„Çø„Éº„Å®„Éó„É¨„Ç§„É§„Éº„Çí„É™„É≥„ÇØ
            if (raceSelectedChars.length > 0) {
                for (let i = 0; i < startLineAssignments.length; i++) {
                    const charObj = startLineAssignments[i];
                    if (charObj && players[i]) {
                        // char„ÅØÁµµÊñáÂ≠óË°®Á§∫Áî®„ÄÅcharInfo„ÅØÂÆåÂÖ®„Å™„Ç≠„É£„É©„ÇØ„Çø„ÉºÊÉÖÂ†±
                        players[i].char = charObj.animal;
                        players[i].charInfo = charObj;
                    }
                }
            }

            // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ÊºîÂá∫
            startRaceCountdown();
        }

        function actuallyStartRace() {
            document.getElementById('raceBtn').style.display = 'none';
            players.forEach(p => p.state = 'moving');
            isAnimating = true;
            document.getElementById('curtain').style.opacity = 0;

            // ÁßªÂãïÈü≥„ÇíÈñãÂßã
            startMoveSound();

            animateLoop();
        }

        function animateLoop() {
            let activeCount = 0;
            let targetY = 0;

            const MAX_SPEED = (currentMode === 'normal') ? 20 : 15;

            // Êó©ÈÄÅ„ÇäÂÄçÁéá„ÅÆÂõûÊï∞„Å†„ÅëÁßªÂãïÂá¶ÁêÜ„ÇíÁπ∞„ÇäËøî„ÅôÔºàÊ§úÂá∫Êºè„ÇåÈò≤Ê≠¢Ôºâ
            let iterations = Math.round(currentSpeedMultiplier);

            players.forEach(p => {
                if (p.state === 'moving') {
                    if (p.scale < 1) {
                        p.scale += 0.25;
                        if(p.scale > 1) p.scale = 1;
                    }

                    activeCount++;

                    // Êó©ÈÄÅ„ÇäÂÄçÁéá„ÅÆÂõûÊï∞„Å†„ÅëÁßªÂãï„ÇíÁπ∞„ÇäËøî„Åô
                    for (let i = 0; i < iterations; i++) {
                        if (p.state !== 'moving') break; // ÈÄî‰∏≠„ÅßÁµÇ‰∫Ü„Åó„ÅüÂ†¥Âêà

                        if (p.sliding) {
                            // Êñú„ÇÅ (4.0Âü∫Ê∫ñ)
                            if (p.slideTargetY > p.slideStartY) {
                                // ‰∏ã„Çä: 5.0„Åæ„ÅßÂä†ÈÄü
                                if (p.currentSpeed < 5.0) {
                                    p.currentSpeed += 0.04;
                                }
                            } else {
                                // ‰∏ä„Çä
                            }
                        }
                        else if (p.nextXIdx === undefined) {
                            // Á∏¶ÁßªÂãï (Áõ¥Á∑ö„Å†„ÅëÂä†ÈÄü)
                            if (p.currentSpeed < 6.3) p.currentSpeed = 6.3;
                            if (p.currentSpeed < MAX_SPEED) {
                                p.currentSpeed += 0.05;
                            }
                        }
                        // Ê®™ÁßªÂãï„ÅØ movePlayerÂÜÖ„Åß 4.0 Âõ∫ÂÆö

                        // 1ÂÄçÈÄü„ÅÆÈÄüÂ∫¶„ÅßÁßªÂãïÔºàÂÄçÁéá„ÅØÁπ∞„ÇäËøî„ÅóÂõûÊï∞„ÅßÂØæÂøúÔºâ
                        movePlayer(p, p.currentSpeed);
                    }

                    if (p.y > targetY) targetY = p.y;
                }
            });

            drawFrame();

            if (targetY > 0) {
                let targetScroll = targetY - (window.innerHeight / 3);
                if (targetScroll < 0) targetScroll = 0;

                // „Ç¥„Éº„É´Áõ¥Ââç„ÅÆ„Çπ„ÇØ„É≠„Éº„É´‰∏äÈôêË™øÊï¥
                let logicHeight = canvas.height / dpr;
                players.forEach(p => {
                    if (p.state === 'moving') {
                        // ‰∫àÊ∏¨„Ç¥„Éº„É´Âàó„Åã„Çâ„Ç¥„Éº„É´Y‰ΩçÁΩÆ„ÇíË®àÁÆó
                        let goalCol = predictedGoals[p.id];
                        if (goalCol === undefined) goalCol = p.xIdx;

                        let tankBottomY;
                        if (players.length <= 3) {
                            tankBottomY = logicHeight - 120;
                        } else if (players.length >= 6 && (goalCol === 0 || goalCol === players.length - 1)) {
                            tankBottomY = logicHeight - 60;
                        } else {
                            let isLong = (goalCol % 2 === 0);
                            tankBottomY = logicHeight - (isLong ? 120 : 180);
                        }
                        let finishY = tankBottomY - tankHeight;

                        // „Ç¥„Éº„É´„Åæ„ÅßÊÆã„Çä100px‰ª•ÂÜÖ„Å´„Å™„Å£„Åü„Çâ‰∏äÈôêË®≠ÂÆö
                        if (finishY - p.y < 100) {
                            let maxScroll = finishY - window.innerHeight + 280;
                            if (maxScroll < 0) maxScroll = 0;
                            if (targetScroll > maxScroll) targetScroll = maxScroll;
                        }
                    }
                });

                let currentScroll = window.scrollY;
                let nextScroll = currentScroll + (targetScroll - currentScroll) * 0.05;
                if (Math.abs(targetScroll - currentScroll) < 1) {
                    window.scrollTo(0, targetScroll);
                } else {
                    window.scrollTo(0, nextScroll);
                }
            }

            if (activeCount > 0) {
                animationId = requestAnimationFrame(animateLoop);
            } else {
                isAnimating = false;
                cancelAnimationFrame(animationId);
                animationId = null;

                // ÁßªÂãïÈü≥„ÇíÂÅúÊ≠¢
                stopMoveSound();

                // ÈÄüÂ∫¶„ÅØÁ∂≠ÊåÅÔºà„É™„Çª„ÉÉ„Éà„Åó„Å™„ÅÑÔºâ

                showResult();
            }
        }

        function movePlayer(p, speed) {
            // Êñú„ÇÅ„Åæ„Åü„ÅØÂçäÊúà
            if (p.sliding) {
                let dx = p.slideTargetX - p.slideStartX;
                let dy = p.slideTargetY - p.slideStartY;
                let distance;

                // ÂçäÊúà„ÅÆÂ†¥Âêà„ÅØÊõ≤Á∑ö„ÅÆÈï∑„Åï„ÇíËøë‰ºº
                if (p.slidingHalfMoon) {
                    // ‰∫åÊ¨°„Éô„Ç∏„ÇßÊõ≤Á∑ö„ÅÆÈï∑„Åï„ÇíËøë‰ººÔºàÂà∂Âæ°ÁÇπÁµåÁî±Ôºâ
                    let cpDist1 = Math.sqrt(Math.pow(p.halfMoonCpX - p.slideStartX, 2) + Math.pow(p.halfMoonCpY - p.slideStartY, 2));
                    let cpDist2 = Math.sqrt(Math.pow(p.slideTargetX - p.halfMoonCpX, 2) + Math.pow(p.slideTargetY - p.halfMoonCpY, 2));
                    distance = (cpDist1 + cpDist2) * 0.9;
                } else {
                    distance = Math.sqrt(dx*dx + dy*dy);
                }

                let moveRatio = speed / distance;
                p.moveProgress += moveRatio;

                if (p.moveProgress >= 1) {
                    p.moveProgress = 1;
                    p.y = p.slideTargetY;
                    finalizeSlide(p);
                } else {
                    let t = p.moveProgress;
                    let bezierX, bezierY;

                    if (p.slidingHalfMoon) {
                        // ‰∫åÊ¨°„Éô„Ç∏„ÇßÊõ≤Á∑öÔºàÂçäÊúàÁî®Ôºâ
                        let mt = 1 - t;
                        bezierX = mt*mt*p.slideStartX + 2*mt*t*p.halfMoonCpX + t*t*p.slideTargetX;
                        bezierY = mt*mt*p.slideStartY + 2*mt*t*p.halfMoonCpY + t*t*p.slideTargetY;
                    } else {
                        // ‰∏âÊ¨°„Éô„Ç∏„ÇßÊõ≤Á∑öÔºàÈÄöÂ∏∏„ÅÆÊñú„ÇÅÊ©ãÁî®Ôºâ
                        let startX = p.slideStartX;
                        let startY = p.slideStartY;
                        let endX = p.slideTargetX;
                        let endY = p.slideTargetY;

                        let cp1x = startX + (endX - startX) * 0.3;
                        let cp1y = startY;
                        let cp2x = startX + (endX - startX) * 0.7;
                        let cp2y = endY;

                        let mt = 1 - t;
                        bezierX = mt*mt*mt*startX + 3*mt*mt*t*cp1x + 3*mt*t*t*cp2x + t*t*t*endX;
                        bezierY = mt*mt*mt*startY + 3*mt*mt*t*cp1y + 3*mt*t*t*cp2y + t*t*t*endY;
                    }

                    let lastP = p.trail[p.trail.length - 1];
                    lastP.x = bezierX;
                    lastP.y = bezierY;
                    p.y = bezierY;
                }
                return;
            }

            // Ê®™ÁßªÂãï
            if (p.nextXIdx !== undefined) {
                // Ê®™ÁßªÂãïÔºöÂõ∫ÂÆö4.0ÔºàÂÄçÁéá„ÅØÁπ∞„ÇäËøî„ÅóÂõûÊï∞„ÅßÂØæÂøúÔºâ
                let horizSpeed = 4.0;
                let lastP = p.trail[p.trail.length - 1];
                let dist = Math.abs((p.nextXIdx * columnWidth) - (p.xIdx * columnWidth));

                let ratio = horizSpeed / dist;
                p.moveProgress += ratio;

                if (p.moveProgress >= 1) {
                    p.moveProgress = 1;
                    let endX = (p.nextXIdx * columnWidth) + (columnWidth / 2);
                    lastP.x = endX;
                    p.trail.push({x: endX, y: p.y});
                    p.xIdx = p.nextXIdx;
                    p.nextXIdx = undefined;
                    p.moveProgress = 0;
                } else {
                    let startX = (p.xIdx * columnWidth) + (columnWidth / 2);
                    let endX = (p.nextXIdx * columnWidth) + (columnWidth / 2);
                    let ease = (1 - Math.cos(p.moveProgress * Math.PI)) / 2;
                    let lastP = p.trail[p.trail.length - 1];
                    lastP.x = startX + (endX - startX) * ease;
                }
                return;
            }

            // Á∏¶ÁßªÂãï
            let prevY = p.y;
            let nextY = p.y + speed;
            p.y = nextY;

            let lastP = p.trail[p.trail.length - 1];
            lastP.y = p.y;

            let currentLevel = Math.floor((prevY - topMargin) / stepHeight);
            let checkStartLvl = Math.max(0, currentLevel - 1);
            let checkEndLvl = Math.floor((nextY - topMargin) / stepHeight);

            for (let lvl = checkStartLvl; lvl <= checkEndLvl; lvl++) {
                let bridgeY = topMargin + (lvl * stepHeight) + (stepHeight / 2);

                // ÈÄöÂ∏∏Ê©ã„Å®Êñú„ÇÅÊ©ã„ÅÆÈñãÂßãÁÇπ„ÉÅ„Çß„ÉÉ„ÇØ
                if (prevY <= bridgeY && nextY >= bridgeY) {
                    if (p.hasTurnedAtLevel !== lvl) {
                        if(checkAndTurn(p, lvl, bridgeY)) return;
                    }
                }
            }

            // Êñú„ÇÅÊ©ã„ÅÆÁµÇÁÇπ„ÉÅ„Çß„ÉÉ„ÇØÔºàÂêÑÊñú„ÇÅÊ©ã„ÇíÁõ¥Êé•Ë™ø„Åπ„ÇãÔºâ
            // „Ç´„Éº„Éñ„Åã„ÇâÂá∫„Å¶„Åç„ÅüÁõ¥Âæå„Åß„ÇÇ„ÄÅÂà•„ÅÆ„Ç´„Éº„Éñ„ÅÆÁµÇÁÇπ„Å™„ÇâÂèçÂøú„Åô„Çã
            if (!p.sliding) {
                for (let l of ladders) {
                    if (l.type === 'right_down' || l.type === 'left_down') {
                        // Êñú„ÇÅÊ©ã„ÅÆÁµÇÁÇπYÂ∫ßÊ®ôÔºà3„Çπ„ÉÜ„ÉÉ„Éó‰∏ãÔºâ
                        let endY = topMargin + ((l.level + 3) * stepHeight) + (stepHeight / 2);

                        // „Åì„ÅÆÁµÇÁÇπ„ÇíÈÄöÈÅé„Åó„Åü„Åã
                        if (prevY <= endY && nextY >= endY) {
                            // „Å©„ÅÆÂàó„Å´„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
                            let endCol = (l.type === 'right_down') ? l.colIndex + 1 : l.colIndex;

                            // ÁµÇÁÇπ„ÅÆÂàó„Å´„ÅÑ„ÇãÂ†¥Âêà
                            if (p.xIdx === endCol) {
                                // Âêå„Åò„Ç´„Éº„Éñ„ÅÆÁµÇÁÇπ„Å™„Çâ„Çπ„Ç≠„ÉÉ„ÉóÔºà‰∏ã„ÇäÂæå„Åô„Åê„Å´Âêå„Åò„Ç´„Éº„Éñ„ÇíÁôª„Çâ„Å™„ÅÑÔºâ
                                if (p.cameFromCurve && p.lastCurveCol !== undefined && p.lastCurveLevel !== undefined) {
                                    if (p.lastCurveCol === l.colIndex && p.lastCurveLevel === l.level) {
                                        continue;
                                    }
                                }

                                // Á∏¶„Å´‰∏ã„Çä„Å¶„Åç„Åü ‚Üí Áôª„Çã
                                if (l.type === 'right_down') {
                                    // right_down„ÅÆÁµÇÁÇπ„Åã„ÇâÂ∑¶‰∏ä„Å∏Áôª„Çã
                                    startSlideUp(p, l.level, endY, l.colIndex);
                                } else {
                                    // left_down„ÅÆÁµÇÁÇπ„Åã„ÇâÂè≥‰∏ä„Å∏Áôª„Çã
                                    startSlideUp(p, l.level, endY, l.colIndex + 1);
                                }
                                return;
                            }
                        }
                    }
                }
            }

            // ÂçäÊúà„ÅÆÁµÇÁÇπ„ÉÅ„Çß„ÉÉ„ÇØÔºà‰∏ã„Åã„ÇâÁôª„ÇãÔºâ
            if (!p.sliding) {
                for (let l of ladders) {
                    if (l.type === 'half_moon_left' || l.type === 'half_moon_right') {
                        // ÂçäÊúà„ÅÆÁµÇÁÇπYÂ∫ßÊ®ôÔºà3„Çπ„ÉÜ„ÉÉ„Éó‰∏ãÔºâ
                        let endY = topMargin + ((l.level + 3) * stepHeight) + (stepHeight / 2);

                        // „Åì„ÅÆÁµÇÁÇπ„ÇíÈÄöÈÅé„Åó„Åü„Åã
                        if (prevY <= endY && nextY >= endY) {
                            // ÂØæË±°„ÅÆÂàó„Å´„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàtargetCol„Çí‰ΩøÁî®Ôºâ
                            if (p.xIdx === l.targetCol) {
                                // Âêå„ÅòÂçäÊúà„Åã„ÇâÂá∫„Å¶„Åç„ÅüÁõ¥Âæå„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                                if (p.cameFromCurve && Math.abs(endY - p.curveExitY) < 5) {
                                    continue;
                                }

                                // ‰∏ã„Åã„ÇâÂçäÊúà„ÇíÁôª„Çã
                                let direction = (l.type === 'half_moon_left') ? 'left' : 'right';
                                startHalfMoonUp(p, l.level, endY, direction);
                                return;
                            }
                        }
                    }
                }
            }

            // cameFromCurve„ÅÆ„É™„Çª„ÉÉ„ÉàÔºöÁµÇÁÇπ„Çà„Çä1„Çπ„ÉÜ„ÉÉ„ÉóÈÄ≤„Çì„Åß„Åã„Çâ„É™„Çª„ÉÉ„Éà
            if (p.cameFromCurve && !p.sliding && p.curveExitY !== undefined) {
                if (p.y > p.curveExitY + stepHeight) {
                    p.cameFromCurve = false;
                    p.curveExitY = undefined;
                }
            }

            // „Éú„Éº„É´„ÅÆÁµÇÁÇπ = „Çø„É≥„ÇØ„ÅÆ‰∏äÁ´ØÔºà„É©„Ç§„É≥ÁµÇÁÇπÔºâ
            let tankBottomY;
            let logicHeight = canvas.height / dpr;
            if (players.length <= 3) {
                tankBottomY = logicHeight - 120;
            } else if (players.length >= 6 && (p.xIdx === 0 || p.xIdx === players.length - 1)) {
                // 6„Å§‰ª•‰∏ä„Åß‰∏°Á´Ø„ÅØ„Åï„Çâ„Å´Èï∑„Åè
                tankBottomY = logicHeight - 60;
            } else {
                let isLong = (p.xIdx % 2 === 0);
                tankBottomY = logicHeight - (isLong ? 120 : 180);
            }
            let finishY = tankBottomY - tankHeight;

            if (p.y >= finishY) {
                p.state = 'finished';
                p.y = finishY;
                p.trail[p.trail.length - 1].y = p.y;

                // „Çø„É≥„ÇØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßãÔºàÈÄöÂ∏∏„É¢„Éº„Éâ„ÅÆ„ÅøÔºâ
                if (currentMode === 'normal') {
                    startTankAnimation(p.xIdx, p.color);
                }
            }
        }

        function finalizeSlide(p) {
            p.trail.pop();
            p.trail.pop();

            let startX = p.slideStartX;
            let startY = p.slideStartY;
            let endX = p.slideTargetX;
            let endY = p.slideTargetY;

            let segments = 12;

            if (p.slidingHalfMoon) {
                // ÂçäÊúàÁî®Ôºö‰∫åÊ¨°„Éô„Ç∏„ÇßÊõ≤Á∑ö
                let cpX = p.halfMoonCpX;
                let cpY = p.halfMoonCpY;

                for (let i = 0; i <= segments; i++) {
                    let t = i / segments;
                    let mt = 1 - t;

                    let bezierX = mt*mt*startX + 2*mt*t*cpX + t*t*endX;
                    let bezierY = mt*mt*startY + 2*mt*t*cpY + t*t*endY;

                    p.trail.push({x: bezierX, y: bezierY});
                }
            } else {
                // ÈÄöÂ∏∏„ÅÆÊñú„ÇÅÊ©ãÁî®Ôºö‰∏âÊ¨°„Éô„Ç∏„ÇßÊõ≤Á∑ö
                let cp1x = startX + (endX - startX) * 0.3;
                let cp1y = startY;
                let cp2x = startX + (endX - startX) * 0.7;
                let cp2y = endY;

                for (let i = 0; i <= segments; i++) {
                    let t = i / segments;
                    let mt = 1 - t;

                    let bezierX = mt*mt*mt*startX + 3*mt*mt*t*cp1x + 3*mt*t*t*cp2x + t*t*t*endX;
                    let bezierY = mt*mt*mt*startY + 3*mt*mt*t*cp1y + 3*mt*t*t*cp2y + t*t*t*endY;

                    p.trail.push({x: bezierX, y: bezierY});
                }
            }

            p.trail.push({x: p.slideTargetX, y: p.slideTargetY});

            // „Ç´„Éº„Éñ„Åã„ÇâÂá∫„Å¶„Åç„Åü„Éï„É©„Ç∞„ÇíË®≠ÂÆö
            p.cameFromCurve = true;
            p.curveExitY = p.slideTargetY;

            // Áõ¥Ââç„Å´ÈÄö„Å£„Åü„Ç´„Éº„Éñ„ÅÆÊÉÖÂ†±„ÇíË®òÈå≤Ôºà‰∏ã„ÇäÂùÇ„ÅÆÂ†¥Âêà„ÅÆ„Åø„ÄÅÂçäÊúà„ÅØÈô§„ÅèÔºâ
            if (!p.slidingUp && !p.slidingHalfMoon) {
                // ‰∏ã„ÇäÂùÇ„ÅÆÂ†¥Âêà„ÄÅ„Åì„ÅÆ„Ç´„Éº„Éñ„ÅÆcolIndex„Å®level„ÇíË®òÈå≤
                let curveColIndex = Math.min(p.xIdx, p.nextXIdx);
                let curveLevel = Math.round((p.slideStartY - topMargin) / stepHeight - 0.5);
                p.lastCurveCol = curveColIndex;
                p.lastCurveLevel = curveLevel;
            } else {
                // Áôª„ÇäÂùÇ„Åæ„Åü„ÅØÂçäÊúà„ÅÆÂ†¥Âêà„ÅØ„É™„Çª„ÉÉ„Éà
                p.lastCurveCol = undefined;
                p.lastCurveLevel = undefined;
            }

            // Áôª„Çä„ÅÆÂ†¥Âêà„ÅØÂßãÁÇπ„É¨„Éô„É´„ÇíË®òÈå≤
            if (p.slidingUp) {
                let startLevel = Math.round((p.slideTargetY - topMargin) / stepHeight - 0.5);
                p.hasTurnedAtLevel = startLevel;
            }

            p.xIdx = p.nextXIdx;
            p.nextXIdx = undefined;
            p.sliding = false;
            p.slidingUp = false;
            p.slidingHalfMoon = false;
            p.moveProgress = 0;
        }

        // ‰∏ã„ÇäÔºöÊñú„ÇÅÊ©ã„Å®ÈÄöÂ∏∏Ê©ã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkAndTurn(p, lvl, hitY) {
            let rightNormal = ladders.find(l => l.colIndex === p.xIdx && l.level === lvl && l.type === 'normal');
            let leftNormal = ladders.find(l => l.colIndex === p.xIdx - 1 && l.level === lvl && l.type === 'normal');
            let rightDown = ladders.find(l => l.colIndex === p.xIdx && l.level === lvl && l.type === 'right_down');
            let leftDown = ladders.find(l => l.colIndex === p.xIdx - 1 && l.level === lvl && l.type === 'left_down');

            // ÂçäÊúà„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÔºàtargetCol„Ååp.xIdx„Å®‰∏ÄËá¥„Åô„ÇãÂçäÊúà„ÇíÊé¢„ÅôÔºâ
            let halfMoonLeft = ladders.find(l => l.type === 'half_moon_left' && l.level === lvl && l.targetCol === p.xIdx);
            let halfMoonRight = ladders.find(l => l.type === 'half_moon_right' && l.level === lvl && l.targetCol === p.xIdx);

            // ÂçäÊúàÔºàÂêå„ÅòÂàó„Å´Êàª„ÇãÔºâ
            if (halfMoonLeft) {
                startHalfMoon(p, lvl, hitY, 'left');
                return true;
            } else if (halfMoonRight) {
                startHalfMoon(p, lvl, hitY, 'right');
                return true;
            }
            // Êñú„ÇÅÊ©ãÔºà‰∏ã„ÇäÔºâ
            else if (rightDown) {
                startSlideDown(p, lvl, hitY, p.xIdx + 1);
                return true;
            } else if (leftDown) {
                startSlideDown(p, lvl, hitY, p.xIdx - 1);
                return true;
            }
            // ÈÄöÂ∏∏„ÅÆÊ®™Ê©ã
            else if (rightNormal) {
                startHorizontal(p, lvl, hitY, p.xIdx + 1);
                return true;
            } else if (leftNormal) {
                startHorizontal(p, lvl, hitY, p.xIdx - 1);
                return true;
            }
            return false;
        }

        // ÂçäÊúà„Çπ„É©„Ç§„ÉâÔºàÂêå„ÅòÂàó„Å´Êàª„ÇãÔºâ
        function startHalfMoon(p, turnLvl, startY, direction) {
            let lastP = p.trail[p.trail.length - 1];
            p.y = startY; lastP.y = startY;
            p.sliding = true;
            p.slidingHalfMoon = true;
            p.halfMoonDirection = direction;
            p.moveProgress = 0;

            let colX = (p.xIdx * columnWidth) + (columnWidth / 2);
            p.slideStartX = colX;
            p.slideStartY = startY;
            p.nextXIdx = p.xIdx; // Âêå„ÅòÂàó„Å´Êàª„Çã
            p.slideTargetX = colX; // XÂ∫ßÊ®ô„ÅØÂêå„Åò
            p.slideTargetY = topMargin + ((turnLvl + 3) * stepHeight) + (stepHeight / 2);

            // Âà∂Âæ°ÁÇπÔºàÊèèÁîª„Å®Âêå„ÅòÔºâ
            if (direction === 'left') {
                p.halfMoonCpX = colX - columnWidth * 0.6;
            } else {
                p.halfMoonCpX = colX + columnWidth * 0.6;
            }
            p.halfMoonCpY = (p.slideStartY + p.slideTargetY) / 2;

            p.trail.push({x: p.slideStartX, y: startY});
            p.hasTurnedAtLevel = turnLvl;
            p.currentSpeed = 4.0;
        }

        // ÂçäÊúà„Çí‰∏ã„Åã„Çâ‰∏ä„Å´Áôª„Çã
        function startHalfMoonUp(p, turnLvl, startY, direction) {
            let lastP = p.trail[p.trail.length - 1];
            p.y = startY; lastP.y = startY;
            p.sliding = true;
            p.slidingUp = true;
            p.slidingHalfMoon = true;
            p.halfMoonDirection = direction;
            p.moveProgress = 0;

            let colX = (p.xIdx * columnWidth) + (columnWidth / 2);
            p.slideStartX = colX;
            p.slideStartY = startY; // ‰∏ãÁ´Ø„Åã„Çâ„Çπ„Çø„Éº„Éà
            p.nextXIdx = p.xIdx; // Âêå„ÅòÂàó„Å´Êàª„Çã
            p.slideTargetX = colX; // XÂ∫ßÊ®ô„ÅØÂêå„Åò
            p.slideTargetY = topMargin + (turnLvl * stepHeight) + (stepHeight / 2); // ‰∏äÁ´Ø„Å∏

            // Âà∂Âæ°ÁÇπÔºàÊèèÁîª„Å®Âêå„ÅòÔºâ
            if (direction === 'left') {
                p.halfMoonCpX = colX - columnWidth * 0.6;
            } else {
                p.halfMoonCpX = colX + columnWidth * 0.6;
            }
            p.halfMoonCpY = (p.slideStartY + p.slideTargetY) / 2;

            p.trail.push({x: p.slideStartX, y: startY});
            p.hasTurnedAtLevel = turnLvl + 3; // ÁµÇÁÇπ„É¨„Éô„É´„ÇíË®òÈå≤
            p.currentSpeed = 4.0;
        }

        // ‰∏ã„Çä„Çπ„É©„Ç§„ÉâÔºàÊñú„ÇÅÊ©ã„ÅÆ‰∏ä„Åã„Çâ‰∏ã„Å∏Ôºâ
        function startSlideDown(p, turnLvl, startY, targetIdx) {
            let lastP = p.trail[p.trail.length - 1];
            p.y = startY; lastP.y = startY;
            p.sliding = true;
            p.slidingUp = false;
            p.moveProgress = 0;
            p.slideStartX = (p.xIdx * columnWidth) + (columnWidth / 2);
            p.slideStartY = startY;
            p.nextXIdx = targetIdx;
            p.slideTargetX = (targetIdx * columnWidth) + (columnWidth / 2);
            // 3„Çπ„ÉÜ„ÉÉ„ÉóÂàÜ„ÅÆÈ´ò„ÅïÔºàÊèèÁîª„Å®‰∏ÄËá¥Ôºâ
            p.slideTargetY = topMargin + ((turnLvl + 3) * stepHeight) + (stepHeight / 2);

            p.trail.push({x: p.slideStartX, y: startY});
            p.hasTurnedAtLevel = turnLvl;
            p.currentSpeed = 4.0;
        }

        // Áôª„Çä„Çπ„É©„Ç§„ÉâÔºàÊñú„ÇÅÊ©ã„ÅÆ‰∏ã„Åã„Çâ‰∏ä„Å∏Ôºâ
        function startSlideUp(p, turnLvl, startY, targetIdx) {
            let lastP = p.trail[p.trail.length - 1];
            p.y = startY; lastP.y = startY;
            p.sliding = true;
            p.slidingUp = true;
            p.moveProgress = 0;
            p.slideStartX = (p.xIdx * columnWidth) + (columnWidth / 2);
            p.slideStartY = startY;
            p.nextXIdx = targetIdx;
            p.slideTargetX = (targetIdx * columnWidth) + (columnWidth / 2);
            // 3„Çπ„ÉÜ„ÉÉ„ÉóÂàÜ‰∏ä„Å∏ÔºàÊñú„ÇÅÊ©ã„ÅÆÂßãÁÇπ„Å∏Âêë„Åã„ÅÜÔºâ
            p.slideTargetY = topMargin + (turnLvl * stepHeight) + (stepHeight / 2);

            p.trail.push({x: p.slideStartX, y: startY});
            // ÁµÇÁÇπ‰ΩçÁΩÆÔºàlvl+3Ôºâ„ÅßË®òÈå≤
            p.hasTurnedAtLevel = turnLvl + 3;
            p.currentSpeed = 4.0;
        }

        function startHorizontal(p, turnLvl, startY, targetIdx) {
            let lastP = p.trail[p.trail.length - 1];
            p.y = startY; lastP.y = startY;
            p.nextXIdx = targetIdx;
            p.trail.push({x: lastP.x, y: startY});
            p.moveProgress = 0;
            p.hasTurnedAtLevel = turnLvl;

            // Ê®™ÈñãÂßãÊôÇ„É™„Çª„ÉÉ„Éà
            p.currentSpeed = 4.0;
        }

        // =========================================
        // „Çø„É≥„ÇØÈñ¢ÈÄ£„ÅÆÈñ¢Êï∞
        // =========================================
        let tankElements = [];

        function createTanks(count, logicHeight) {
            const tankLayer = document.getElementById('tankLayer');
            tankLayer.innerHTML = '';
            tankElements = [];

            for (let i = 0; i < count; i++) {
                let x = (i * columnWidth) + (columnWidth / 2);

                // 4„Å§‰ª•‰∏ä„ÅÆÂ†¥Âêà„ÄÅ‰∏°Á´Ø„Çí‰∏≠Â§ÆÂØÑ„Çä„Å´„Åö„Çâ„Åô
                let xOffset = 0;
                if (count >= 6) {
                    // 6„Å§‰ª•‰∏ä„ÅØÂ§ß„Åç„Åè„Åö„Çâ„Åô
                    if (i === 0) {
                        xOffset = 8;
                    } else if (i === count - 1) {
                        xOffset = -8;
                    }
                } else if (count >= 4) {
                    if (i === 0) {
                        xOffset = 3;
                    } else if (i === count - 1) {
                        xOffset = -3;
                    }
                }

                // „Çø„É≥„ÇØ„ÅÆ‰∏ãÁ´Ø‰ΩçÁΩÆ
                let tankBottomY;
                if (count <= 3) {
                    tankBottomY = logicHeight - 120;
                } else if (count >= 6 && (i === 0 || i === count - 1)) {
                    // 6„Å§‰ª•‰∏ä„Åß‰∏°Á´Ø„ÅØ„Åï„Çâ„Å´Èï∑„ÅèÔºà‰∏ÄÁï™‰∏ãÔºâ
                    tankBottomY = logicHeight - 60;
                } else {
                    let isLong = (i % 2 === 0);
                    tankBottomY = logicHeight - (isLong ? 120 : 180);
                }

                // „Çø„É≥„ÇØ„ÅÆ‰∏äÁ´Ø = „É©„Ç§„É≥„ÅÆÁµÇÁÇπ
                let tankTopY = tankBottomY - tankHeight;

                // „Çø„É≥„ÇØ„ÅÆ„Çµ„Ç§„Ç∫ÔºàÈÅ∏ÊäûËÇ¢Êï∞„Å´Âøú„Åò„Å¶Ë™øÊï¥Ôºâ
                let tankW;
                if (count <= 3) {
                    // 2„Äú3ÂÄã„ÅÆÊôÇ„ÅØÈáç„Å™„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´Êéß„Åà„ÇÅ„Å´
                    tankW = columnWidth * 0.85;
                } else if (count === 4) {
                    // 4ÂÄã„ÅÆÊôÇ„ÅØÂ∞ë„ÅóÊéß„Åà„ÇÅ„Å´
                    tankW = columnWidth + columnWidth * 0.5 - 10; // ÂàóÂπÖ„ÅÆ150% - 10px
                } else if (count === 5) {
                    // 5ÂÄã„ÅÆÊôÇ„ÅØÂ∞ë„ÅóÊéß„Åà„ÇÅ„Å´
                    tankW = columnWidth + columnWidth * 0.6; // ÂàóÂπÖ„ÅÆ160%
                } else {
                    // 6ÂÄã‰ª•‰∏ä„ÅØÈö£„ÅÆ„É©„Ç§„É≥„Å®„ÇÆ„É™„ÇÆ„É™„Åæ„ÅßÂ∫É„Åí„Çã
                    tankW = columnWidth + columnWidth * 0.7; // ÂàóÂπÖ„ÅÆ170%
                }

                // ‰∏°Á´Ø„ÅØÂ§ß„Åç„Åè„Å™„Å£„ÅüÂàÜ„ÄÅ‰∏≠Â§Æ„Å´ÂØÑ„Åõ„Çã
                let tankXOffset = xOffset;
                if (count >= 4 && (i === 0 || i === count - 1)) {
                    let extraWidth = (tankW - columnWidth) / 2;
                    if (i === 0) {
                        tankXOffset = extraWidth; // Â∑¶Á´Ø„ÅØÂè≥„Å´
                    } else {
                        tankXOffset = -extraWidth; // Âè≥Á´Ø„ÅØÂ∑¶„Å´
                    }
                }

                const tank = document.createElement('div');
                tank.className = 'glass-container';
                tank.id = 'tank-' + i;
                tank.style.width = tankW + 'px';
                tank.style.height = tankHeight + 'px';
                tank.style.left = (x - tankW / 2 + tankXOffset) + 'px';
                tank.style.top = (tankTopY + tankHeight + 10) + 'px';

                // „É©„Éô„É´Ôºà„Ç¥„Éº„É´Èö†„Åó„É¢„Éº„Éâ„Åß„ÅØ„Äå?„Äç„ÇíË°®Á§∫Ôºâ
                const label = document.createElement('span');
                label.className = 'label';
                if (blindMode === 'goal') {
                    label.textContent = '?';
                    label.dataset.realLabel = goalLabels[i]; // Êú¨ÂΩì„ÅÆ„É©„Éô„É´„Çí‰øùÂ≠ò
                } else {
                    label.textContent = goalLabels[i];
                }
                tank.appendChild(label);

                // Ê∞¥ÊµÅ„ÅÆ‰ΩçÁΩÆ„Çí„É©„Ç§„É≥„Å´Âêà„Çè„Åõ„ÇãÔºà„Çø„É≥„ÇØ„ÅÆ„Ç™„Éï„Çª„ÉÉ„ÉàÂàÜÈÄÜ„Å´„Åö„Çâ„ÅôÔºâ
                let streamOffset = -tankXOffset;

                // Ê∞¥ÊµÅ
                const stream = document.createElement('div');
                stream.className = 'stream';
                stream.style.left = `calc(50% + ${streamOffset}px)`;
                tank.appendChild(stream);

                // „Çπ„Éó„É©„ÉÉ„Ç∑„É•
                const splash = document.createElement('div');
                splash.className = 'splash';
                splash.style.left = `calc(50% + ${streamOffset}px)`;
                tank.appendChild(splash);

                // Ê∞¥
                const water = document.createElement('div');
                water.className = 'water';
                water.id = 'water-' + i;

                // Ê≥¢
                const wave1 = document.createElement('div');
                wave1.className = 'wave';
                const wave2 = document.createElement('div');
                wave2.className = 'wave';
                water.appendChild(wave1);
                water.appendChild(wave2);

                tank.appendChild(water);

                tankLayer.appendChild(tank);
                tankElements.push({
                    tank: tank,
                    water: water,
                    isPouring: false,
                    bubbleInterval: null
                });
            }
        }

        function hexToRgb(hex) {
            // #ff6b6b -> {r: 255, g: 107, b: 107}
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : {r: 150, g: 150, b: 150};
        }

        function startTankAnimation(goalIndex, colorHex) {
            if (goalIndex < 0 || goalIndex >= tankElements.length) return;

            const tankData = tankElements[goalIndex];
            if (tankData.isPouring) return; // „Åô„Åß„Å´ÂÆüË°å‰∏≠„Å™„ÇâÁÑ°Ë¶ñ

            const {r, g, b} = hexToRgb(colorHex);
            const tank = tankData.tank;
            const water = tankData.water;

            // Ëâ≤„ÇíË®≠ÂÆö
            tank.style.setProperty('--main-rgb', `${r}, ${g}, ${b}`);
            tank.style.setProperty('--deep-rgb', `${Math.floor(r*0.7)}, ${Math.floor(g*0.7)}, ${Math.floor(b*0.7)}`);

            // Ê≥¢„ÅÆËâ≤ÔºàÊòé„Çã„Åè„Åó„Å¶„Ç≥„É≥„Éà„É©„Çπ„Éà„Çí„Å§„Åë„ÇãÔºâ
            let waveR = Math.min(255, r + 80);
            let waveG = Math.min(255, g + 80);
            let waveB = Math.min(255, b + 80);
            tank.style.setProperty('--wave-rgb', `${waveR}, ${waveG}, ${waveB}`);

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã
            tankData.isPouring = true;
            tank.classList.add('active', 'pouring');

            // „Ç¥„Éº„É´Èö†„Åó„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÄÅ„É©„Éô„É´„ÇíÊú¨Êù•„ÅÆÂÄ§„Å´Êõ¥Êñ∞
            if (blindMode === 'goal') {
                const label = tank.querySelector('.label');
                if (label && label.dataset.realLabel) {
                    label.textContent = label.dataset.realLabel;
                }
            }

            // Ê∞¥„ÅÆÂäπÊûúÈü≥
            playWaterSound();

            // Ê∞¥ÊµÅ„ÅåÂ∫ï„Å´ÁùÄ„ÅÑ„Å¶„Åã„ÇâÊ∞¥‰Ωç„Çí‰∏ä„Åí„ÇãÔºàÁ¥Ñ300msÂæåÔºâ
            setTimeout(() => {
                water.style.height = '100%';
            }, 350);

            // Ê∞óÊ≥°„ÇÇÊ∞¥ÊµÅ„ÅåÁùÄ„ÅÑ„Å¶„Åã„ÇâÁô∫Áîü
            setTimeout(() => {
                tankData.bubbleInterval = setInterval(() => {
                    createTankBubble(tank, tankData);
                }, 80);
            }, 300);

            // Ê≥®„ÅéÁµÇ‰∫ÜÂæå„ÄÅfilled„ÇØ„É©„Çπ„ÇíËøΩÂä†„Åó„Å¶Ê∞óÊ≥°„ÇíÁ∑©„ÇÑ„Åã„Å´Á∂ôÁ∂ö
            setTimeout(() => {
                tank.classList.remove('pouring');
                tank.classList.add('filled');
                clearInterval(tankData.bubbleInterval);

                // Ê∫ú„Åæ„Å£„ÅüÂæå„ÇÇÁ∑©„ÇÑ„Åã„Å´Ê∞óÊ≥°„ÇíÂá∫„Åô
                tankData.bubbleInterval = setInterval(() => {
                    createTankBubble(tank, tankData);
                }, 500);
            }, 2000);
        }

        function createTankBubble(tank, tankData) {
            if (!tankData.isPouring) return;
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            const size = Math.random() * 4 + 2 + 'px';
            const left = Math.random() * 80 + 10 + '%';
            bubble.style.width = size;
            bubble.style.height = size;
            bubble.style.left = left;
            bubble.style.animationDuration = (Math.random() * 0.5 + 1.0) + 's';
            tank.appendChild(bubble);
            setTimeout(() => { bubble.remove(); }, 2000);
        }

        function resetTanks() {
            tankElements.forEach((tankData, i) => {
                tankData.tank.classList.remove('active', 'pouring', 'filled');
                tankData.water.style.height = '0%';
                tankData.isPouring = false;
                if (tankData.bubbleInterval) {
                    clearInterval(tankData.bubbleInterval);
                }
                // Ëâ≤„Çí„É™„Çª„ÉÉ„Éà
                tankData.tank.style.setProperty('--main-rgb', '150, 150, 150');
                tankData.tank.style.setProperty('--deep-rgb', '100, 100, 100');
                tankData.tank.style.setProperty('--wave-rgb', '255, 255, 255');
                // Ê∞óÊ≥°„ÇíÂâäÈô§
                tankData.tank.querySelectorAll('.bubble').forEach(b => b.remove());

                // „Ç¥„Éº„É´Èö†„Åó„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÄÅ„É©„Éô„É´„Çí„Äå?„Äç„Å´Êàª„Åô
                if (blindMode === 'goal') {
                    const label = tankData.tank.querySelector('.label');
                    if (label) {
                        label.textContent = '?';
                    }
                }
            });
        }

        function drawFrame() {
            let logicWidth = canvas.width / dpr;
            let logicHeight = canvas.height / dpr;
            ctx.clearRect(0, 0, logicWidth, logicHeight);

            ctx.strokeStyle = '#cccccc';
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            const count = players.length;

            for (let i = 0; i < count; i++) {
                let x = (i * columnWidth) + (columnWidth / 2);

                // „Çø„É≥„ÇØ„ÅÆ‰∏ãÁ´Ø‰ΩçÁΩÆ
                let tankBottomY;
                if (count <= 3) {
                    tankBottomY = logicHeight - 120;
                } else if (count >= 6 && (i === 0 || i === count - 1)) {
                    // 6„Å§‰ª•‰∏ä„Åß‰∏°Á´Ø„ÅØ„Åï„Çâ„Å´Èï∑„Åè
                    tankBottomY = logicHeight - 60;
                } else {
                    let isLong = (i % 2 === 0);
                    tankBottomY = logicHeight - (isLong ? 120 : 180);
                }

                // „É©„Ç§„É≥„ÅÆÁµÇÁÇπ = „Çø„É≥„ÇØ„ÅÆ‰∏äÁ´ØÔºà„Çø„É≥„ÇØÈ´ò„ÅïÂàÜ‰∏äÔºâ
                let lineEndY = tankBottomY - tankHeight;

                ctx.beginPath();
                ctx.moveTo(x, topMargin);
                ctx.lineTo(x, lineEndY);
                ctx.stroke();

                // „Ç¥„Éº„É´„Éú„ÉÉ„ÇØ„Çπ„ÅØHTML„Çø„É≥„ÇØ„Å´ÁΩÆ„ÅçÊèõ„Åà„Åü„ÅÆ„ÅßÊèèÁîª„Åó„Å™„ÅÑ
            }

            ladders.forEach(l => {
                let x1 = (l.colIndex * columnWidth) + (columnWidth / 2);
                let x2 = ((l.colIndex + 1) * columnWidth) + (columnWidth / 2);
                let y = topMargin + (l.level * stepHeight) + (stepHeight / 2);

                if (l.type === 'right_down') {
                    let yNext = topMargin + ((l.level + 3) * stepHeight) + (stepHeight / 2);

                    // start‚Üíend„ÅÆÂΩ¢Âºè„ÅßÁµ±‰∏Ä
                    let startX = x1, startY = y;
                    let endX = x2, endY = yNext;
                    let cp1x = startX + (endX - startX) * 0.3;
                    let cp2x = startX + (endX - startX) * 0.7;

                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.bezierCurveTo(cp1x, startY, cp2x, endY, endX, endY);
                    ctx.stroke();
                } else if (l.type === 'left_down') {
                    let yNext = topMargin + ((l.level + 3) * stepHeight) + (stepHeight / 2);

                    // start‚Üíend„ÅÆÂΩ¢Âºè„ÅßÁµ±‰∏Ä
                    let startX = x2, startY = y;
                    let endX = x1, endY = yNext;
                    let cp1x = startX + (endX - startX) * 0.3;
                    let cp2x = startX + (endX - startX) * 0.7;

                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.bezierCurveTo(cp1x, startY, cp2x, endY, endX, endY);
                    ctx.stroke();
                } else if (l.type === 'half_moon_left') {
                    // Â∑¶ÂçäÊúàÔºöÊåáÂÆöÂàó„ÅÆÂ∑¶ÂÅ¥„Å´ËÜ®„Çâ„ÇÄ
                    let colX = (l.targetCol * columnWidth) + (columnWidth / 2);
                    let startY = topMargin + (l.level * stepHeight) + (stepHeight / 2);
                    let endY = topMargin + ((l.level + 3) * stepHeight) + (stepHeight / 2);
                    let midY = (startY + endY) / 2;

                    // Âà∂Âæ°ÁÇπ„ÅØÂ∑¶Â§ñÂÅ¥„Å´
                    let cpX = colX - columnWidth * 0.6;

                    ctx.beginPath();
                    ctx.moveTo(colX, startY);
                    ctx.quadraticCurveTo(cpX, midY, colX, endY);
                    ctx.stroke();
                } else if (l.type === 'half_moon_right') {
                    // Âè≥ÂçäÊúàÔºöÊåáÂÆöÂàó„ÅÆÂè≥ÂÅ¥„Å´ËÜ®„Çâ„ÇÄ
                    let colX = (l.targetCol * columnWidth) + (columnWidth / 2);
                    let startY = topMargin + (l.level * stepHeight) + (stepHeight / 2);
                    let endY = topMargin + ((l.level + 3) * stepHeight) + (stepHeight / 2);
                    let midY = (startY + endY) / 2;

                    // Âà∂Âæ°ÁÇπ„ÅØÂè≥Â§ñÂÅ¥„Å´
                    let cpX = colX + columnWidth * 0.6;

                    ctx.beginPath();
                    ctx.moveTo(colX, startY);
                    ctx.quadraticCurveTo(cpX, midY, colX, endY);
                    ctx.stroke();
                } else {
                    ctx.beginPath();
                    ctx.moveTo(x1, y);
                    ctx.lineTo(x2, y);
                    ctx.stroke();
                }
            });

            // ÂæåÂãù„Å°ÊèèÁîªÔºö„Éó„É¨„Ç§„É§„Éº„ÇístartOrderÈ†Ü„Å´‰∏¶„Åπ„ÄÅÈ†ÜÁï™„Å´ÊèèÁîª
            // Âæå„Åã„ÇâÊèèÁîª„Åó„Åü„ÇÇ„ÅÆ„Åå‰∏ä„Å´Êù•„Çã

            // Ëâ≤„Çí„Éñ„É¨„É≥„Éâ„Åô„ÇãÈñ¢Êï∞
            function blendColors(baseColor, topColor, ratio) {
                const parseColor = (c) => {
                    if (c.startsWith('#')) {
                        const hex = c.replace('#', '');
                        return {
                            r: parseInt(hex.substr(0, 2), 16),
                            g: parseInt(hex.substr(2, 2), 16),
                            b: parseInt(hex.substr(4, 2), 16)
                        };
                    }
                    return { r: 128, g: 128, b: 128 };
                };
                const base = parseColor(baseColor);
                const top = parseColor(topColor);
                const r = Math.round(top.r * (1 - ratio) + base.r * ratio);
                const g = Math.round(top.g * (1 - ratio) + base.g * ratio);
                const b = Math.round(top.b * (1 - ratio) + base.b * ratio);
                return `rgb(${r},${g},${b})`;
            }

            // „Çª„Ç∞„É°„É≥„Éà„ÅÆÈáç„Å™„Çä„ÇíÊ§úÂá∫„Åô„Çã„Åü„ÇÅ„ÅÆ„Éû„ÉÉ„Éó
            const segmentMap = new Map();

            // „Åæ„ÅöÂÖ®„Éó„É¨„Ç§„É§„Éº„ÅÆ„Çª„Ç∞„É°„É≥„Éà„ÇíÂèéÈõÜ
            players.forEach((p, pIdx) => {
                if (currentMode !== 'normal' || p.state === 'idle' || p.trail.length < 2) return;

                const startOrder = p.startOrder !== undefined ? p.startOrder : pIdx;
                let drawUpTo = p.sliding ? p.trail.length - 2 : p.trail.length - 1;
                if (drawUpTo < 0) drawUpTo = 0;

                for (let k = 0; k < drawUpTo; k++) {
                    const x1 = p.trail[k].x, y1 = p.trail[k].y;
                    const x2 = p.trail[k+1].x, y2 = p.trail[k+1].y;

                    let key;
                    if (y1 < y2 || (y1 === y2 && x1 < x2)) {
                        key = `${Math.round(x1)},${Math.round(y1)},${Math.round(x2)},${Math.round(y2)}`;
                    } else {
                        key = `${Math.round(x2)},${Math.round(y2)},${Math.round(x1)},${Math.round(y1)}`;
                    }

                    if (!segmentMap.has(key)) {
                        segmentMap.set(key, []);
                    }
                    const entries = segmentMap.get(key);
                    if (!entries.find(e => e.color === p.color)) {
                        entries.push({ color: p.color, startOrder });
                    }
                }

                // sliding‰∏≠„ÅÆÊõ≤Á∑ö„ÇÇÁôªÈå≤
                if (p.sliding) {
                    const key = `curve:${Math.round(p.slideStartX)},${Math.round(p.slideStartY)},${Math.round(p.slideTargetX)},${Math.round(p.slideTargetY)}`;
                    if (!segmentMap.has(key)) {
                        segmentMap.set(key, []);
                    }
                    const entries = segmentMap.get(key);
                    if (!entries.find(e => e.color === p.color)) {
                        entries.push({ color: p.color, startOrder });
                    }
                }
            });

            // „Éó„É¨„Ç§„É§„Éº„ÇístartOrderÈ†Ü„Å´„ÇΩ„Éº„Éà
            const sortedPlayers = players
                .map((p, idx) => ({ player: p, idx, startOrder: p.startOrder !== undefined ? p.startOrder : idx }))
                .filter(({ player: p }) => currentMode === 'normal' && p.state !== 'idle' && p.trail.length >= 2)
                .sort((a, b) => a.startOrder - b.startOrder);

            // startOrderÈ†Ü„Å´„Éó„É¨„Ç§„É§„Éº„ÅÆÂÖ®ËªåË∑°„ÇíÊèèÁîª
            sortedPlayers.forEach(({ player: p, startOrder }) => {
                // Á¢∫ÂÆöÊ∏à„Åø„ÅÆËªåË∑°„ÇíÊèèÁîª
                let drawUpTo = p.sliding ? p.trail.length - 2 : p.trail.length - 1;
                if (drawUpTo < 1) drawUpTo = 1;

                // ÂêÑ„Çª„Ç∞„É°„É≥„Éà„ÅÆËâ≤„ÇíÊ±∫ÂÆö„Åó„Å¶ÊèèÁîª
                for (let k = 0; k < drawUpTo; k++) {
                    const x1 = p.trail[k].x, y1 = p.trail[k].y;
                    const x2 = p.trail[k+1].x, y2 = p.trail[k+1].y;

                    let key;
                    if (y1 < y2 || (y1 === y2 && x1 < x2)) {
                        key = `${Math.round(x1)},${Math.round(y1)},${Math.round(x2)},${Math.round(y2)}`;
                    } else {
                        key = `${Math.round(x2)},${Math.round(y2)},${Math.round(x1)},${Math.round(y1)}`;
                    }

                    const entries = segmentMap.get(key) || [];
                    let segmentColor = p.color;

                    // Ëá™ÂàÜ„Çà„ÇäÂâç„Å´ÈÄö„Å£„Åü„Éó„É¨„Ç§„É§„Éº„Åå„ÅÑ„Çå„Å∞Ëâ≤„ÇíÊ∑∑„Åú„Çã
                    if (entries.length > 1) {
                        entries.sort((a, b) => a.startOrder - b.startOrder);
                        const myIndex = entries.findIndex(e => e.color === p.color);
                        if (myIndex > 0) {
                            segmentColor = blendColors(entries[myIndex - 1].color, p.color, 0.2);
                        }
                    }

                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.strokeStyle = segmentColor;
                    ctx.lineWidth = 8;
                    ctx.lineCap = 'round';
                    ctx.stroke();
                }

                // sliding‰∏≠„ÅÆÊõ≤Á∑ö„ÇíÊèèÁîª
                if (p.sliding) {
                    const curveKey = `curve:${Math.round(p.slideStartX)},${Math.round(p.slideStartY)},${Math.round(p.slideTargetX)},${Math.round(p.slideTargetY)}`;
                    const entries = segmentMap.get(curveKey) || [];
                    let curveColor = p.color;

                    if (entries.length > 1) {
                        entries.sort((a, b) => a.startOrder - b.startOrder);
                        const myIndex = entries.findIndex(e => e.color === p.color);
                        if (myIndex > 0) {
                            curveColor = blendColors(entries[myIndex - 1].color, p.color, 0.2);
                        }
                    }

                    ctx.beginPath();
                    ctx.moveTo(p.slideStartX, p.slideStartY);

                    let startX = p.slideStartX, startY = p.slideStartY;
                    let endX = p.slideTargetX, endY = p.slideTargetY;

                    let t = p.moveProgress;
                    let steps = Math.max(20, Math.floor(t * 100));

                    if (p.slidingHalfMoon) {
                        // ÂçäÊúàÁî®Ôºö‰∫åÊ¨°„Éô„Ç∏„ÇßÊõ≤Á∑ö
                        let cpX = p.halfMoonCpX;
                        let cpY = p.halfMoonCpY;

                        for (let i = 0; i <= steps; i++) {
                            let segT = (i / steps) * t;
                            let mt = 1 - segT;

                            let bx = mt*mt*startX + 2*mt*segT*cpX + segT*segT*endX;
                            let by = mt*mt*startY + 2*mt*segT*cpY + segT*segT*endY;

                            ctx.lineTo(bx, by);
                        }
                    } else {
                        // ÈÄöÂ∏∏„ÅÆÊñú„ÇÅÊ©ãÁî®Ôºö‰∏âÊ¨°„Éô„Ç∏„ÇßÊõ≤Á∑ö
                        let cp1x = startX + (endX - startX) * 0.3;
                        let cp1y = startY;
                        let cp2x = startX + (endX - startX) * 0.7;
                        let cp2y = endY;

                        for (let i = 0; i <= steps; i++) {
                            let segT = (i / steps) * t;

                            let mt = 1 - segT;
                            let mt2 = mt * mt;
                            let mt3 = mt2 * mt;
                            let t2 = segT * segT;
                            let t3 = t2 * segT;

                            let bx = mt3 * startX + 3 * mt2 * segT * cp1x + 3 * mt * t2 * cp2x + t3 * endX;
                            let by = mt3 * startY + 3 * mt2 * segT * cp1y + 3 * mt * t2 * cp2y + t3 * endY;

                            ctx.lineTo(bx, by);
                        }
                    }

                    ctx.strokeStyle = curveColor;
                    ctx.lineWidth = 8;
                    ctx.lineJoin = 'round';
                    ctx.lineCap = 'round';
                    ctx.stroke();
                }

                // ÈÄöÂ∏∏„ÅÆÁßªÂãï‰∏≠„ÅÆÊúÄÂæå„ÅÆ„Çª„Ç∞„É°„É≥„Éà
                if (!p.sliding && p.trail.length >= 2) {
                    let lastIdx = p.trail.length - 1;
                    let prevIdx = lastIdx - 1;
                    if (prevIdx >= 0) {
                        ctx.beginPath();
                        ctx.moveTo(p.trail[prevIdx].x, p.trail[prevIdx].y);
                        ctx.lineTo(p.trail[lastIdx].x, p.trail[lastIdx].y);
                        ctx.strokeStyle = p.color;
                        ctx.lineWidth = 8;
                        ctx.lineCap = 'round';
                        ctx.stroke();
                    }
                }
            });

            // „Éú„Éº„É´„ÅÆÂÖàÁ´Ø„ÇíÊúÄÂæå„Å´ÊèèÁîªÔºàÂÖ®Âì°ÂàÜÔºâ
            sortedPlayers.forEach(({ player: p }) => {
                if (p.trail.length > 0) {
                    let tip = p.trail[p.trail.length - 1];
                    ctx.beginPath();
                    let r = 6 * (p.scale !== undefined ? p.scale : 1);
                    ctx.arc(tip.x, tip.y, r, 0, Math.PI*2);
                    ctx.fillStyle = p.color;
                    ctx.fill();
                }
            });

            // „É¨„Éº„Çπ„É¢„Éº„Éâ„ÅÆÊèèÁîª
            players.forEach(p => {
                if (currentMode === 'race') {
                    let drawX = (p.xIdx * columnWidth) + (columnWidth / 2);
                    if (p.trail.length > 0) {
                        let tip = p.trail[p.trail.length - 1];
                        drawX = tip.x;
                    }
                    if (p.state !== 'idle') {
                        ctx.beginPath();
                        ctx.arc(drawX, p.y, 18, 0, Math.PI*2);
                        ctx.fillStyle = "white"; ctx.fill();
                        ctx.strokeStyle = p.color; ctx.stroke();
                        ctx.fillStyle = "#000"; ctx.fillText(p.char, drawX, p.y);
                    }
                }
            });
        }

        // ÁµêÊûúÁô∫Ë°®Âá¶ÁêÜ
        function showResult() {
            setTimeout(() => {
                let msg = "";
                if (currentMode === 'race') {
                    // „É¨„Éº„Çπ„É¢„Éº„Éâ„ÅØÂÖ®Âì°ÂêåÊôÇ„Å™„ÅÆ„Åß„Éï„Ç°„É≥„Éï„Ç°„Éº„É¨
                    msg += "üèÅ ÁµêÊûú üèÅ\n";
                    players.forEach(p => {
                        let resultName = goalLabels[p.xIdx];
                        // „Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç„Åå„ÅÇ„Çå„Å∞Ë°®Á§∫
                        const charDisplay = p.charInfo ? `${p.char}${p.charInfo.name}` : p.char;
                        msg += `${charDisplay} ‚Üí ${resultName}\n`;
                    });
                    msg = msg.replace(/\n/g, '<br>');
                    playFanfare();
                    showCustomModal(msg);
                    createConfetti();
                } else {
                    // „Éé„Éº„Éû„É´„É¢„Éº„ÉâÔºöÂÄãÂà•ÁµêÊûú
                    let p = players.find(p => p.state === 'finished' && !p.reported);
                    if (p) {
                        let resultName = goalLabels[p.xIdx];
                        msg = `„Äå${resultName}„Äç„Åß„Åó„ÅüÔºÅ`;
                        p.reported = true;

                        // ÂÖ®Âì°ÁµÇ‰∫Ü„Åó„Åü„ÅãÁ¢∫Ë™çÔºà„Åì„ÅÆÊôÇÁÇπ„ÅßÊúÄÂæå„ÅÆ1‰∫∫„ÅãÂà§ÂÆöÔºâ
                        const allFinished = players.every(pl => pl.state === 'finished' && pl.reported);
                        const isLastPlayer = allFinished && players.length > 1;

                        // „ÇØ„É©„ÉÉ„Ç´„ÉºÈü≥
                        playCrackerSound();
                        showCustomModal(msg, true, isLastPlayer);
                        createConfetti();
                    }
                }
            }, 300);
        }

        // ÂÖ®Âì°„ÅÆÁµêÊûú‰∏ÄË¶ß„ÇíË°®Á§∫
        function showFinalResults() {
            let msg = "üéä ÁµêÊûú‰∏ÄË¶ß üéä<br><br>";

            // Ëâ≤‰ªò„Åç„ÅÆ‰∏∏„ÅßË°®Á§∫
            players.forEach((p, i) => {
                let resultName = goalLabels[p.xIdx];
                msg += `<span style="display:inline-block;width:16px;height:16px;border-radius:50%;background:${p.color};margin-right:8px;vertical-align:middle;"></span>`;
                msg += `${numCircle[i]} ‚Üí ${resultName}<br>`;
            });

            // „ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éú„Çø„É≥„ÇíËøΩÂä†
            msg += `<br><button onclick="retryGame()" style="
                background: linear-gradient(135deg, #ff6b6b, #ff4757);
                color: white; border: none; padding: 12px 30px;
                border-radius: 25px; font-size: 1rem; font-weight: bold;
                cursor: pointer; box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4);
                margin-top: 10px;
            ">üîÑ „ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>`;

            // „Éï„Ç°„É≥„Éï„Ç°„Éº„É¨
            playFanfare();
            // BGMÂÅúÊ≠¢
            stopBgm();
            showCustomModal(msg, true, false, true);
            createConfetti();
        }

        // „ÇÇ„ÅÜ‰∏ÄÂ∫¶„Ç≤„Éº„É†„Çí„ÇÑ„ÇäÁõ¥„ÅôÔºàË≥™Âïè„Å™„Åó„Åß„Ç∑„É£„ÉÉ„Éï„É´Ôºâ
        function retryGame() {
            // „Çø„Ç§„Éû„ÉºÂÅúÊ≠¢
            if (resultTimerInterval) {
                clearInterval(resultTimerInterval);
                resultTimerInterval = null;
            }
            isLastPlayerModal = false;
            isFinalResultModal = false;

            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„ÇãÔºàÁîªÈù¢ÈÅ∑Áßª„Å™„ÅóÔºâ
            document.getElementById('resultModalOverlay').style.display = 'none';

            // „Ç≥„Éº„Çπ„Å®ÈÅ∏ÊäûËÇ¢„Çí„Ç∑„É£„ÉÉ„Éï„É´„Åó„Å¶ÂÜç„Çπ„Çø„Éº„Éà
            shuffleLadders();
        }

        let resultTimerInterval = null;
        let isLastPlayerModal = false;
        let isFinalResultModal = false;
        const RESULT_TIMER_DURATION = 5000; // ÈÄöÂ∏∏5Áßí
        const LAST_PLAYER_TIMER_DURATION = 8000; // ÊúÄÂæå„ÅÆ1‰∫∫„ÅØ8Áßí
        const FINAL_RESULT_TIMER_DURATION = 15000; // ÊúÄÁµÇÁµêÊûú„ÅØ15Áßí

        function getTimerColor(remaining) {
            // Èùí(54, 160, 255) ‚Üí ÈªÑ(255, 200, 50) ‚Üí Ëµ§(255, 71, 87) „Å∏„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥
            let r, g, b;
            if (remaining > 0.5) {
                // Èùí‚ÜíÈªÑÔºàÊÆã„Çä100%„Äú50%Ôºâ
                const t = (remaining - 0.5) / 0.5; // 1‚Üí0
                r = Math.round(255 - (255 - 54) * t);
                g = Math.round(200 - (200 - 160) * t);
                b = Math.round(50 + (255 - 50) * t);
            } else {
                // ÈªÑ‚ÜíËµ§ÔºàÊÆã„Çä50%„Äú0%Ôºâ
                const t = remaining / 0.5; // 1‚Üí0
                r = 255;
                g = Math.round(71 + (200 - 71) * t);
                b = Math.round(87 - (87 - 50) * t);
            }
            return `rgb(${r}, ${g}, ${b})`;
        }

        function showCustomModal(text, autoClose = true, isLastPlayer = false, isFinalResult = false) {
            const overlay = document.getElementById('resultModalOverlay');
            const textBox = document.getElementById('modalResultText');
            const progressBar = document.getElementById('resultTimerProgress');

            textBox.innerHTML = text;
            overlay.style.display = 'flex';
            isLastPlayerModal = isLastPlayer;
            isFinalResultModal = isFinalResult;

            // „Çø„Ç§„Éû„Éº„É™„Çª„ÉÉ„Éà
            if (resultTimerInterval) {
                clearInterval(resultTimerInterval);
                resultTimerInterval = null;
            }

            if (autoClose && progressBar) {
                progressBar.style.transform = 'scaleX(1)';
                progressBar.style.background = getTimerColor(1); // Èùí„Åã„Çâ„Çπ„Çø„Éº„Éà

                // ÊôÇÈñì„ÇíÊ±∫ÂÆö
                let duration = RESULT_TIMER_DURATION;
                if (isFinalResult) {
                    duration = FINAL_RESULT_TIMER_DURATION;
                } else if (isLastPlayer) {
                    duration = LAST_PLAYER_TIMER_DURATION;
                }

                const startTime = Date.now();
                resultTimerInterval = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    const remaining = 1 - (elapsed / duration);

                    if (remaining <= 0) {
                        clearInterval(resultTimerInterval);
                        resultTimerInterval = null;
                        closeModal();
                    } else {
                        progressBar.style.transform = `scaleX(${remaining})`;
                        progressBar.style.background = getTimerColor(remaining);
                    }
                }, 50);
            } else if (progressBar) {
                progressBar.style.transform = 'scaleX(0)';
            }
        }

        function closeModal() {
            // „Çø„Ç§„Éû„ÉºÂÅúÊ≠¢
            if (resultTimerInterval) {
                clearInterval(resultTimerInterval);
                resultTimerInterval = null;
            }

            const wasLastPlayer = isLastPlayerModal;
            const wasFinalResult = isFinalResultModal;
            isLastPlayerModal = false;
            isFinalResultModal = false;

            document.getElementById('resultModalOverlay').style.display = 'none';

            // ÊúÄÁµÇÁµêÊûú„Å†„Å£„ÅüÂ†¥Âêà„ÄÅ‰∏Ä„Å§Ââç„ÅÆÁîªÈù¢Ôºà„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÔºâ„Å´Êàª„Çã
            if (wasFinalResult) {
                goBack();
                return;
            }

            // ÊúÄÂæå„ÅÆ1‰∫∫„Å†„Å£„ÅüÂ†¥Âêà„ÄÅÁµêÊûú‰∏ÄË¶ß„ÇíË°®Á§∫
            if (wasLastPlayer) {
                setTimeout(() => {
                    showFinalResults();
                }, 300);
                return;
            }

            let nextP = players.find(p => p.state === 'finished' && !p.reported);

            if(nextP && currentMode === 'normal') {
                showResult();
            } else {
                let allDone = players.every(p => p.state === 'finished' || p.state === 'idle');
                if(allDone) {
                    isAnimating = false;
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // „Ç∑„Çß„Ç¢Ê©üËÉΩ
        function shareResult() {
            let shareText = 'üéØ Á•û„ÅÇ„Åø„Å†„ÅÆÁµêÊûú üéØ\n\n';

            if (currentMode === 'race') {
                shareText += 'üèÅ „É¨„Éº„ÇπÁµêÊûú üèÅ\n';
                players.forEach(p => {
                    let resultName = goalLabels[p.xIdx];
                    // „Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç„Åå„ÅÇ„Çå„Å∞Ë°®Á§∫
                    const charDisplay = p.charInfo ? `${p.char}${p.charInfo.name}` : p.char;
                    shareText += `${charDisplay} ‚Üí ${resultName}\n`;
                });
            } else {
                players.filter(p => p.state === 'finished').forEach((p, i) => {
                    let resultName = goalLabels[p.xIdx];
                    shareText += `${numCircle[i]} ‚Üí ${resultName}\n`;
                });
            }

            shareText += '\n#Á•û„ÅÇ„Åø„Å†';

            // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(shareText).then(() => {
                    showToast('üìã „Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
                }).catch(() => {
                    fallbackCopyText(shareText);
                });
            } else {
                fallbackCopyText(shareText);
            }
        }

        function fallbackCopyText(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showToast('üìã „Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
            } catch (e) {
                showToast('‚ö†Ô∏è „Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
            document.body.removeChild(textarea);
        }

        function showToast(message) {
            // Êó¢Â≠ò„ÅÆ„Éà„Éº„Çπ„Éà„ÇíÂâäÈô§
            document.querySelectorAll('.toast').forEach(t => t.remove());

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 2000);
        }

        function createConfetti() {
            if (typeof confetti === 'function') {
                confetti({
                    particleCount: 150,
                    spread: 160,
                    origin: { y: 0.6 },
                    zIndex: 3000 // „É¢„Éº„ÉÄ„É´(2000)„Çà„ÇäÊâãÂâç„Å´
                });
            }
        }
    </script>
</body>
</html>
